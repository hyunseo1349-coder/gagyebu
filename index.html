function parseText() {
  const text = document.getElementById('rawInput').value.trim();
  if (!text) return;

  const lines = text.split('\n').map(l => l.trim()).filter(l => l !== "");
  let parsedCount = 0;
  const todayStr = "2026-01-25"; // 현재 날짜 기준

  for (let i = 0; i < lines.length; i++) {
    // 1. "원"으로 끝나는 금액 라인을 찾습니다.
    if (lines[i].endsWith('원') && /^[0-9,]+원$/.test(lines[i])) {
      const amount = parseInt(lines[i].replace(/[^0-9]/g, ''));
      let status = lines[i - 1]; // 일시불 or 거래취소
      let store = "";
      let dateValue = todayStr;

      // 2. 금액 라인 위로 올라가면서 가맹점명과 날짜를 추적합니다.
      // 현대카드 패턴: [가맹점] -> [카드명] -> [날짜] -> [시간] -> [결제상태] -> [금액]
      // 역순으로 탐색하여 불필요한 키워드(분할결제, 오늘 등)를 제외한 첫 번째 의미 있는 단어를 가맹점으로 잡습니다.
      
      let searchIdx = i - 1;
      let foundDate = false;

      while (searchIdx >= 0 && searchIdx > i - 10) {
        const line = lines[searchIdx];
        
        // 날짜 파싱 (26. 1. 24 형식 또는 '오늘')
        if (!foundDate) {
          if (line === "오늘") {
            dateValue = todayStr;
            foundDate = true;
          } else if (/\d{2}\.\s*\d{1,2}\.\s*\d{1,2}/.test(line)) {
            const d = line.match(/(\d{2})\.\s*(\d{1,2})\.\s*(\d{1,2})/);
            dateValue = `20${d[1]}-${String(d[2]).padStart(2, '0')}-${String(d[3]).padStart(2, '0')}`;
            foundDate = true;
          }
        }

        // 가맹점명 결정 (날짜보다 위쪽에 있고, 카드 이름이 아닌 것)
        // 카드사 관련 키워드가 포함된 줄은 건너뜁니다.
        if (foundDate && 
            !line.includes('카드') && 
            !line.includes('American Express') && 
            !line.includes('일시불') && 
            !line.includes('거래취소') && 
            !line.includes('오늘') &&
            !line.includes(':') && // 시간 제외
            !/\d{2}\.\s*\d{1,2}\.\s*\d{1,2}/.test(line) && // 날짜줄 제외
            !line.includes('신청하기')) {
          store = line;
          break; // 가맹점을 찾았으면 중단
        }
        searchIdx--;
      }

      if (store && amount) {
        // 중복 방지 로직 및 거래 취소 처리
        if (status === "거래취소") {
            // 취소 건은 별도 처리하거나 위에서 매칭된 승인건을 삭제하는 로직 추가 가능
            // 여기서는 일단 리스트에 표시하기 위해 추가
        }

        state.data.transactions.push({
          id: Date.now() + Math.random(),
          fullDate: dateValue,
          store: store,
          amount: amount,
          status: status,
          category: autoCategorize(store), // 아까 만든 자동 분류 함수
          split: { me: amount, mom: 0, dad: 0, bro: 0, friend: 0 }
        });
        parsedCount++;
      }
    }
  }

  // 거래 취소 건(가승인 취소 등) 자동 제거 로직
  processCancellations(); 

  saveData();
  render();
  document.getElementById('rawInput').value = "";
  alert(`${parsedCount}개의 내역을 정확하게 불러왔습니다.`);
}

function processCancellations() {
    const list = state.data.transactions;
    const cancellations = list.filter(t => t.status === "거래취소");
    const approvals = list.filter(t => t.status !== "거래취소");
    
    let toDeleteIds = new Set();
    
    cancellations.forEach(can => {
        // 금액이 같고 가맹점명이 유사한 승인 건을 찾아 매칭
        const match = approvals.find(app => 
            !toDeleteIds.has(app.id) && 
            app.amount === can.amount && 
            (app.store.includes(can.store.replace('가승인', '')) || can.store.includes(app.store))
        );
        if (match) {
            toDeleteIds.add(match.id);
            // 취소건 자신도 리스트에서 제외하기 위해
            const canIdx = list.findIndex(x => x.id === can.id);
            if (canIdx > -1) list.splice(canIdx, 1);
        }
    });

    state.data.transactions = list.filter(t => !toDeleteIds.has(t.id) && t.status !== "거래취소");
}
