<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Ledger 2026 Pro - ì°¨íŠ¸ ë° ì •ì‚° ì—ë””ì…˜</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --primary: #6366F1; --bg: #F9FAFB; --danger: #EF4444; --success: #10B981; --accent: #F59E0B; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); color: #1F2937; line-height: 1.5; }
    
    .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: white; border-bottom: 1px solid #E5E7EB; position: sticky; top: 0; z-index: 100; }
    .view-toggle { display: flex; background: #F3F4F6; padding: 4px; border-radius: 12px; }
    .view-toggle button { padding: 8px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; background: transparent; transition: 0.2s; font-size: 13px; }
    .view-toggle button.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    .main { max-width: 1000px; margin: 0 auto; padding: 20px; }

    /* ê¸°ê°„ ì„ íƒê¸° */
    .period-nav { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 24px; background: white; padding: 16px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    .nav-btn { width: 36px; height: 36px; border: 1px solid #E5E7EB; background: white; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .current-period { font-weight: 800; font-size: 18px; color: var(--primary); min-width: 120px; text-align: center; }

    /* ëŒ€ì‹œë³´ë“œ ë ˆì´ì•„ì›ƒ */
    .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
    .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: white; padding: 20px; border-radius: 24px; border: 1px solid #E5E7EB; }
    .card-label { font-size: 12px; color: #6B7280; display: block; margin-bottom: 6px; }
    .card-value { font-size: 18px; font-weight: 800; color: #111827; }
    
    .chart-card { background: white; padding: 24px; border-radius: 24px; border: 1px solid #E5E7EB; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    #categoryChart { max-width: 200px !important; max-height: 200px !important; }

    /* ì…ë ¥ ì„¹ì…˜ */
    .quick-input-area { background: white; border-radius: 24px; padding: 24px; border: 1px solid #E5E7EB; margin-bottom: 30px; }
    textarea { width: 100%; height: 80px; padding: 15px; border-radius: 12px; border: 1px solid #E5E7EB; background: #F9FAFB; resize: none; font-family: inherit; margin-bottom: 12px; }
    .btn { padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; font-size: 14px; }
    .btn-primary { background: var(--primary); color: white; width: 100%; }

    /* ë¦¬ìŠ¤íŠ¸ */
    .transaction-item { background: white; padding: 16px; border-radius: 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #F3F4F6; cursor: pointer; transition: 0.2s; }
    .transaction-item:hover { transform: translateX(5px); border-color: var(--primary); }
    .tag { font-size: 10px; padding: 2px 8px; border-radius: 6px; font-weight: 700; margin-right: 6px; }
    .tag-food { background: #FFEDD5; color: #EA580C; }
    .tag-transport { background: #DBEAFE; color: #2563EB; }
    .tag-medical { background: #FEE2E2; color: #DC2626; }
    .tag-etc { background: #F3F4F6; color: #4B5563; }

    /* ëª¨ë‹¬ */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
    .modal-overlay.active { display: flex; }
    .modal { background: white; border-radius: 24px; width: 95%; max-width: 450px; padding: 28px; max-height: 90vh; overflow-y: auto; }
    
    .split-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 8px; border-radius: 10px; background: #F9FAFB; }
    .split-input { width: 100px; padding: 6px; border: 1px solid #DDD; border-radius: 6px; text-align: right; }
    
    select.cat-select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #E5E7EB; margin-bottom: 20px; font-weight: 600; }

    @media (max-width: 800px) {
      .dashboard-grid { grid-template-columns: 1fr; }
      .summary-grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

  <header class="header">
    <div style="font-weight: 900; color: var(--primary); font-size: 20px;">Smart Ledger Pro</div>
    <div class="view-toggle">
      <button id="btn-monthly" class="active" onclick="setView('monthly')">ì›”ê°„</button>
      <button id="btn-yearly" onclick="setView('yearly')">ì—°ê°„</button>
    </div>
  </header>

  <main class="main">
    <div class="period-nav">
      <button class="nav-btn" id="prevBtn" onclick="changePeriod(-1)">â—€</button>
      <span class="current-period" id="periodDisplay">2026ë…„ 1ì›”</span>
      <button class="nav-btn" id="nextBtn" onclick="changePeriod(1)">â–¶</button>
    </div>

    <div class="dashboard-grid">
      <div class="summary-grid">
        <div class="card"><span class="card-label">ì´ ì§€ì¶œ</span><span class="card-value" id="stat-total">0ì›</span></div>
        <div class="card" style="border-left: 4px solid var(--success);"><span class="card-label">ğŸ›’ ë‚´ ì‹¤ì œ ì§€ì¶œ (ìƒí…Œí¬ ì œì™¸)</span><span class="card-value" id="stat-my">0ì›</span></div>
        <div class="card" style="border-left: 4px solid var(--primary);"><span class="card-label">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ê°€ì¡±/íƒ€ì¸ ì§€ë¶„</span><span class="card-value" id="stat-family">0ì›</span></div>
        <div class="card" style="border-left: 4px solid var(--accent);"><span class="card-label">ğŸ« ìƒí’ˆê¶Œ (ìƒí…Œí¬)</span><span class="card-value" id="stat-gc">0ì›</span></div>
      </div>
      <div class="chart-card">
        <span class="card-label" style="margin-bottom:15px;">ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ ë¹„ìœ¨</span>
        <canvas id="categoryChart"></canvas>
      </div>
    </div>

    <div class="quick-input-area">
      <textarea id="rawInput" placeholder="ì¹´ë“œ ìƒì„¸ ë‚´ì—­ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
      <button class="btn btn-primary" onclick="parseAndPreview()">âœ¨ ìë™ íŒŒì‹± ë° ì •í™” ì¶”ê°€</button>
    </div>

    <div id="listArea"></div>
  </main>

  <div class="modal-overlay" id="splitModal">
    <div class="modal">
      <h3 id="splitTitle">í•­ëª© ìƒì„¸ ì„¤ì •</h3>
      <p id="splitTotalDisplay" style="font-size: 14px; color: #6B7280; margin-bottom: 20px;"></p>
      
      <label class="card-label">ì¹´í…Œê³ ë¦¬ ë³€ê²½</label>
      <select id="editCategory" class="cat-select">
        <option value="food">ì‹ë¹„</option>
        <option value="transport">êµí†µ</option>
        <option value="shopping">ì‡¼í•‘</option>
        <option value="living">ìƒí™œ</option>
        <option value="medical">ì˜ë£Œ</option>
        <option value="etc">ê¸°íƒ€</option>
        <option value="giftcard">ìƒí’ˆê¶Œ</option>
      </select>

      <label class="card-label">ì¸ì›ë³„ ì •ì‚° (1/N)</label>
      <div id="splitList"></div>
      <div id="splitValidate" style="text-align:right; font-size:12px; margin-top:10px; font-weight:700;"></div>

      <div style="display:flex; gap:10px; margin-top:24px">
        <button class="btn" style="background:#F3F4F6; flex:1" onclick="closeModal('splitModal')">ë‹«ê¸°</button>
        <button class="btn btn-primary" id="saveSplitBtn" style="flex:2" onclick="saveSettlement()">ì €ì¥í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <script>
    const START_YEAR = 2026;
    const DATA_KEY = `sl_data_pro_v3`;
    const CAT_MAP = { food: 'ì‹ë¹„', transport: 'êµí†µ', shopping: 'ì‡¼í•‘', living: 'ìƒí™œ', medical: 'ì˜ë£Œ', etc: 'ê¸°íƒ€', giftcard: 'ìƒí’ˆê¶Œ' };
    const CAT_COLORS = ['#6366F1', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#6B7280', '#EC4899'];

    let state = {
      view: 'monthly', year: 2026, month: 1,
      data: JSON.parse(localStorage.getItem(DATA_KEY)) || { transactions: [] },
      currentId: null,
      chart: null
    };

    function saveData() { localStorage.setItem(DATA_KEY, JSON.stringify(state.data)); }

    function setView(v) {
      state.view = v;
      document.getElementById('btn-monthly').classList.toggle('active', v === 'monthly');
      document.getElementById('btn-yearly').classList.toggle('active', v === 'yearly');
      render();
    }

    function changePeriod(dir) {
      if (state.view === 'monthly') {
        state.month += dir;
        if (state.month > 12) { state.month = 1; state.year++; }
        if (state.month < 1) { state.month = 12; state.year--; }
      } else { state.year += dir; }
      if (state.year < START_YEAR) { state.year = START_YEAR; state.month = 1; }
      render();
    }

    // íŒŒì‹± ì‹œ ì¹´í…Œê³ ë¦¬ ìë™ ë¶„ë¥˜ ë¡œì§
    function autoCategorize(store) {
      if (/ìƒí’ˆê¶Œ|í˜ì´íƒ€ë©|ì¿ í°|ê¸°í”„í‹°ì½˜/.test(store)) return 'giftcard';
      if (/ì‹ë‹¹|ì†Œí˜¸ì •|ì¹´í˜|ìŠ¤íƒ€ë²…ìŠ¤|ì™„ëš|ë°°ë¯¼|ìš°ì•„í•œ|KFC|í‘¸ê°€|ìŠ¤ì‹œë‹¤ì´ëª¬|êµ­ìˆ˜|ë‚™ì§€|ì•„ì›ƒë°±|ê°ìíƒ•|ë§¥ë„ë‚ ë“œ/.test(store)) return 'food';
      if (/ìš°ë²„|íƒì‹œ|ì§€í•˜ì² |ë²„ìŠ¤|ì½”ë ˆì¼/.test(store)) return 'transport';
      if (/ë³‘ì›|ì•½êµ­|ì˜ì›|ì˜ë£Œ|ë‚´ê³¼/.test(store)) return 'medical';
      if (/ë°±í™”ì |ì‡¼í•‘|í¬ë¦¼|ë„¤ì´ë²„í˜ì´|ì¿ íŒ¡|ë§ˆíŠ¸|ì‹í’ˆê´€/.test(store)) return 'shopping';
      if (/ê´€ë¦¬ë¹„|í†µì‹ |ìœ í”ŒëŸ¬ìŠ¤|ì „ê¸°|ìˆ˜ë„/.test(store)) return 'living';
      return 'etc';
    }

    function openSettlement(id) {
      const t = state.data.transactions.find(x => x.id === id);
      state.currentId = id;
      document.getElementById('splitTotalDisplay').textContent = `${t.store} - ${t.amount.toLocaleString()}ì›`;
      document.getElementById('editCategory').value = t.category;

      const members = { me: 'ë‚˜', mom: 'ì—„ë§ˆ', dad: 'ì•„ë¹ ', bro: 'ë™ìƒ', friend: 'ì¹œêµ¬' };
      if (!t.split) t.split = { me: t.amount, mom:0, dad:0, bro:0, friend:0 };

      document.getElementById('splitList').innerHTML = Object.entries(members).map(([key, name]) => `
        <div class="split-row">
          <span>${name}</span>
          <input type="number" class="split-input" id="split-${key}" value="${t.split[key] || 0}" oninput="validateSplit(${t.amount})">
        </div>
      `).join('');
      validateSplit(t.amount);
      document.getElementById('splitModal').classList.add('active');
    }

    function validateSplit(total) {
      const inputs = document.querySelectorAll('.split-input');
      let sum = 0;
      inputs.forEach(i => sum += parseInt(i.value) || 0);
      const diff = total - sum;
      const v = document.getElementById('splitValidate');
      v.textContent = diff === 0 ? "âœ“ ê¸ˆì•¡ ì¼ì¹˜" : `ì”ì•¡: ${diff.toLocaleString()}ì›`;
      v.style.color = diff === 0 ? "var(--success)" : "var(--danger)";
      document.getElementById('saveSplitBtn').disabled = diff !== 0;
    }

    function saveSettlement() {
      const t = state.data.transactions.find(x => x.id === state.currentId);
      t.category = document.getElementById('editCategory').value;
      t.split = {
        me: parseInt(document.getElementById('split-me').value) || 0,
        mom: parseInt(document.getElementById('split-mom').value) || 0,
        dad: parseInt(document.getElementById('split-dad').value) || 0,
        bro: parseInt(document.getElementById('split-bro').value) || 0,
        friend: parseInt(document.getElementById('split-friend').value) || 0
      };
      saveData();
      closeModal('splitModal');
      render();
    }

    function render() {
      document.getElementById('periodDisplay').textContent = state.view === 'monthly' ? `${state.year}ë…„ ${state.month}ì›”` : `${state.year}ë…„`;
      
      let filtered = state.data.transactions.filter(t => {
        const d = new Date(t.fullDate);
        return d.getFullYear() === state.year && (state.view === 'yearly' || (d.getMonth()+1) === state.month);
      });

      let stats = { total: 0, my: 0, family: 0, gc: 0 };
      let catSums = { food: 0, transport: 0, shopping: 0, living: 0, medical: 0, etc: 0 };

      filtered.forEach(t => {
        stats.total += t.amount;
        if (t.category === 'giftcard') stats.gc += t.amount;
        else {
          const myPart = t.split ? t.split.me : t.amount;
          stats.my += myPart;
          stats.family += (t.amount - myPart);
          catSums[t.category] = (catSums[t.category] || 0) + t.amount;
        }
      });

      document.getElementById('stat-total').textContent = stats.total.toLocaleString() + 'ì›';
      document.getElementById('stat-my').textContent = stats.my.toLocaleString() + 'ì›';
      document.getElementById('stat-family').textContent = stats.family.toLocaleString() + 'ì›';
      document.getElementById('stat-gc').textContent = stats.gc.toLocaleString() + 'ì›';

      updateChart(catSums);

      const listArea = document.getElementById('listArea');
      listArea.innerHTML = filtered.sort((a,b) => new Date(b.fullDate)-new Date(a.fullDate)).map(t => `
        <div class="transaction-item" onclick="openSettlement(${t.id})">
          <div>
            <span class="tag tag-${t.category}">${CAT_MAP[t.category]}</span>
            <span style="font-weight:700;">${t.store}</span>
            <div style="font-size:11px; color:#9CA3AF; margin-top:4px;">${t.fullDate}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:800;">${t.amount.toLocaleString()}ì›</div>
            ${t.split && (t.amount !== t.split.me) ? `<div style="font-size:10px; color:var(--primary)">ë‚´ ëª«: ${t.split.me.toLocaleString()}</div>` : ''}
          </div>
        </div>
      `).join('') || '<div style="text-align:center; padding:40px; color:#9CA3AF;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    function updateChart(sums) {
      const ctx = document.getElementById('categoryChart').getContext('2d');
      const data = Object.values(sums);
      const labels = Object.keys(sums).map(k => CAT_MAP[k]);

      if (state.chart) state.chart.destroy();
      
      state.chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: CAT_COLORS,
            borderWidth: 0,
            hoverOffset: 10
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          cutout: '70%'
        }
      });
    }

    function parseAndPreview() {
      const text = document.getElementById('rawInput').value.trim();
      if (!text) return;
      const lines = text.split('\n').map(l => l.trim()).filter(l => l !== "");
      let rawItems = [];
      const todayStr = "2026-01-25";

      for (let i = 0; i < lines.length; i++) {
        if (lines[i].endsWith('ì›') && !lines[i].includes('ì‹ ì²­í•˜ê¸°')) {
          let amount = parseInt(lines[i].replace(/ì›|,/g, ''));
          let status = lines[i-1], dateLine = lines[i-3], store = lines[i-5] || "ê°€ë§¹ì ";
          let finalDate = todayStr;
          if (dateLine && dateLine !== 'ì˜¤ëŠ˜') {
             const dMatch = dateLine.match(/(\d{2})\.\s*(\d{1,2})\.\s*(\d{1,2})/);
             if (dMatch) finalDate = `20${dMatch[1]}-${String(dMatch[2]).padStart(2, '0')}-${String(dMatch[3]).padStart(2, '0')}`;
          }
          rawItems.push({ id: Date.now() + Math.random(), fullDate: finalDate, store, amount, status });
        }
      }
      
      const cancellations = rawItems.filter(x => x.status === 'ê±°ë˜ì·¨ì†Œ');
      const approvals = rawItems.filter(x => x.status !== 'ê±°ë˜ì·¨ì†Œ');
      let skipIds = new Set();
      cancellations.forEach(can => {
        const m = approvals.find(app => !skipIds.has(app.id) && app.amount === can.amount && app.store.substring(0,3) === can.store.substring(0,3));
        if (m) skipIds.add(m.id);
      });

      approvals.forEach(app => {
        if (!skipIds.has(app.id)) {
          state.data.transactions.push({
            ...app,
            category: autoCategorize(app.store),
            split: { me: app.amount, mom: 0, dad: 0, bro: 0, friend: 0 }
          });
        }
      });
      saveData();
      document.getElementById('rawInput').value = '';
      render();
    }

    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    render();
  </script>
</body>
</html>
