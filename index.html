<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Ledger 2026 Pro - ì°¨íŠ¸ ë° ì •ì‚° ì—ë””ì…˜</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --primary: #6366F1; --bg: #F9FAFB; --danger: #EF4444; --success: #10B981; --accent: #F59E0B; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); color: #1F2937; line-height: 1.5; }
    
    .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: white; border-bottom: 1px solid #E5E7EB; position: sticky; top: 0; z-index: 100; }
    .view-toggle { display: flex; background: #F3F4F6; padding: 4px; border-radius: 12px; }
    .view-toggle button { padding: 8px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; background: transparent; transition: 0.2s; font-size: 13px; }
    .view-toggle button.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    .main { max-width: 1000px; margin: 0 auto; padding: 20px; }

    /* ê¸°ê°„ ì„ íƒê¸° */
    .period-nav { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 24px; background: white; padding: 16px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    .nav-btn { width: 36px; height: 36px; border: 1px solid #E5E7EB; background: white; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .current-period { font-weight: 800; font-size: 18px; color: var(--primary); min-width: 120px; text-align: center; }

    /* ëŒ€ì‹œë³´ë“œ ë ˆì´ì•„ì›ƒ */
    .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
    .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: white; padding: 20px; border-radius: 24px; border: 1px solid #E5E7EB; }
    .card-label { font-size: 12px; color: #6B7280; display: block; margin-bottom: 6px; }
    .card-value { font-size: 18px; font-weight: 800; color: #111827; }
    
    .chart-card { background: white; padding: 24px; border-radius: 24px; border: 1px solid #E5E7EB; display: flex; flex-direction: column; align-items: center; }
    .chart-container { position: relative; width: 100%; display: flex; flex-direction: column; align-items: center; }
    #categoryChart { max-width: 180px !important; max-height: 180px !important; cursor: pointer; }
    .chart-legend { width: 100%; margin-top: 15px; font-size: 12px; }
    .legend-item { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #F3F4F6; cursor: pointer; }
    .legend-item:hover { background: #F9FAFB; }

    /* ì…ë ¥ ì„¹ì…˜ */
    .quick-input-area { background: white; border-radius: 24px; padding: 24px; border: 1px solid #E5E7EB; margin-bottom: 30px; }
    textarea { width: 100%; height: 80px; padding: 15px; border-radius: 12px; border: 1px solid #E5E7EB; background: #F9FAFB; resize: none; font-family: inherit; margin-bottom: 12px; }
    .input-btns { display: flex; gap: 10px; }
    .btn { padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; font-size: 14px; }
    .btn-primary { background: var(--primary); color: white; flex: 2; }
    .btn-outline { background: white; border: 1px solid var(--primary); color: var(--primary); flex: 1; }

    /* ë¦¬ìŠ¤íŠ¸ */
    .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .filter-info { font-size: 13px; color: var(--primary); font-weight: 600; }
    .transaction-item { background: white; padding: 16px; border-radius: 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #F3F4F6; cursor: pointer; transition: 0.2s; }
    .transaction-item:hover { transform: translateX(5px); border-color: var(--primary); }
    .tag { font-size: 10px; padding: 2px 8px; border-radius: 6px; font-weight: 700; margin-right: 6px; }
    .tag-food { background: #FFEDD5; color: #EA580C; }
    .tag-transport { background: #DBEAFE; color: #2563EB; }
    .tag-medical { background: #FEE2E2; color: #DC2626; }
    .tag-shopping { background: #FEF9C3; color: #854D0E; }
    .tag-living { background: #E0E7FF; color: #4338CA; }
    .tag-etc { background: #F3F4F6; color: #4B5563; }
    .tag-giftcard { background: #FCE7F3; color: #BE185D; }

    /* ëª¨ë‹¬ */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
    .modal-overlay.active { display: flex; }
    .modal { background: white; border-radius: 24px; width: 95%; max-width: 450px; padding: 28px; max-height: 90vh; overflow-y: auto; }
    
    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; font-size: 12px; color: #6B7280; margin-bottom: 5px; }
    .input-group input, .input-group select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #E5E7EB; }
    
    .split-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 8px; border-radius: 10px; background: #F9FAFB; }
    .split-input { width: 100px; padding: 6px; border: 1px solid #DDD; border-radius: 6px; text-align: right; }
    
    @media (max-width: 800px) {
      .dashboard-grid { grid-template-columns: 1fr; }
      .summary-grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

  <header class="header">
    <div style="font-weight: 900; color: var(--primary); font-size: 20px;">Smart Ledger Pro</div>
    <div class="view-toggle">
      <button id="btn-monthly" class="active" onclick="setView('monthly')">ì›”ê°„</button>
      <button id="btn-yearly" onclick="setView('yearly')">ì—°ê°„</button>
    </div>
  </header>

  <main class="main">
    <div class="period-nav">
      <button class="nav-btn" id="prevBtn" onclick="changePeriod(-1)">â—€</button>
      <span class="current-period" id="periodDisplay">2026ë…„ 1ì›”</span>
      <button class="nav-btn" id="nextBtn" onclick="changePeriod(1)">â–¶</button>
    </div>

    <div class="dashboard-grid">
      <div class="summary-grid">
        <div class="card"><span class="card-label">ğŸ’° ì´ì§€ì¶œ</span><span class="card-value" id="stat-total">0ì›</span></div>
        <div class="card" style="border-left: 4px solid var(--success);"><span class="card-label">ğŸ›’ ì‹¤ì œ ì§€ì¶œ</span><span class="card-value" id="stat-my">0ì›</span></div>
        <div class="card" style="border-left: 4px solid var(--primary);"><span class="card-label">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ê°€ì¡± ì‚¬ìš©</span><span class="card-value" id="stat-family">0ì›</span></div>
        <div class="card" style="border-left: 4px solid var(--accent);"><span class="card-label">ğŸ« ìƒí’ˆê¶Œ</span><span class="card-value" id="stat-gc">0ì›</span></div>
      </div>
      <div class="chart-card">
        <span class="card-label" style="margin-bottom:15px;">ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ ë¹„ìœ¨</span>
        <div class="chart-container">
            <canvas id="categoryChart"></canvas>
            <div id="chartLegend" class="chart-legend"></div>
        </div>
      </div>
    </div>

    <div class="quick-input-area">
      <textarea id="rawInput" placeholder="ì¹´ë“œ ìƒì„¸ ë‚´ì—­ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
      <div class="input-btns">
          <button class="btn btn-primary" onclick="parseAndPreview()">âœ¨ ìë™ ì…ë ¥</button>
          <button class="btn btn-outline" onclick="openManualInput()">â• ìˆ˜ë™ ì…ë ¥</button>
      </div>
    </div>

    <div class="list-header">
        <h3 style="font-size: 16px;">ì§€ì¶œ ë‚´ì—­</h3>
        <div id="filterStatus" class="filter-info"></div>
    </div>
    <div id="listArea"></div>
  </main>

  <div class="modal-overlay" id="manualModal">
    <div class="modal">
      <h3>ìˆ˜ë™ ì§€ì¶œ ì…ë ¥</h3>
      <div class="input-group" style="margin-top:20px;">
        <label>ë‚ ì§œ</label>
        <input type="date" id="man-date">
      </div>
      <div class="input-group">
        <label>ì‚¬ìš©ì²˜</label>
        <input type="text" id="man-store" placeholder="ì˜ˆ: ìŠ¤íƒ€ë²…ìŠ¤">
      </div>
      <div class="input-group">
        <label>ê¸ˆì•¡</label>
        <input type="number" id="man-amount" placeholder="0">
      </div>
      <div class="input-group">
        <label>ì¹´í…Œê³ ë¦¬</label>
        <select id="man-category">
            <option value="food">ì‹ë¹„</option>
            <option value="transport">êµí†µ</option>
            <option value="shopping">ì‡¼í•‘</option>
            <option value="living">ìƒí™œ</option>
            <option value="medical">ì˜ë£Œ</option>
            <option value="etc">ê¸°íƒ€</option>
            <option value="giftcard">ìƒí’ˆê¶Œ</option>
        </select>
      </div>
      <div style="display:flex; gap:10px; margin-top:24px">
        <button class="btn" style="background:#F3F4F6; flex:1" onclick="closeModal('manualModal')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" style="flex:2" onclick="saveManualInput()">ì¶”ê°€í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="splitModal">
    <div class="modal">
      <h3 id="splitTitle">í•­ëª© ìƒì„¸ ì„¤ì •</h3>
      <p id="splitTotalDisplay" style="font-size: 14px; color: #6B7280; margin-bottom: 20px;"></p>
      
      <label class="card-label">ì¹´í…Œê³ ë¦¬ ë³€ê²½</label>
      <select id="editCategory" class="cat-select" style="width:100%; padding:10px; border-radius:10px; border:1px solid #E5E7EB; margin-bottom:20px;">
        <option value="food">ì‹ë¹„</option>
        <option value="transport">êµí†µ</option>
        <option value="shopping">ì‡¼í•‘</option>
        <option value="living">ìƒí™œ</option>
        <option value="medical">ì˜ë£Œ</option>
        <option value="etc">ê¸°íƒ€</option>
        <option value="giftcard">ìƒí’ˆê¶Œ</option>
      </select>

      <label class="card-label">ì¸ì›ë³„ ì •ì‚° (1/N)</label>
      <div id="splitList"></div>
      <div id="splitValidate" style="text-align:right; font-size:12px; margin-top:10px; font-weight:700;"></div>

      <div style="display:flex; gap:10px; margin-top:24px">
        <button class="btn" style="background:#F3F4F6; flex:1" onclick="closeModal('splitModal')">ë‹«ê¸°</button>
        <button class="btn btn-danger" style="flex:1" onclick="deleteTransaction()">ì‚­ì œ</button>
        <button class="btn btn-primary" id="saveSplitBtn" style="flex:2" onclick="saveSettlement()">ì €ì¥í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <script>
    const START_YEAR = 2026;
    const DATA_KEY = `sl_data_pro_v3_enhanced`;
    const CAT_MAP = { food: 'ì‹ë¹„', transport: 'êµí†µ', shopping: 'ì‡¼í•‘', living: 'ìƒí™œ', medical: 'ì˜ë£Œ', etc: 'ê¸°íƒ€', giftcard: 'ìƒí’ˆê¶Œ' };
    const CAT_COLORS = { food: '#6366F1', transport: '#10B981', shopping: '#F59E0B', living: '#EF4444', medical: '#8B5CF6', etc: '#6B7280', giftcard: '#EC4899' };

    let state = {
      view: 'monthly', year: 2026, month: 1,
      data: JSON.parse(localStorage.getItem(DATA_KEY)) || { transactions: [] },
      currentId: null,
      chart: null,
      filterCategory: null
    };

    function saveData() { localStorage.setItem(DATA_KEY, JSON.stringify(state.data)); }

    function setView(v) {
      state.view = v;
      document.getElementById('btn-monthly').classList.toggle('active', v === 'monthly');
      document.getElementById('btn-yearly').classList.toggle('active', v === 'yearly');
      render();
    }

    function changePeriod(dir) {
      if (state.view === 'monthly') {
        state.month += dir;
        if (state.month > 12) { state.month = 1; state.year++; }
        if (state.month < 1) { state.month = 12; state.year--; }
      } else { state.year += dir; }
      render();
    }

    function openManualInput() {
        document.getElementById('man-date').value = new Date().toISOString().split('T')[0];
        document.getElementById('manualModal').classList.add('active');
    }

    function saveManualInput() {
        const date = document.getElementById('man-date').value;
        const store = document.getElementById('man-store').value || "ìˆ˜ë™ ì…ë ¥";
        const amount = parseInt(document.getElementById('man-amount').value) || 0;
        const category = document.getElementById('man-category').value;

        if(amount <= 0) return alert("ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.");

        state.data.transactions.push({
            id: Date.now(),
            fullDate: date,
            store: store,
            amount: amount,
            category: category,
            cardName: "ìˆ˜ë™",
            split: { me: amount, mom: 0, dad: 0, bro: 0, friend: 0 }
        });
        
        saveData();
        closeModal('manualModal');
        render();
    }

    function deleteTransaction() {
        if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            state.data.transactions = state.data.transactions.filter(t => t.id !== state.currentId);
            saveData();
            closeModal('splitModal');
            render();
        }
    }

    function render() {
      document.getElementById('periodDisplay').textContent = state.view === 'monthly' ? `${state.year}ë…„ ${state.month}ì›”` : `${state.year}ë…„`;
      
      let periodFiltered = state.data.transactions.filter(t => {
        const d = new Date(t.fullDate);
        return d.getFullYear() === state.year && (state.view === 'yearly' || (d.getMonth()+1) === state.month);
      });

      let stats = { total: 0, myActual: 0, family: 0, gc: 0 };
      let catSums = { food: 0, transport: 0, shopping: 0, living: 0, medical: 0, etc: 0, giftcard: 0 };

      periodFiltered.forEach(t => {
        stats.total += t.amount;
        // ê°€ì¡± ì‚¬ìš©ë¶„ (ì—„ë§ˆ, ì•„ë¹ , ë™ìƒ í•©ê³„)
        const fSum = (t.split?.mom || 0) + (t.split?.dad || 0) + (t.split?.bro || 0);
        stats.family += fSum;
        
        if (t.category === 'giftcard') {
            stats.gc += t.amount;
        }
        
        catSums[t.category] += t.amount;
      });

      // ì‹¤ì œ ì§€ì¶œ ê³µì‹ ë°˜ì˜: (ì „ì²´ ì‚¬ìš©ì•¡ + ì •ì‚°í•´ì„œ ë‚˜ë§Œ ì‚¬ìš©í•œ ê¸ˆì•¡ - ìƒí’ˆê¶Œ ì‚¬ìš© ê¸ˆì•¡)
      // ìœ„ ê³µì‹ì€ ê²°êµ­ (ë‚˜ì˜ ì§€ë¶„ - ìƒí’ˆê¶Œ)ê³¼ ë…¼ë¦¬ì ìœ¼ë¡œ ìœ ì‚¬í•˜ë¯€ë¡œ ìš”ì²­í•˜ì‹  ìˆ˜ì‹ëŒ€ë¡œ êµ¬í˜„:
      const myShareTotal = periodFiltered.reduce((acc, cur) => acc + (cur.split?.me || 0), 0);
      stats.myActual = stats.total + (myShareTotal - stats.total) - stats.gc;

      document.getElementById('stat-total').textContent = stats.total.toLocaleString() + 'ì›';
      document.getElementById('stat-my').textContent = stats.myActual.toLocaleString() + 'ì›';
      document.getElementById('stat-family').textContent = stats.family.toLocaleString() + 'ì›';
      document.getElementById('stat-gc').textContent = stats.gc.toLocaleString() + 'ì›';

      updateChart(catSums);

      // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ì¹´í…Œê³ ë¦¬ í•„í„° ì ìš©)
      let listData = state.filterCategory ? periodFiltered.filter(t => t.category === state.filterCategory) : periodFiltered;
      
      document.getElementById('filterStatus').textContent = state.filterCategory ? `ê³µê¸‰í•„í„°: ${CAT_MAP[state.filterCategory]} (í´ë¦­ ì‹œ í•´ì œ)` : "";
      document.getElementById('filterStatus').onclick = () => { state.filterCategory = null; render(); };

      const listArea = document.getElementById('listArea');
      listArea.innerHTML = listData.sort((a,b) => new Date(b.fullDate)-new Date(a.fullDate)).map(t => `
        <div class="transaction-item" onclick="openSettlement(${t.id})">
          <div style="flex:1">
            <div style="font-size:11px; color:#9CA3AF; margin-bottom:4px;">${t.fullDate} | ${t.cardName || 'ì¹´ë“œ'}</div>
            <span class="tag tag-${t.category}">${CAT_MAP[t.category]}</span>
            <span style="font-weight:700;">${t.store}</span>
          </div>
          <div style="text-align:right">
            <div style="font-weight:800;">${t.amount.toLocaleString()}ì›</div>
            ${t.split && (t.amount !== t.split.me) ? `<div style="font-size:10px; color:var(--primary)">ë‚´ ëª«: ${t.split.me.toLocaleString()}</div>` : ''}
          </div>
        </div>
      `).join('') || '<div style="text-align:center; padding:40px; color:#9CA3AF;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    function updateChart(sums) {
      const ctx = document.getElementById('categoryChart').getContext('2d');
      const filteredSums = Object.entries(sums).filter(([k, v]) => v > 0);
      const data = filteredSums.map(x => x[1]);
      const labels = filteredSums.map(x => CAT_MAP[x[0]]);
      const colors = filteredSums.map(x => CAT_COLORS[x[0]]);
      const total = data.reduce((a, b) => a + b, 0);

      if (state.chart) state.chart.destroy();
      
      state.chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderWidth: 0,
            hoverOffset: 10
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          cutout: '70%',
          onClick: (evt, elements) => {
              if (elements.length > 0) {
                  const idx = elements[0].index;
                  const clickedKey = filteredSums[idx][0];
                  state.filterCategory = clickedKey;
                  render();
              } else {
                  state.filterCategory = null;
                  render();
              }
          }
        }
      });

      // ì»¤ìŠ¤í…€ ë²”ë¡€ ìƒì„±
      const legendArea = document.getElementById('chartLegend');
      legendArea.innerHTML = filteredSums.map(([key, val]) => {
          const percent = ((val / total) * 100).toFixed(1);
          return `
            <div class="legend-item" onclick="state.filterCategory='${key}'; render();">
                <span><span style="color:${CAT_COLORS[key]}">â—</span> ${CAT_MAP[key]}</span>
                <span><b>${val.toLocaleString()}ì›</b> (${percent}%)</span>
            </div>
          `;
      }).join('');
    }

    // --- ê¸°ì¡´ íŒŒì‹± ë° ê¸°íƒ€ í•¨ìˆ˜ë“¤ (ìœ ì§€) ---
    function autoCategorize(store) {
      if (/ìƒí’ˆê¶Œ|í˜ì´íƒ€ë©|ì¿ í°|ê¸°í”„í‹°ì½˜/.test(store)) return 'giftcard';
      if (/ì‹ë‹¹|ì†Œí˜¸ì •|ì¹´í˜|ìŠ¤íƒ€ë²…ìŠ¤|ì™„ëš|ë°°ë¯¼|ìš°ì•„í•œ|KFC|í‘¸ê°€|ìŠ¤ì‹œë‹¤ì´ëª¬|êµ­ìˆ˜|ë‚™ì§€|ì•„ì›ƒë°±|ê°ìíƒ•|ë§¥ë„ë‚ ë“œ/.test(store)) return 'food';
      if (/ìš°ë²„|íƒì‹œ|ì§€í•˜ì² |ë²„ìŠ¤|ì½”ë ˆì¼/.test(store)) return 'transport';
      if (/ë³‘ì›|ì•½êµ­|ì˜ì›|ì˜ë£Œ|ë‚´ê³¼/.test(store)) return 'medical';
      if (/ë°±í™”ì |ì‡¼í•‘|í¬ë¦¼|ë„¤ì´ë²„í˜ì´|ì¿ íŒ¡|ë§ˆíŠ¸|ì‹í’ˆê´€/.test(store)) return 'shopping';
      if (/ê´€ë¦¬ë¹„|í†µì‹ |ìœ í”ŒëŸ¬ìŠ¤|ì „ê¸°|ìˆ˜ë„/.test(store)) return 'living';
      return 'etc';
    }

    function openSettlement(id) {
      const t = state.data.transactions.find(x => x.id === id);
      state.currentId = id;
      document.getElementById('splitTotalDisplay').textContent = `${t.store} - ${t.amount.toLocaleString()}ì›`;
      document.getElementById('editCategory').value = t.category;
      const members = { me: 'ë‚˜', mom: 'ì—„ë§ˆ', dad: 'ì•„ë¹ ', bro: 'ë™ìƒ', friend: 'ì¹œêµ¬' };
      if (!t.split) t.split = { me: t.amount, mom:0, dad:0, bro:0, friend:0 };
      document.getElementById('splitList').innerHTML = Object.entries(members).map(([key, name]) => `
        <div class="split-row">
          <span>${name}</span>
          <input type="number" class="split-input" id="split-${key}" value="${t.split[key] || 0}" oninput="validateSplit(${t.amount})">
        </div>
      `).join('');
      validateSplit(t.amount);
      document.getElementById('splitModal').classList.add('active');
    }

    function validateSplit(total) {
      const inputs = document.querySelectorAll('.split-input');
      let sum = 0;
      inputs.forEach(i => sum += parseInt(i.value) || 0);
      const diff = total - sum;
      const v = document.getElementById('splitValidate');
      v.textContent = diff === 0 ? "âœ“ ê¸ˆì•¡ ì¼ì¹˜" : `ì”ì•¡: ${diff.toLocaleString()}ì›`;
      v.style.color = diff === 0 ? "var(--success)" : "var(--danger)";
      document.getElementById('saveSplitBtn').disabled = diff !== 0;
    }

    function saveSettlement() {
      const t = state.data.transactions.find(x => x.id === state.currentId);
      t.category = document.getElementById('editCategory').value;
      t.split = {
        me: parseInt(document.getElementById('split-me').value) || 0,
        mom: parseInt(document.getElementById('split-mom').value) || 0,
        dad: parseInt(document.getElementById('split-dad').value) || 0,
        bro: parseInt(document.getElementById('split-bro').value) || 0,
        friend: parseInt(document.getElementById('split-friend').value) || 0
      };
      saveData();
      closeModal('splitModal');
      render();
    }

    function parseAndPreview() {
      const text = document.getElementById('rawInput').value.trim();
      if (!text) return;
      const lines = text.split('\n').map(l => l.trim()).filter(l => l !== "");
      let rawItems = [];
      const todayStr = new Date().toISOString().split('T')[0];

      for (let i = 0; i < lines.length; i++) {
        if (lines[i].endsWith('ì›') && !lines[i].includes('ì‹ ì²­í•˜ê¸°')) {
          let amount = parseInt(lines[i].replace(/ì›|,/g, ''));
          let status = lines[i-1], dateLine = lines[i-3], store = lines[i-5] || "ê°€ë§¹ì ";
          let finalDate = todayStr;
          if (dateLine && dateLine !== 'ì˜¤ëŠ˜') {
             const dMatch = dateLine.match(/(\d{2})\.\s*(\d{1,2})\.\s*(\d{1,2})/);
             if (dMatch) finalDate = `20${dMatch[1]}-${String(dMatch[2]).padStart(2, '0')}-${String(dMatch[3]).padStart(2, '0')}`;
          }
          rawItems.push({ id: Date.now() + Math.random(), fullDate: finalDate, store, amount, status, cardName: "ì‚¼ì„±ì¹´ë“œ" });
        }
      }
      
      const cancellations = rawItems.filter(x => x.status === 'ê±°ë˜ì·¨ì†Œ');
      const approvals = rawItems.filter(x => x.status !== 'ê±°ë˜ì·¨ì†Œ');
      let skipIds = new Set();
      cancellations.forEach(can => {
        const m = approvals.find(app => !skipIds.has(app.id) && app.amount === can.amount && app.store.substring(0,3) === can.store.substring(0,3));
        if (m) skipIds.add(m.id);
      });

      approvals.forEach(app => {
        if (!skipIds.has(app.id)) {
          state.data.transactions.push({
            ...app,
            category: autoCategorize(app.store),
            split: { me: app.amount, mom: 0, dad: 0, bro: 0, friend: 0 }
          });
        }
      });
      saveData();
      document.getElementById('rawInput').value = '';
      render();
    }

    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    render();
  </script>
</body>
</html>
