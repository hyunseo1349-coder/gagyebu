<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‚˜ë§Œì˜ ê°€ê³„ë¶€</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <style>
    :root {
      --primary: #6366F1;
      --primary-light: #EEF2FF;
      --success: #10B981;
      --success-light: #D1FAE5;
      --warning: #F59E0B;
      --warning-light: #FEF3C7;
      --danger: #EF4444;
      --danger-light: #FEE2E2;
      --pink: #EC4899;
      --pink-light: #FCE7F3;
      --bg: #F9FAFB;
      --card: #FFFFFF;
      --border: #E5E7EB;
      --text: #1F2937;
      --text-secondary: #6B7280;
      --text-muted: #9CA3AF;
    }

    /* ë‹¤í¬ëª¨ë“œ */
    [data-theme="dark"] {
      --primary: #818CF8;
      --primary-light: #312E81;
      --success: #34D399;
      --success-light: #064E3B;
      --warning: #FBBF24;
      --warning-light: #78350F;
      --danger: #F87171;
      --danger-light: #7F1D1D;
      --pink: #F472B6;
      --pink-light: #831843;
      --bg: #111827;
      --card: #1F2937;
      --border: #374151;
      --text: #F9FAFB;
      --text-secondary: #D1D5DB;
      --text-muted: #9CA3AF;
    }

    [data-theme="dark"] .logo-icon {
      background: linear-gradient(135deg, #818CF8 0%, #A78BFA 100%);
    }

    [data-theme="dark"] .tx-date {
      background: var(--bg);
    }

    [data-theme="dark"] .split-row {
      background: var(--bg);
    }

    [data-theme="dark"] .mile-info-box {
      background: linear-gradient(135deg, #1E3A5F 0%, #1E40AF 100%);
    }

    [data-theme="dark"] .mile-result {
      background: linear-gradient(135deg, #78350F 0%, #92400E 100%);
    }

    [data-theme="dark"] .avg-card {
      background: linear-gradient(135deg, #4C1D95 0%, #5B21B6 100%);
    }

    [data-theme="dark"] .fab {
      background: linear-gradient(135deg, #818CF8 0%, #A78BFA 100%);
    }

    [data-theme="dark"] .nav-btn {
      background: var(--card);
      color: var(--text);
    }

    [data-theme="dark"] .nav-btn:hover:not(:disabled) {
      background: var(--primary);
      color: white;
    }

    [data-theme="dark"] .form-input,
    [data-theme="dark"] .form-select,
    [data-theme="dark"] textarea {
      background: var(--card);
      border-color: var(--border);
      color: var(--text);
    }

    [data-theme="dark"] .split-input {
      background: var(--card);
      border-color: var(--border);
      color: var(--text);
    }

    [data-theme="dark"] .split-input:disabled {
      background: var(--bg);
      color: var(--text-muted);
    }

    [data-theme="dark"] .mile-input {
      background: var(--card);
      color: var(--text);
    }

    [data-theme="dark"] .mile-suffix {
      background: var(--border);
      color: var(--text-secondary);
    }

    [data-theme="dark"] .parse-result {
      background: #064E3B;
      border-color: #059669;
    }

    [data-theme="dark"] .formula-box {
      background: #1E3A5F;
      border-color: #3B82F6;
      color: #93C5FD;
    }

    [data-theme="dark"] .formula-box code {
      background: #1E40AF;
    }

    [data-theme="dark"] .modal {
      background: var(--card);
    }

    [data-theme="dark"] .modal-footer {
      background: var(--bg);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Noto Sans KR', -apple-system, sans-serif; 
      background: var(--bg); 
      color: var(--text); 
      line-height: 1.5;
      min-height: 100vh;
    }
    
    /* í—¤ë” */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--primary) 0%, #8B5CF6 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 800;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .logo-icon:hover {
      transform: scale(1.05);
    }
    .logo-text {
      font-weight: 800;
      font-size: 18px;
      color: var(--text);
    }
    .theme-toggle {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .theme-toggle:hover {
      background: var(--primary-light);
    }
    .header-badge {
      font-size: 12px;
      font-weight: 700;
      background: var(--primary-light);
      color: var(--primary);
      padding: 6px 12px;
      border-radius: 20px;
    }
    
    /* ë©”ì¸ */
    .main {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* ë·° í† ê¸€ & ê¸°ê°„ ì„ íƒ */
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .view-toggle {
      display: flex;
      background: var(--card);
      border-radius: 12px;
      padding: 4px;
      border: 1px solid var(--border);
    }
    .view-btn {
      padding: 10px 20px;
      border: none;
      background: transparent;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }
    .view-btn.active {
      background: var(--primary);
      color: white;
    }
    .period-nav {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--card);
      padding: 8px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .nav-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg);
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .nav-btn:hover:not(:disabled) { background: var(--primary-light); }
    .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .period-text {
      font-size: 16px;
      font-weight: 700;
      min-width: 100px;
      text-align: center;
    }
    
    /* ëŒ€ì‹œë³´ë“œ ì¹´ë“œ */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }
    .stat-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
    }
    .stat-card.blue::before { background: var(--primary); }
    .stat-card.green::before { background: var(--success); }
    .stat-card.yellow::before { background: var(--warning); }
    .stat-card.pink::before { background: var(--pink); }
    .stat-card.clickable { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
    .stat-card.clickable:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .stat-value {
      font-size: 22px;
      font-weight: 800;
    }
    .stat-card.green .stat-value { color: var(--success); }
    .stat-card.yellow .stat-value { color: var(--warning); }
    .stat-card.pink .stat-value { color: var(--pink); }
    .stat-hint {
      font-size: 11px;
      color: var(--warning);
      margin-top: 4px;
    }
    
    /* ì°¨íŠ¸ ì„¹ì…˜ */
    .chart-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }
    .chart-card {
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      border: 1px solid var(--border);
    }
    .chart-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .chart-wrapper {
      position: relative;
      height: 220px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .chart-wrapper canvas {
      max-width: 100%;
    }
    
    /* ì…ë ¥ ì„¹ì…˜ */
    .input-section {
      background: var(--card);
      border-radius: 20px;
      padding: 24px;
      border: 1px solid var(--border);
      margin-bottom: 24px;
    }
    .input-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .input-icon {
      width: 44px;
      height: 44px;
      background: var(--primary-light);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .input-title {
      font-size: 16px;
      font-weight: 700;
    }
    .input-desc {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--bg);
      padding-bottom: 12px;
    }
    .tab {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      background: transparent;
    }
    .tab.active {
      background: var(--primary);
      color: white;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    textarea {
      width: 100%;
      min-height: 120px;
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg);
      font-size: 14px;
      resize: none;
      margin-bottom: 12px;
      font-family: inherit;
    }
    textarea:focus { outline: none; border-color: var(--primary); }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group.full { grid-column: span 2; }
    .form-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); }
    .form-input, .form-select {
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg);
      font-size: 14px;
      font-family: inherit;
    }
    .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary); }
    
    .btn {
      padding: 14px 24px;
      border-radius: 12px;
      border: none;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, #8B5CF6 100%);
      color: white;
      width: 100%;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4); }
    .btn-secondary {
      background: var(--bg);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }
    
    /* íŒŒì‹± ê²°ê³¼ */
    .parse-result {
      background: var(--success-light);
      border: 1px solid #A7F3D0;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .parse-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--success);
      margin-bottom: 12px;
    }
    .parse-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px dashed #A7F3D0;
      font-size: 13px;
    }
    .parse-item:last-child { border-bottom: none; }
    .parse-amount { font-weight: 700; color: var(--success); }
    .parse-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .parse-actions .btn { flex: 1; padding: 10px; }
    
    /* ê±°ë˜ ë‚´ì—­ */
    .tx-section {
      background: var(--card);
      border-radius: 20px;
      padding: 24px;
      border: 1px solid var(--border);
    }
    .tx-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .tx-title {
      font-size: 16px;
      font-weight: 700;
    }
    .tx-subtitle {
      font-size: 12px;
      color: var(--primary);
    }
    .filter-badge {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: var(--primary-light);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: var(--primary);
    }
    .filter-badge.active { display: flex; }
    .filter-clear {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    
    .tx-list { display: flex; flex-direction: column; gap: 8px; }
    .tx-item {
      padding: 16px;
      border-radius: 14px;
      background: var(--bg);
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tx-item:hover { border-color: var(--border); }
    .tx-item.expanded { background: white; border-color: var(--primary); }
    .tx-main {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .tx-date {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      background: white;
      padding: 6px 10px;
      border-radius: 8px;
      min-width: 50px;
      text-align: center;
    }
    .tx-info { flex: 1; min-width: 0; }
    .tx-store {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tx-meta {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .tx-amount {
      font-size: 15px;
      font-weight: 700;
      white-space: nowrap;
    }
    .tx-amount.giftcard { color: var(--warning); }
    
    .tag {
      font-size: 10px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 6px;
    }
    .tag-food { background: #FFEDD5; color: #EA580C; }
    .tag-shopping { background: #E0E7FF; color: #4F46E5; }
    .tag-giftcard { background: var(--warning-light); color: #D97706; }
    .tag-transport { background: #D1FAE5; color: #059669; }
    .tag-leisure { background: var(--pink-light); color: #DB2777; }
    .tag-medical { background: var(--danger-light); color: var(--danger); }
    .tag-utility { background: #DBEAFE; color: #2563EB; }
    .tag-education { background: #EDE9FE; color: #7C3AED; }
    .tag-etc { background: #F3F4F6; color: #4B5563; }
    .tag-split { background: #DBEAFE; color: #2563EB; }
    
    /* ì •ì‚° íŒ¨ë„ */
    .split-panel {
      display: none;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px dashed var(--border);
    }
    .tx-item.expanded .split-panel { display: block; }
    .split-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }
    .split-members { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
    .split-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: white;
      border-radius: 10px;
      border: 1px solid var(--border);
    }
    .split-check { width: 18px; height: 18px; accent-color: var(--primary); }
    .split-name { font-size: 14px; font-weight: 500; min-width: 50px; }
    .split-name.me { color: var(--success); }
    .split-name.family { color: var(--pink); }
    .split-input {
      flex: 1;
      max-width: 100px;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 8px;
      text-align: right;
      font-size: 14px;
    }
    .split-input:disabled { background: var(--bg); color: var(--text-muted); }
    .split-suffix { font-size: 12px; color: var(--text-muted); }
    .split-actions { display: flex; gap: 8px; justify-content: flex-end; }
    .split-btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }
    .split-btn.equal { background: var(--bg); color: var(--text-secondary); }
    .split-btn.save { background: var(--primary); color: white; }
    .split-error {
      margin-top: 8px;
      padding: 8px 12px;
      background: var(--danger-light);
      border-radius: 8px;
      font-size: 12px;
      color: var(--danger);
    }
    .split-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      padding: 12px;
      background: var(--success-light);
      border-radius: 10px;
    }
    .split-summary-label { font-size: 13px; font-weight: 600; color: var(--success); }
    .split-summary-value { font-size: 16px; font-weight: 800; color: var(--success); }

    /* ê±°ë˜ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ */
    .tx-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px dashed var(--border);
    }
    .tx-action-btn {
      flex: 1;
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .tx-action-btn.edit {
      background: var(--primary-light);
      color: var(--primary);
    }
    .tx-action-btn.edit:hover {
      background: var(--primary);
      color: white;
    }
    .tx-action-btn.delete {
      background: var(--danger-light);
      color: var(--danger);
    }
    .tx-action-btn.delete:hover {
      background: var(--danger);
      color: white;
    }

    /* ìˆ˜ì • ëª¨ë‹¬ í¼ */
    .edit-form-group {
      margin-bottom: 16px;
    }
    .edit-form-group label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    .edit-form-group input,
    .edit-form-group select {
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg);
      font-size: 14px;
      font-family: inherit;
    }
    .edit-form-group input:focus,
    .edit-form-group select:focus {
      outline: none;
      border-color: var(--primary);
    }
    .edit-form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .no-data {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }
    
    /* ëª¨ë‹¬ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal {
      background: white;
      border-radius: 24px;
      width: 100%;
      max-width: 480px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transform: translateY(20px);
      transition: transform 0.3s;
    }
    .modal-overlay.active .modal { transform: translateY(0); }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }
    .modal-title { font-size: 18px; font-weight: 700; }
    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      background: var(--bg);
      font-size: 18px;
      cursor: pointer;
    }
    .modal-body { padding: 24px; overflow-y: auto; flex: 1; }
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      background: var(--bg);
    }
    
    .mile-section { margin-bottom: 20px; }
    .mile-title { font-size: 14px; font-weight: 700; margin-bottom: 12px; }
    .mile-info-box {
      background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);
      border-radius: 12px;
      padding: 16px;
    }
    .mile-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .mile-row:last-child { margin-bottom: 0; }
    .mile-label { font-size: 13px; color: #1E40AF; }
    .mile-value { font-size: 14px; font-weight: 700; color: #1E40AF; }
    .mile-input-row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    .mile-input-group { flex: 1; }
    .mile-input-group label {
      display: block;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    .mile-input-wrapper {
      display: flex;
      align-items: center;
      background: var(--bg);
      border-radius: 10px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .mile-input {
      flex: 1;
      padding: 10px 12px;
      border: none;
      background: transparent;
      text-align: right;
      font-size: 14px;
      font-weight: 600;
    }
    .mile-input:focus { outline: none; }
    .mile-suffix {
      padding: 10px 12px;
      background: #F3F4F6;
      font-size: 12px;
      color: var(--text-secondary);
    }
    .mile-result {
      background: linear-gradient(135deg, var(--warning-light) 0%, #FDE68A 100%);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }
    .mile-result .mile-row { color: #92400E; }
    .mile-result .mile-label { color: #92400E; }
    .mile-result .mile-value { color: #92400E; }
    .mile-result .mile-value.highlight {
      font-size: 20px;
      font-weight: 800;
      color: #D97706;
    }
    .mile-result .mile-row.total {
      padding-top: 12px;
      margin-top: 8px;
      border-top: 1px dashed #F59E0B;
    }
    .formula-box {
      background: #F0F9FF;
      border: 1px solid #BAE6FD;
      border-radius: 10px;
      padding: 12px;
      font-size: 12px;
      color: #0369A1;
      margin: 12px 0;
    }
    .formula-box code {
      background: #E0F2FE;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
    }
    
    /* ì—°ê°„ ë·° */
    .yearly-view { display: none; }
    .yearly-view.active { display: block; }
    .monthly-view.hidden { display: none; }
    
    .monthly-bars { display: flex; flex-direction: column; gap: 10px; margin-top: 16px; }
    .month-bar-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .month-bar-item:hover { background: var(--bg); }
    .month-bar-label { min-width: 40px; font-size: 14px; font-weight: 600; }
    .month-bar-track {
      flex: 1;
      height: 20px;
      background: var(--bg);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }
    .month-bar-fill {
      height: 100%;
      border-radius: 6px;
      transition: width 0.5s;
    }
    .month-bar-fill.living { background: linear-gradient(90deg, var(--primary) 0%, #8B5CF6 100%); }
    .month-bar-value { min-width: 70px; text-align: right; font-size: 14px; font-weight: 700; }
    
    .avg-card {
      background: linear-gradient(135deg, #EDE9FE 0%, #DDD6FE 100%);
      border-radius: 16px;
      padding: 20px;
      margin-top: 20px;
    }
    .avg-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .avg-row:last-child { margin-bottom: 0; }
    .avg-label { font-size: 13px; color: #5B21B6; }
    .avg-value { font-size: 14px; font-weight: 700; color: #5B21B6; }
    .avg-value.highlight { font-size: 18px; font-weight: 800; color: #7C3AED; }
    
    /* FAB */
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary) 0%, #8B5CF6 100%);
      border: none;
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      color: white;
      z-index: 99;
    }
    
    @media (max-width: 640px) {
      .main { padding: 16px; }
      .controls { flex-direction: column; align-items: stretch; }
      .period-nav { justify-content: center; }
      .dashboard { grid-template-columns: repeat(2, 1fr); }
      .chart-section { grid-template-columns: 1fr; }
      .form-grid { grid-template-columns: 1fr; }
      .form-group.full { grid-column: span 1; }
      .tx-main { flex-wrap: wrap; }
      .tx-amount { width: 100%; text-align: right; margin-top: 8px; }
      .mile-input-row { flex-direction: column; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <div class="logo-icon" id="logoIcon" onclick="openIconModal()" title="í´ë¦­í•˜ì—¬ ì•„ì´ì½˜ ë³€ê²½">ê°€</div>
      <span class="logo-text">ë‚˜ë§Œì˜ ê°€ê³„ë¶€</span>
    </div>
    <div style="display:flex; align-items:center; gap:8px;">
      <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="ë‹¤í¬ëª¨ë“œ ì „í™˜">ğŸŒ™</button>
      <button class="theme-toggle" onclick="openSettingsModal()" title="ì„¤ì •">âš™ï¸</button>
    </div>
  </header>

  <main class="main">
    <!-- ì»¨íŠ¸ë¡¤ -->
    <div class="controls">
      <div class="view-toggle">
        <button class="view-btn active" id="btnMonthly" onclick="switchView('monthly')">ğŸ“… ì›”ê°„</button>
        <button class="view-btn" id="btnYearly" onclick="switchView('yearly')">ğŸ“Š ì—°ê°„</button>
      </div>
      <div class="period-nav">
        <button class="nav-btn" id="prevBtn" onclick="navigate(-1)">â—€</button>
        <span class="period-text" id="periodText">2026ë…„ 1ì›”</span>
        <button class="nav-btn" id="nextBtn" onclick="navigate(1)">â–¶</button>
      </div>
    </div>

    <!-- ì›”ê°„ ë·° -->
    <div class="monthly-view" id="monthlyView">
      <!-- ëŒ€ì‹œë³´ë“œ -->
      <div class="dashboard">
        <div class="stat-card blue">
          <span class="stat-label">ğŸ“‹ ì´ ì§€ì¶œ</span>
          <span class="stat-value" id="totalAmt">0ì›</span>
        </div>
        <div class="stat-card green">
          <span class="stat-label">ğŸ’° ë‚´ ì‹¤ì œ ì§€ì¶œ</span>
          <span class="stat-value" id="myAmt">0ì›</span>
        </div>
        <div class="stat-card pink clickable" onclick="filterByFamily()">
          <span class="stat-label">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ê°€ì¡± ì§€ì¶œ</span>
          <span class="stat-value" id="familyAmt">0ì›</span>
          <span class="stat-hint" style="color: var(--pink);">ğŸ‘† ê°€ì¡± ë‚´ì—­ ë³´ê¸°</span>
        </div>
        <div class="stat-card yellow clickable" onclick="openMileModal()">
          <span class="stat-label">ğŸ ìƒí’ˆê¶Œ <span style="font-size:10px; opacity:0.8;">ğŸ‘† ë§ˆì¼ë‹¨ê°€</span></span>
          <span class="stat-value" id="giftAmt">0ì›</span>
        </div>
      </div>

      <!-- ì°¨íŠ¸ -->
      <div class="chart-section">
        <div class="chart-card">
          <div class="chart-title">ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</div>
          <div class="chart-wrapper"><canvas id="categoryChart"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">ğŸ“ˆ ìµœê·¼ 3ê°œì›” ì¶”ì´</div>
          <div class="chart-wrapper"><canvas id="trendChart"></canvas></div>
        </div>
      </div>

      <!-- ì…ë ¥ -->
      <div class="input-section">
        <div class="input-header">
          <div class="input-icon">ğŸ’¬</div>
          <div>
            <div class="input-title">ì§€ì¶œ ì…ë ¥</div>
            <div class="input-desc">ì¹´ë“œ ì‚¬ìš© ë‚´ì—­(ë¬¸ì, ëª…ì„¸ì„œ, ì—‘ì…€)ì„ ë¶™ì—¬ë„£ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”</div>
          </div>
        </div>
        <div class="tabs">
          <button class="tab active" onclick="setTab('quick')">âš¡ ë¹ ë¥¸ ì…ë ¥</button>
          <button class="tab" onclick="setTab('manual')">âœï¸ ì§ì ‘ ì…ë ¥</button>
          <button class="tab" onclick="setTab('excel')">ğŸ“Š ì—‘ì…€ ì—…ë¡œë“œ</button>
        </div>
        <div class="tab-content active" id="tabQuick">
          <textarea id="quickInput" placeholder="ì˜ˆì‹œ:
[ì‹ í•œì¹´ë“œ] 45,000ì› ìŠ¤íƒ€ë²…ìŠ¤ ê°•ë‚¨ì  01/23 10:30
[ì‚¼ì„±ì¹´ë“œ] 128,000ì› ì¿ íŒ¡ 01/22
ë„¤ì´ë²„í˜ì´ 32,000ì› CGV 01/21"></textarea>
          <div id="parseResult"></div>
          <button class="btn btn-primary" onclick="parseQuickInput()">âš¡ ìë™ ì¸ì‹</button>
        </div>
        <div class="tab-content" id="tabExcel">
          <div style="text-align:center; padding:20px; border:2px dashed var(--border); border-radius:12px; margin-bottom:12px;">
            <div style="font-size:40px; margin-bottom:12px;">ğŸ“Š</div>
            <div style="font-size:14px; font-weight:600; margin-bottom:8px;">ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</div>
            <div style="font-size:12px; color:var(--text-secondary); margin-bottom:16px;">
              .xlsx, .xls, .csv íŒŒì¼ ì§€ì›<br>
              (ë‚ ì§œ, ê°€ë§¹ì , ê¸ˆì•¡ ì—´ í¬í•¨ í•„ìˆ˜)
            </div>
            <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="display:none;" onchange="handleExcelUpload(event)">
            <button class="btn btn-primary" style="width:auto; padding:12px 24px;" onclick="document.getElementById('excelFile').click()">ğŸ“ íŒŒì¼ ì„ íƒ</button>
          </div>
          <div id="excelParseResult"></div>
        </div>
        <div class="tab-content" id="tabManual">
          <div class="form-grid">
            <div class="form-group full">
              <label class="form-label">ê°€ë§¹ì ëª… *</label>
              <input type="text" class="form-input" id="mStore" placeholder="ì˜ˆ: ìŠ¤íƒ€ë²…ìŠ¤ ê°•ë‚¨ì ">
            </div>
            <div class="form-group">
              <label class="form-label">ê¸ˆì•¡ *</label>
              <input type="number" class="form-input" id="mAmount" placeholder="0">
            </div>
            <div class="form-group">
              <label class="form-label">ë‚ ì§œ</label>
              <input type="date" class="form-input" id="mDate">
            </div>
            <div class="form-group">
              <label class="form-label">ê²°ì œìˆ˜ë‹¨</label>
              <select class="form-select" id="mCard">
                <option>ì‹ í•œì¹´ë“œ</option>
                <option>ì‚¼ì„±ì¹´ë“œ</option>
                <option>í˜„ëŒ€ì¹´ë“œ</option>
                <option>KBêµ­ë¯¼ì¹´ë“œ</option>
                <option>ë¡¯ë°ì¹´ë“œ</option>
                <option>ë„¤ì´ë²„í˜ì´</option>
                <option>ì¹´ì¹´ì˜¤í˜ì´</option>
                <option>í˜„ê¸ˆ</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
              <select class="form-select" id="mCategory">
                <option value="food">ğŸ½ï¸ ì‹ë¹„</option>
                <option value="shopping">ğŸ›’ ì‡¼í•‘</option>
                <option value="transport">ğŸš— êµí†µ</option>
                <option value="leisure">ğŸ¬ ì—¬ê°€</option>
                <option value="medical">ğŸ¥ ì˜ë£Œ</option>
                <option value="utility">ğŸ’¡ ê³µê³¼ê¸ˆ</option>
                <option value="education">ğŸ“š êµìœ¡</option>
                <option value="giftcard">ğŸ ìƒí’ˆê¶Œ</option>
                <option value="etc">ğŸ“¦ ê¸°íƒ€</option>
              </select>
            </div>
            <div class="form-group full">
              <button class="btn btn-primary" onclick="addManual()">ì €ì¥í•˜ê¸°</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ê±°ë˜ ë‚´ì—­ -->
      <div class="tx-section">
        <div class="tx-header">
          <div>
            <div class="tx-title">ê±°ë˜ ë‚´ì—­</div>
            <div class="tx-subtitle">ğŸ’¡ í´ë¦­í•˜ë©´ ì •ì‚° ì„¤ì • ê°€ëŠ¥</div>
          </div>
          <div class="filter-badge" id="filterBadge">
            <span id="filterText"></span>
            <button class="filter-clear" onclick="clearFilter()">âœ•</button>
          </div>
        </div>
        <div class="tx-list" id="txList"></div>
      </div>
    </div>

    <!-- ì—°ê°„ ë·° -->
    <div class="yearly-view" id="yearlyView">
      <div class="dashboard">
        <div class="stat-card blue">
          <span class="stat-label">ğŸ“‹ ì—°ê°„ ì´ ì§€ì¶œ</span>
          <span class="stat-value" id="yTotalAmt">0ì›</span>
        </div>
        <div class="stat-card green">
          <span class="stat-label">ğŸ’° ë‚´ ì—°ê°„ ì§€ì¶œ</span>
          <span class="stat-value" id="yMyAmt">0ì›</span>
        </div>
        <div class="stat-card yellow clickable" onclick="openYearlyMileModal()">
          <span class="stat-label">ğŸ ì—°ê°„ ìƒí’ˆê¶Œ</span>
          <span class="stat-value" id="yGiftAmt">0ì›</span>
          <span class="stat-hint">ğŸ‘† ì—°ê°„ ë§ˆì¼ë‹¨ê°€</span>
        </div>
      </div>

      <div class="chart-section">
        <div class="chart-card">
          <div class="chart-title">ğŸ“Š ì—°ê°„ ì¹´í…Œê³ ë¦¬ë³„</div>
          <div class="chart-wrapper"><canvas id="yearlyCatChart"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">ğŸ“ˆ ì›”ë³„ ì§€ì¶œ ì¶”ì´</div>
          <div class="chart-wrapper"><canvas id="yearlyBarChart"></canvas></div>
        </div>
      </div>

      <div class="tx-section">
        <div class="tx-title" style="margin-bottom:8px">ğŸ“Š ì›”ë³„ ìƒì„¸ (í´ë¦­ì‹œ ì´ë™)</div>
        <div class="monthly-bars" id="monthlyBars"></div>
        <div class="avg-card">
          <div class="avg-row"><span class="avg-label">ì›”í‰ê·  ì´ ì§€ì¶œ</span><span class="avg-value" id="avgTotal">0ì›</span></div>
          <div class="avg-row"><span class="avg-label">ì›”í‰ê·  ìƒí™œë¹„</span><span class="avg-value" id="avgLiving">0ì›</span></div>
          <div class="avg-row"><span class="avg-label">ì›”í‰ê·  ë‚´ ì§€ì¶œ</span><span class="avg-value highlight" id="avgMy">0ì›</span></div>
        </div>
      </div>
    </div>
  </main>

  <button class="fab" id="fab" onclick="openManualTab()">+</button>

  <!-- ì›”ê°„ ë§ˆì¼ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="mileModal" onclick="closeMileModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">âœˆï¸ ë§ˆì¼ë‹¨ê°€ ê³„ì‚°ê¸°</div>
        <button class="modal-close" onclick="closeMileModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="mile-section">
          <div class="mile-title">ğŸ“Š ì´ë²ˆ ë‹¬ ìƒí’ˆê¶Œ</div>
          <div class="mile-info-box">
            <div class="mile-row">
              <span class="mile-label">ìƒí’ˆê¶Œ êµ¬ë§¤ì•¡</span>
              <span class="mile-value" id="mileGiftTotal">0ì›</span>
            </div>
          </div>
        </div>
        <div class="mile-section">
          <div class="mile-title">ğŸ’µ í˜„ê¸ˆí™” ë° ì¹´ë“œ ì •ë³´</div>
          <div class="mile-input-row">
            <div class="mile-input-group">
              <label>í˜„ê¸ˆí™” ê¸ˆì•¡</label>
              <div class="mile-input-wrapper">
                <input type="number" class="mile-input" id="mileCash" oninput="calcMile()">
                <span class="mile-suffix">ì›</span>
              </div>
            </div>
          </div>
          <div class="mile-input-row">
            <div class="mile-input-group">
              <label>ì¹´ë“œ ì—°íšŒë¹„</label>
              <div class="mile-input-wrapper">
                <input type="number" class="mile-input" id="mileFee" oninput="calcMile()">
                <span class="mile-suffix">ì›</span>
              </div>
            </div>
          </div>
          <div class="mile-input-row">
            <div class="mile-input-group">
              <label>ì¹´ë“œ í˜œíƒ</label>
              <div class="mile-input-wrapper">
                <input type="number" class="mile-input" id="mileBenefit" oninput="calcMile()">
                <span class="mile-suffix">ì›</span>
              </div>
            </div>
          </div>
          <div class="mile-input-row">
            <div class="mile-input-group">
              <label>íšë“ ë§ˆì¼ë¦¬ì§€</label>
              <div class="mile-input-wrapper">
                <input type="number" class="mile-input" id="mileMile" oninput="calcMile()">
                <span class="mile-suffix">ë§ˆì¼</span>
              </div>
            </div>
          </div>
        </div>
        <div class="formula-box">
          <strong>ğŸ“ ê³„ì‚° ê³µì‹:</strong><br>
          <code>(ìƒí’ˆê¶Œ - í˜„ê¸ˆí™” + ì—°íšŒë¹„ - í˜œíƒ) Ã· ë§ˆì¼</code>
        </div>
        <div class="mile-result">
          <div class="mile-row"><span class="mile-label">ìƒí’ˆê¶Œ êµ¬ë§¤</span><span class="mile-value" id="rPurchase">0ì›</span></div>
          <div class="mile-row"><span class="mile-label">(-) í˜„ê¸ˆí™”</span><span class="mile-value" id="rCash">0ì›</span></div>
          <div class="mile-row"><span class="mile-label">(+) ì—°íšŒë¹„</span><span class="mile-value" id="rFee">0ì›</span></div>
          <div class="mile-row"><span class="mile-label">(-) í˜œíƒ</span><span class="mile-value" id="rBenefit">0ì›</span></div>
          <div class="mile-row"><span class="mile-label">= ì‹¤ì œ ë¹„ìš©</span><span class="mile-value" id="rActual">0ì›</span></div>
          <div class="mile-row total">
            <span class="mile-label">ğŸ¯ ë§ˆì¼ë‹¹ ë‹¨ê°€</span>
            <span class="mile-value highlight" id="rPerMile">- ì›/ë§ˆì¼</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeMileModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì•„ì´ì½˜ ì„¤ì • ëª¨ë‹¬ -->
  <div class="modal-overlay" id="iconModal" onclick="closeIconModal()">
    <div class="modal" style="max-width:320px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">ğŸ¨ ì•„ì´ì½˜ ë³€ê²½</div>
        <button class="modal-close" onclick="closeIconModal()">Ã—</button>
      </div>
      <div class="modal-body" style="text-align:center;">
        <div style="width:80px; height:80px; background:linear-gradient(135deg, var(--primary) 0%, #8B5CF6 100%); border-radius:20px; display:flex; align-items:center; justify-content:center; margin:0 auto 20px; color:white; font-weight:800; font-size:32px;" id="iconPreview">ê°€</div>
        <div class="edit-form-group">
          <label>ìƒˆ ì•„ì´ì½˜ (í•œê¸€, ì˜ì–´, ì´ëª¨ì§€)</label>
          <input type="text" id="iconInput" placeholder="ì˜ˆ: HS, ê°€, ğŸ’°" maxlength="4" style="text-align:center; font-size:24px; font-weight:bold;" oninput="document.getElementById('iconPreview').textContent = this.value || 'ê°€'">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="saveIcon()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <div class="modal-overlay" id="settingsModal" onclick="closeSettingsModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">âš™ï¸ ì„¤ì •</div>
        <button class="modal-close" onclick="closeSettingsModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="mile-section">
          <div class="mile-title">ğŸ’³ ì»¤ìŠ¤í…€ ì¹´ë“œ ê´€ë¦¬</div>
          <div id="customCardList" style="margin-bottom:12px;"></div>
          <div style="display:flex; gap:8px;">
            <input type="text" id="newCardName" class="form-input" placeholder="ìƒˆ ì¹´ë“œëª… (ì˜ˆ: í˜„ëŒ€150)" style="flex:1;">
            <button class="btn btn-primary" style="width:auto; padding:10px 16px;" onclick="addCustomCard()">ì¶”ê°€</button>
          </div>
        </div>
        <div class="mile-section">
          <div class="mile-title">ğŸ’¾ ë°ì´í„° ë°±ì—…/ë³µì›</div>
          <div style="display:flex; gap:8px; margin-bottom:8px;">
            <button class="btn btn-secondary" style="flex:1;" onclick="exportData()">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
            <button class="btn btn-secondary" style="flex:1;" onclick="document.getElementById('importFile').click()">ğŸ“¥ ê°€ì ¸ì˜¤ê¸°</button>
            <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
          </div>
          <div style="font-size:11px; color:var(--text-muted);">
            JSON íŒŒì¼ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ë°±ì—…í•˜ê³  ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeSettingsModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ê±°ë˜ ìˆ˜ì • ëª¨ë‹¬ -->
  <div class="modal-overlay" id="editTxModal" onclick="closeEditModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">âœï¸ ê±°ë˜ ìˆ˜ì •</div>
        <button class="modal-close" onclick="closeEditModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editTxId">
        <div class="edit-form-group">
          <label>ê°€ë§¹ì ëª…</label>
          <input type="text" id="editStore" placeholder="ê°€ë§¹ì ëª…">
        </div>
        <div class="edit-form-row">
          <div class="edit-form-group">
            <label>ê¸ˆì•¡</label>
            <input type="number" id="editAmount" placeholder="0">
          </div>
          <div class="edit-form-group">
            <label>ë‚ ì§œ (MM/DD)</label>
            <input type="text" id="editDate" placeholder="01/23">
          </div>
        </div>
        <div class="edit-form-row">
          <div class="edit-form-group">
            <label>ê²°ì œìˆ˜ë‹¨</label>
            <select id="editCard">
              <option>ì‹ í•œì¹´ë“œ</option>
              <option>ì‚¼ì„±ì¹´ë“œ</option>
              <option>í˜„ëŒ€ì¹´ë“œ</option>
              <option>KBêµ­ë¯¼ì¹´ë“œ</option>
              <option>ë¡¯ë°ì¹´ë“œ</option>
              <option>ìš°ë¦¬ì¹´ë“œ</option>
              <option>í•˜ë‚˜ì¹´ë“œ</option>
              <option>NHë†í˜‘ì¹´ë“œ</option>
              <option>BCì¹´ë“œ</option>
              <option>ë„¤ì´ë²„í˜ì´</option>
              <option>ì¹´ì¹´ì˜¤í˜ì´</option>
              <option>í† ìŠ¤</option>
              <option>í˜„ê¸ˆ</option>
            </select>
          </div>
          <div class="edit-form-group">
            <label>ì¹´í…Œê³ ë¦¬</label>
            <select id="editCategory">
              <option value="food">ğŸ½ï¸ ì‹ë¹„</option>
              <option value="shopping">ğŸ›’ ì‡¼í•‘</option>
              <option value="transport">ğŸš— êµí†µ</option>
              <option value="leisure">ğŸ¬ ì—¬ê°€</option>
              <option value="medical">ğŸ¥ ì˜ë£Œ</option>
              <option value="utility">ğŸ’¡ ê³µê³¼ê¸ˆ</option>
              <option value="education">ğŸ“š êµìœ¡</option>
              <option value="giftcard">ğŸ ìƒí’ˆê¶Œ</option>
              <option value="etc">ğŸ“¦ ê¸°íƒ€</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="saveEditTx()">ì €ì¥í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì—°ê°„ ë§ˆì¼ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="yearlyMileModal" onclick="closeYearlyMileModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" id="yMileTitle">âœˆï¸ 2026ë…„ ì—°ê°„ ë§ˆì¼ë‹¨ê°€</div>
        <button class="modal-close" onclick="closeYearlyMileModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="mile-section">
          <div class="mile-title">ğŸ“Š ì—°ê°„ ëˆ„ê³„</div>
          <div class="mile-info-box">
            <div class="mile-row"><span class="mile-label">ìƒí’ˆê¶Œ ì´ì•¡</span><span class="mile-value" id="yMileGift">0ì›</span></div>
            <div class="mile-row"><span class="mile-label">í˜„ê¸ˆí™” ëˆ„ê³„</span><span class="mile-value" id="yMileCash">0ì›</span></div>
            <div class="mile-row"><span class="mile-label">ë§ˆì¼ ëˆ„ê³„</span><span class="mile-value" id="yMileMile">0 ë§ˆì¼</span></div>
          </div>
        </div>
        <div class="mile-section">
          <div class="mile-title">ğŸ’³ ì—°ê°„ ì¹´ë“œ ë¹„ìš©</div>
          <div class="mile-input-row">
            <div class="mile-input-group">
              <label>ì—°íšŒë¹„ í•©ê³„</label>
              <div class="mile-input-wrapper">
                <input type="number" class="mile-input" id="yFee" oninput="calcYearlyMile()">
                <span class="mile-suffix">ì›</span>
              </div>
            </div>
            <div class="mile-input-group">
              <label>í˜œíƒ í•©ê³„</label>
              <div class="mile-input-wrapper">
                <input type="number" class="mile-input" id="yBenefit" oninput="calcYearlyMile()">
                <span class="mile-suffix">ì›</span>
              </div>
            </div>
          </div>
        </div>
        <div class="mile-result">
          <div class="mile-row"><span class="mile-label">ì—°ê°„ ìƒí’ˆê¶Œ</span><span class="mile-value" id="yrPurchase">0ì›</span></div>
          <div class="mile-row"><span class="mile-label">(-) í˜„ê¸ˆí™”</span><span class="mile-value" id="yrCash">0ì›</span></div>
          <div class="mile-row"><span class="mile-label">(+) ì—°íšŒë¹„</span><span class="mile-value" id="yrFee">0ì›</span></div>
          <div class="mile-row"><span class="mile-label">(-) í˜œíƒ</span><span class="mile-value" id="yrBenefit">0ì›</span></div>
          <div class="mile-row"><span class="mile-label">= ì‹¤ì œ ë¹„ìš©</span><span class="mile-value" id="yrActual">0ì›</span></div>
          <div class="mile-row total">
            <span class="mile-label">ğŸ¯ ì—°ê°„ ë§ˆì¼ë‹¨ê°€</span>
            <span class="mile-value highlight" id="yrPerMile">- ì›/ë§ˆì¼</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeYearlyMileModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <script>
    // ===== ìƒìˆ˜ =====
    const START_YEAR = 2026;
    const STORAGE_KEY = 'smartLedgerPro_v1';
    const MEMBERS = [
      { id: 'me', name: 'ë‚˜', isMe: true, isFamily: false },
      { id: 'mom', name: 'ì—„ë§ˆ', isMe: false, isFamily: true },
      { id: 'dad', name: 'ì•„ë¹ ', isMe: false, isFamily: true },
      { id: 'sibling', name: 'ë™ìƒ', isMe: false, isFamily: true },
      { id: 'friend', name: 'ì¹œêµ¬', isMe: false, isFamily: false }
    ];
    const FAMILY_IDS = ['mom', 'dad', 'sibling'];
    const CATEGORIES = {
      food: { name: 'ì‹ë¹„', color: '#F97316' },
      shopping: { name: 'ì‡¼í•‘', color: '#6366F1' },
      transport: { name: 'êµí†µ', color: '#10B981' },
      leisure: { name: 'ì—¬ê°€', color: '#EC4899' },
      medical: { name: 'ì˜ë£Œ', color: '#EF4444' },
      utility: { name: 'ê³µê³¼ê¸ˆ', color: '#3B82F6' },
      education: { name: 'êµìœ¡', color: '#8B5CF6' },
      giftcard: { name: 'ìƒí’ˆê¶Œ', color: '#F59E0B' },
      etc: { name: 'ê¸°íƒ€', color: '#6B7280' }
    };

    // ===== ìƒíƒœ =====
    let state = {
      year: START_YEAR,
      month: 1,
      view: 'monthly',
      filter: null,
      expandedId: null,
      data: {},           // ì›”ë³„ ê±°ë˜
      mileData: {},       // ì›”ë³„ ë§ˆì¼ ì…ë ¥
      yearlyMileData: {}, // ì—°ê°„ ë§ˆì¼ ì…ë ¥
      charts: {}
    };

    // ===== ìœ í‹¸ =====
    const key = (y, m) => `${y}-${String(m).padStart(2, '0')}`;
    const fmt = n => n.toLocaleString('ko-KR');
    const fmtShort = n => n >= 10000 ? Math.round(n/10000) + 'ë§Œ' : fmt(n);
    const uid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

    // ===== ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° =====
    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        data: state.data,
        mileData: state.mileData,
        yearlyMileData: state.yearlyMileData,
        customCards: state.customCards,
        logoIcon: state.logoIcon,
        theme: state.theme
      }));
    }

    function load() {
      try {
        const s = JSON.parse(localStorage.getItem(STORAGE_KEY));
        if (s) {
          state.data = s.data || {};
          state.mileData = s.mileData || {};
          state.yearlyMileData = s.yearlyMileData || {};
          state.customCards = s.customCards || [];
          state.logoIcon = s.logoIcon || 'ê°€';
          state.theme = s.theme || 'light';
        }
      } catch(e) { console.error(e); }
      
      // ìƒ˜í”Œ ë°ì´í„°
      if (Object.keys(state.data).length === 0) {
        state.data['2026-01'] = [
          { id: uid(), date: '01/23', store: 'ìŠ¤íƒ€ë²…ìŠ¤ ê°•ë‚¨ì ', card: 'ì‹ í•œì¹´ë“œ', cat: 'food', amt: 45000, split: { members: { me: 45000 } } },
          { id: uid(), date: '01/22', store: 'ì¿ íŒ¡', card: 'ì‚¼ì„±ì¹´ë“œ', cat: 'shopping', amt: 128000, split: { members: { me: 64000, mom: 64000 } } },
          { id: uid(), date: '01/21', store: 'ì‹ ì„¸ê³„ìƒí’ˆê¶Œ', card: 'í˜„ëŒ€ì¹´ë“œ', cat: 'giftcard', amt: 500000, split: { members: { me: 500000 } } },
          { id: uid(), date: '01/20', store: 'CGV ì˜ë“±í¬', card: 'KBêµ­ë¯¼ì¹´ë“œ', cat: 'leisure', amt: 32000, split: { members: { me: 16000, sibling: 16000 } } },
          { id: uid(), date: '01/19', store: 'ë¡¯ë°ìƒí’ˆê¶Œ', card: 'ë¡¯ë°ì¹´ë“œ', cat: 'giftcard', amt: 1000000, split: { members: { me: 1000000 } } }
        ];
        save();
      }
    }

    // ===== ì´ˆê¸°í™” =====
    document.addEventListener('DOMContentLoaded', () => {
      load();
      const today = new Date();
      if (today.getFullYear() >= START_YEAR) {
        state.year = today.getFullYear();
        state.month = today.getMonth() + 1;
      }
      document.getElementById('mDate').value = today.toISOString().split('T')[0];
      // ë¡œê³  ì•„ì´ì½˜ ì„¤ì • ì ìš©
      document.getElementById('logoIcon').textContent = state.logoIcon || 'ê°€';
      // í…Œë§ˆ ì ìš©
      applyTheme();
      // ì¹´ë“œ ì…€ë ‰íŠ¸ ì—…ë°ì´íŠ¸
      updateCardSelects();
      render();
    });

    // ===== ë·° ì „í™˜ =====
    function switchView(v) {
      state.view = v;
      state.filter = null;
      document.getElementById('btnMonthly').classList.toggle('active', v === 'monthly');
      document.getElementById('btnYearly').classList.toggle('active', v === 'yearly');
      document.getElementById('monthlyView').classList.toggle('hidden', v !== 'monthly');
      document.getElementById('yearlyView').classList.toggle('active', v === 'yearly');
      document.getElementById('fab').style.display = v === 'monthly' ? 'flex' : 'none';
      render();
    }

    // ===== ê¸°ê°„ ì´ë™ =====
    function navigate(delta) {
      if (state.view === 'monthly') {
        let m = state.month + delta, y = state.year;
        if (m > 12) { m = 1; y++; }
        if (m < 1) { m = 12; y--; }
        if (y < START_YEAR || (y === START_YEAR && m < 1)) return;
        state.month = m; state.year = y;
      } else {
        const y = state.year + delta;
        if (y < START_YEAR) return;
        state.year = y;
      }
      render();
    }

    function updateNav() {
      const txt = state.view === 'monthly' 
        ? `${state.year}ë…„ ${state.month}ì›”`
        : `${state.year}ë…„`;
      document.getElementById('periodText').textContent = txt;
      
      const canPrev = state.view === 'monthly'
        ? !(state.year === START_YEAR && state.month === 1)
        : state.year > START_YEAR;
      document.getElementById('prevBtn').disabled = !canPrev;
    }

    // ===== ë©”ì¸ ë Œë” =====
    function render() {
      updateNav();
      if (state.view === 'monthly') renderMonthly();
      else renderYearly();
    }

    function getTx() {
      return state.data[key(state.year, state.month)] || [];
    }

    function renderMonthly() {
      const tx = getTx();
      let total = 0, myTotal = 0, familyTotal = 0, giftTotal = 0;
      const catTotals = {};

      tx.forEach(t => {
        total += t.amt;
        if (t.cat === 'giftcard') giftTotal += t.amt;
        else catTotals[t.cat] = (catTotals[t.cat] || 0) + t.amt;
        
        if (t.split?.members) {
          myTotal += t.split.members.me || 0;
          FAMILY_IDS.forEach(id => { familyTotal += t.split.members[id] || 0; });
        }
      });

      document.getElementById('totalAmt').textContent = fmtShort(total) + 'ì›';
      document.getElementById('myAmt').textContent = fmtShort(myTotal) + 'ì›';
      document.getElementById('familyAmt').textContent = fmtShort(familyTotal) + 'ì›';
      document.getElementById('giftAmt').textContent = fmtShort(giftTotal) + 'ì›';

      renderCategoryChart(catTotals);
      renderTrendChart();
      renderTxList(tx);
    }

    function renderCategoryChart(data) {
      const ctx = document.getElementById('categoryChart');
      if (state.charts.category) state.charts.category.destroy();

      const cats = Object.keys(data).filter(k => data[k] > 0);
      if (cats.length === 0) {
        state.charts.category = new Chart(ctx, {
          type: 'doughnut',
          data: { labels: ['ë°ì´í„° ì—†ìŒ'], datasets: [{ data: [1], backgroundColor: ['#E5E7EB'] }] },
          options: { cutout: '65%', plugins: { legend: { display: false }, datalabels: { display: false } } }
        });
        return;
      }

      const total = cats.reduce((sum, c) => sum + data[c], 0);

      state.charts.category = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: cats.map(c => CATEGORIES[c]?.name || c),
          datasets: [{
            data: cats.map(c => data[c]),
            backgroundColor: cats.map(c => CATEGORIES[c]?.color || '#6B7280')
          }]
        },
        plugins: [ChartDataLabels],
        options: {
          cutout: '55%',
          maintainAspectRatio: false,
          layout: {
            padding: { right: 10 }
          },
          plugins: {
            legend: {
              position: 'right',
              align: 'center',
              labels: {
                boxWidth: 12,
                padding: 6,
                font: { size: 10 },
                generateLabels: function(chart) {
                  const data = chart.data;
                  return data.labels.map((label, i) => {
                    const value = data.datasets[0].data[i];
                    const percent = ((value / total) * 100).toFixed(0);
                    return {
                      text: `${label} ${percent}%`,
                      fillStyle: data.datasets[0].backgroundColor[i],
                      strokeStyle: data.datasets[0].backgroundColor[i],
                      lineWidth: 0,
                      index: i
                    };
                  });
                }
              }
            },
            datalabels: {
              color: '#fff',
              font: { weight: 'bold', size: 10 },
              formatter: (value, context) => {
                const percent = ((value / total) * 100).toFixed(0);
                return percent >= 8 ? fmtShort(value) : '';
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const percent = ((value / total) * 100).toFixed(1);
                  return `${context.label}: ${fmt(value)}ì› (${percent}%)`;
                }
              }
            }
          },
          onClick: (e, el) => {
            if (el.length) {
              state.filter = cats[el[0].index];
              document.getElementById('filterBadge').classList.add('active');
              document.getElementById('filterText').textContent = CATEGORIES[state.filter]?.name + ' í•„í„°';
              renderTxList(getTx());
            }
          }
        }
      });
    }

    function renderTrendChart() {
      const ctx = document.getElementById('trendChart');
      if (state.charts.trend) state.charts.trend.destroy();

      const months = [];
      for (let i = 2; i >= 0; i--) {
        let m = state.month - i, y = state.year;
        if (m < 1) { m += 12; y--; }
        if (y < START_YEAR) { months.push({ label: '', living: 0, gift: 0 }); continue; }
        
        const tx = state.data[key(y, m)] || [];
        let living = 0, gift = 0;
        tx.forEach(t => { if (t.cat === 'giftcard') gift += t.amt; else living += t.amt; });
        months.push({ label: m + 'ì›”', living, gift });
      }

      state.charts.trend = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: months.map(m => m.label),
          datasets: [
            { label: 'ìƒí™œë¹„', data: months.map(m => m.living), backgroundColor: '#6366F1', borderRadius: 6 },
            { label: 'ìƒí’ˆê¶Œ', data: months.map(m => m.gift), backgroundColor: '#F59E0B', borderRadius: 6 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 11 } } } },
          scales: { y: { beginAtZero: true, ticks: { callback: v => fmtShort(v) } } }
        }
      });
    }

    function renderTxList(tx) {
      const list = document.getElementById('txList');
      let filtered;
      if (state.filter === 'family') {
        // ê°€ì¡± ë©¤ë²„ê°€ í¬í•¨ëœ ê±°ë˜ë§Œ í•„í„°ë§
        filtered = tx.filter(t => {
          if (!t.split?.members) return false;
          return FAMILY_IDS.some(id => t.split.members.hasOwnProperty(id) && t.split.members[id] > 0);
        });
      } else if (state.filter) {
        filtered = tx.filter(t => t.cat === state.filter);
      } else {
        filtered = tx;
      }
      
      if (filtered.length === 0) {
        list.innerHTML = '<div class="no-data">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      list.innerHTML = filtered.map(t => {
        const cat = CATEGORIES[t.cat] || CATEGORIES.etc;
        const isGift = t.cat === 'giftcard';
        const expanded = state.expandedId === t.id;
        const myShare = t.split?.members?.me || t.amt;
        const memberCount = t.split?.members ? Object.keys(t.split.members).length : 1;
        const hasSplit = memberCount > 1;

        return `
          <div class="tx-item ${expanded ? 'expanded' : ''}" onclick="toggleExpand('${t.id}')">
            <div class="tx-main">
              <div class="tx-date">${t.date}</div>
              <div class="tx-info">
                <div class="tx-store">
                  <span class="tag tag-${t.cat}">${cat.name}</span>
                  ${t.store}
                  ${hasSplit ? `<span class="tag tag-split">ğŸ‘¥ ${memberCount}ëª…</span>` : ''}
                </div>
                <div class="tx-meta">${t.card}${hasSplit ? ' â€¢ ë‚´ ë¶€ë‹´: ' + fmt(myShare) + 'ì›' : ''}</div>
              </div>
              <div class="tx-amount ${isGift ? 'giftcard' : ''}">${fmt(t.amt)}ì›</div>
            </div>
            <div class="split-panel" onclick="event.stopPropagation()">
              <div class="split-title">ğŸ·ï¸ ë¶„ë¥˜ ìˆ˜ì •</div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:16px;">
                <div>
                  <label style="font-size:11px; color:var(--text-secondary);">ì¹´í…Œê³ ë¦¬</label>
                  <select class="form-select" style="padding:8px; font-size:13px;" onchange="updateTxCategory('${t.id}', this.value)">
                    ${Object.entries(CATEGORIES).map(([k,v]) => `<option value="${k}" ${t.cat === k ? 'selected' : ''}>${v.name}</option>`).join('')}
                  </select>
                </div>
                <div>
                  <label style="font-size:11px; color:var(--text-secondary);">ê²°ì œìˆ˜ë‹¨</label>
                  <select class="form-select" style="padding:8px; font-size:13px;" onchange="updateTxCard('${t.id}', this.value)">
                    ${getCardOptions(t.card)}
                  </select>
                </div>
              </div>
              <div class="split-title">ğŸ‘¥ ì •ì‚° ì„¤ì •</div>
              <div class="split-members">${renderSplitMembers(t)}</div>
              <div id="splitErr_${t.id}"></div>
              <div class="split-actions">
                <button class="split-btn equal" onclick="equalSplit('${t.id}')">1/N ê· ë“±</button>
                <button class="split-btn save" onclick="saveSplit('${t.id}')">ì €ì¥</button>
              </div>
              <div class="split-summary">
                <span class="split-summary-label">ğŸ’° ë‚´ ì‹¤ì œ ë¶€ë‹´</span>
                <span class="split-summary-value" id="mySum_${t.id}">${fmt(myShare)}ì›</span>
              </div>
              <div class="tx-actions">
                <button class="tx-action-btn edit" onclick="openEditModal('${t.id}')">âœï¸ ìˆ˜ì •</button>
                <button class="tx-action-btn delete" onclick="deleteTx('${t.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>
              </div>
            </div>
          </div>`;
      }).join('');
    }

    function renderSplitMembers(t) {
      return MEMBERS.map(m => {
        const checked = t.split?.members?.hasOwnProperty(m.id);
        const amt = checked ? (t.split.members[m.id] || 0) : 0;
        return `
          <div class="split-row">
            <input type="checkbox" class="split-check" ${checked ? 'checked' : ''} 
              onchange="toggleMember('${t.id}','${m.id}',this.checked)">
            <span class="split-name ${m.isMe ? 'me' : ''} ${m.isFamily ? 'family' : ''}">${m.name}</span>
            <input type="number" class="split-input" id="sp_${t.id}_${m.id}" 
              value="${checked ? amt : ''}" ${!checked ? 'disabled' : ''}
              oninput="updateSplitAmt('${t.id}','${m.id}',this.value)">
            <span class="split-suffix">ì›</span>
          </div>`;
      }).join('');
    }

    function toggleExpand(id) {
      state.expandedId = state.expandedId === id ? null : id;
      renderTxList(getTx());
    }

    function toggleMember(tid, mid, checked) {
      const tx = getTx().find(t => t.id === tid);
      if (!tx) return;
      if (!tx.split) tx.split = { members: {} };
      if (!tx.split.members) tx.split.members = {};

      if (checked) {
        tx.split.members[mid] = 0;
        const cnt = Object.keys(tx.split.members).length;
        const share = Math.floor(tx.amt / cnt);
        const rem = tx.amt - share * cnt;
        let i = 0;
        for (const k in tx.split.members) {
          tx.split.members[k] = share + (i++ === 0 ? rem : 0);
        }
      } else {
        delete tx.split.members[mid];
        const cnt = Object.keys(tx.split.members).length;
        if (cnt > 0) {
          const share = Math.floor(tx.amt / cnt);
          const rem = tx.amt - share * cnt;
          let i = 0;
          for (const k in tx.split.members) {
            tx.split.members[k] = share + (i++ === 0 ? rem : 0);
          }
        }
      }

      if (!tx.split.members.hasOwnProperty('me')) {
        tx.split.members['me'] = tx.amt;
      }

      save();
      renderTxList(getTx());
      renderMonthly();
    }

    function updateSplitAmt(tid, mid, val) {
      const tx = getTx().find(t => t.id === tid);
      if (!tx?.split?.members) return;
      
      const v = Math.max(0, parseInt(val) || 0);
      tx.split.members[mid] = v;

      const total = Object.values(tx.split.members).reduce((a, b) => a + b, 0);
      const errEl = document.getElementById(`splitErr_${tid}`);
      
      if (total !== tx.amt) {
        const diff = tx.amt - total;
        errEl.innerHTML = `<div class="split-error">âš ï¸ ${fmt(Math.abs(diff))}ì› ${diff > 0 ? 'ë¶€ì¡±' : 'ì´ˆê³¼'}</div>`;
      } else {
        errEl.innerHTML = '';
      }

      document.getElementById(`mySum_${tid}`).textContent = fmt(tx.split.members.me || 0) + 'ì›';
    }

    function equalSplit(tid) {
      const tx = getTx().find(t => t.id === tid);
      if (!tx?.split?.members) return;
      
      const keys = Object.keys(tx.split.members);
      const share = Math.floor(tx.amt / keys.length);
      const rem = tx.amt - share * keys.length;
      keys.forEach((k, i) => { tx.split.members[k] = share + (i === 0 ? rem : 0); });
      
      save();
      renderTxList(getTx());
      renderMonthly();
    }

    function saveSplit(tid) {
      const tx = getTx().find(t => t.id === tid);
      if (!tx?.split?.members) return;
      
      const total = Object.values(tx.split.members).reduce((a, b) => a + b, 0);
      if (total !== tx.amt) {
        alert(`í•©ê³„(${fmt(total)}ì›)ê°€ ì´ì•¡(${fmt(tx.amt)}ì›)ê³¼ ë‹¤ë¦…ë‹ˆë‹¤.`);
        return;
      }
      
      save();
      alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
      state.expandedId = null;
      renderTxList(getTx());
      renderMonthly();
    }

    function clearFilter() {
      state.filter = null;
      document.getElementById('filterBadge').classList.remove('active');
      renderTxList(getTx());
    }

    // ===== íƒ­ =====
    function setTab(tab) {
      const tabs = ['quick', 'manual', 'excel'];
      document.querySelectorAll('.tabs .tab').forEach((t, i) => t.classList.toggle('active', tabs[i] === tab));
      document.getElementById('tabQuick').classList.toggle('active', tab === 'quick');
      document.getElementById('tabManual').classList.toggle('active', tab === 'manual');
      document.getElementById('tabExcel').classList.toggle('active', tab === 'excel');
    }

    function openManualTab() {
      setTab('manual');
      window.scrollTo({ top: document.querySelector('.input-section').offsetTop - 80, behavior: 'smooth' });
    }

    // ===== ì—‘ì…€ ì—…ë¡œë“œ =====
    function handleExcelUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          let rows = [];
          const fileName = file.name.toLowerCase();

          if (fileName.endsWith('.csv')) {
            // CSV íŒŒì‹±
            const text = e.target.result;
            rows = parseCSV(text);
          } else {
            // Excel íŒŒì‹± (ê°„ë‹¨í•œ CSV ë³€í™˜ ì‹œë„)
            alert('Excel íŒŒì¼(.xlsx, .xls)ì€ CSVë¡œ ë³€í™˜ í›„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.\n\në°©ë²•: Excelì—ì„œ íŒŒì¼ > ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ì¥ > CSV í˜•ì‹ ì„ íƒ');
            event.target.value = '';
            return;
          }

          if (rows.length < 2) {
            alert('ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            return;
          }

          // í—¤ë” ë¶„ì„
          const header = rows[0].map(h => h.toLowerCase().trim());
          const dateIdx = header.findIndex(h => h.includes('ë‚ ì§œ') || h.includes('date') || h.includes('ì¼ì'));
          const storeIdx = header.findIndex(h => h.includes('ê°€ë§¹ì ') || h.includes('ìƒí˜¸') || h.includes('store') || h.includes('ë‚´ì—­') || h.includes('ì‚¬ìš©ì²˜'));
          const amtIdx = header.findIndex(h => h.includes('ê¸ˆì•¡') || h.includes('amount') || h.includes('ê²°ì œ') || h.includes('ì´ìš©ê¸ˆì•¡'));
          const cardIdx = header.findIndex(h => h.includes('ì¹´ë“œ') || h.includes('card') || h.includes('ê²°ì œìˆ˜ë‹¨'));

          if (amtIdx === -1) {
            alert('ê¸ˆì•¡ ì—´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì—´ ì´ë¦„ì— "ê¸ˆì•¡", "ì´ìš©ê¸ˆì•¡", "ê²°ì œê¸ˆì•¡" ë“±ì´ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.');
            return;
          }

          parsedTx = [];
          for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (row.length <= amtIdx) continue;

            const amtStr = String(row[amtIdx]).replace(/[^0-9\-]/g, '');
            const amt = Math.abs(parseInt(amtStr) || 0);
            if (amt < 100) continue;

            let date = '';
            if (dateIdx >= 0 && row[dateIdx]) {
              date = parseExcelDate(String(row[dateIdx]));
            }
            if (!date) {
              const today = new Date();
              date = String(today.getMonth() + 1).padStart(2, '0') + '/' + String(today.getDate()).padStart(2, '0');
            }

            const store = (storeIdx >= 0 && row[storeIdx]) ? String(row[storeIdx]).trim() : 'ê¸°íƒ€';
            const card = (cardIdx >= 0 && row[cardIdx]) ? String(row[cardIdx]).trim() : 'ì¹´ë“œ';

            // ì¹´í…Œê³ ë¦¬ ìë™ ë¶„ë¥˜
            const cat = detectCategory(store);

            parsedTx.push({ id: uid(), date, store, card, cat, amt, split: { members: { me: amt } } });
          }

          if (parsedTx.length === 0) {
            alert('ì¸ì‹ëœ ê±°ë˜ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }

          document.getElementById('excelParseResult').innerHTML = `
            <div class="parse-result">
              <div class="parse-title">âœ… ${parsedTx.length}ê±´ ì¸ì‹</div>
              ${parsedTx.slice(0, 10).map(t => `
                <div class="parse-item">
                  <span>${t.date} ${t.store}</span>
                  <span class="parse-amount">${fmt(t.amt)}ì›</span>
                </div>`).join('')}
              ${parsedTx.length > 10 ? `<div style="text-align:center; padding:8px; color:var(--text-secondary);">... ì™¸ ${parsedTx.length - 10}ê±´</div>` : ''}
              <div class="parse-actions">
                <button class="btn btn-secondary" onclick="cancelExcelParse()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="confirmExcelParse()">ì¶”ê°€</button>
              </div>
            </div>`;

        } catch (err) {
          alert('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ' + err.message);
        }
      };

      if (file.name.toLowerCase().endsWith('.csv')) {
        reader.readAsText(file, 'UTF-8');
      } else {
        reader.readAsArrayBuffer(file);
      }
      event.target.value = '';
    }

    function parseCSV(text) {
      const lines = text.split(/\r?\n/);
      return lines.map(line => {
        const result = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current.trim());
        return result;
      }).filter(row => row.some(cell => cell));
    }

    function parseExcelDate(dateStr) {
      // ë‹¤ì–‘í•œ ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬
      const patterns = [
        /(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/, // YYYY-MM-DD
        /(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/, // MM-DD-YYYY or DD-MM-YYYY
        /(\d{1,2})[\/\-\.](\d{1,2})/                  // MM-DD or MM/DD
      ];

      for (const pattern of patterns) {
        const match = dateStr.match(pattern);
        if (match) {
          if (match.length === 4) {
            // ì—°ë„ í¬í•¨
            const parts = match.slice(1).map(Number);
            let month, day;
            if (parts[0] > 100) { // YYYY-MM-DD
              month = parts[1];
              day = parts[2];
            } else { // MM-DD-YYYY
              month = parts[0];
              day = parts[1];
            }
            if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
              return String(month).padStart(2, '0') + '/' + String(day).padStart(2, '0');
            }
          } else {
            // MM-DD
            const month = parseInt(match[1]);
            const day = parseInt(match[2]);
            if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
              return String(month).padStart(2, '0') + '/' + String(day).padStart(2, '0');
            }
          }
        }
      }
      return '';
    }

    function detectCategory(store) {
      const text = store.toLowerCase();
      const patterns = [
        [/ìŠ¤íƒ€ë²…ìŠ¤|ì»¤í”¼|ì¹´í˜|ë² ì´ì»¤ë¦¬|ì‹ë‹¹|ì¹˜í‚¨|í”¼ì|ë°°ë‹¬|ë§ˆíŠ¸|í¸ì˜ì |ìŒì‹/i, 'food'],
        [/ì£¼ìœ |ì¶©ì „|íƒì‹œ|ë²„ìŠ¤|ì§€í•˜ì² |êµí†µ|ì£¼ì°¨/i, 'transport'],
        [/cgv|ë©”ê°€ë°•ìŠ¤|ì˜í™”|ë„·í”Œë¦­ìŠ¤|ê²Œì„|ë…¸ë˜ë°©|í—¬ìŠ¤/i, 'leisure'],
        [/ë³‘ì›|ì•½êµ­|ì˜ë£Œ|ì¹˜ê³¼|ì•ˆê³¼/i, 'medical'],
        [/í•™ì›|êµìœ¡|ê°•ì˜|ë„ì„œ/i, 'education'],
        [/ì „ê¸°|ê°€ìŠ¤|ìˆ˜ë„|í†µì‹ |ì¸í„°ë„·/i, 'utility'],
        [/ìƒí’ˆê¶Œ/i, 'giftcard'],
        [/ì¿ íŒ¡|ë„¤ì´ë²„|ì‡¼í•‘|ë°±í™”ì |ì•„ìš¸ë ›/i, 'shopping']
      ];
      for (const [p, c] of patterns) {
        if (p.test(text)) return c;
      }
      return 'etc';
    }

    function confirmExcelParse() {
      const k = key(state.year, state.month);
      if (!state.data[k]) state.data[k] = [];
      parsedTx.forEach(t => state.data[k].unshift(t));
      save();

      document.getElementById('excelParseResult').innerHTML = '';
      parsedTx = [];
      render();
      alert(`${state.data[k].length}ê±´ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
    }

    function cancelExcelParse() {
      parsedTx = [];
      document.getElementById('excelParseResult').innerHTML = '';
    }

    // ===== ë¹ ë¥¸ ì…ë ¥ =====
    let parsedTx = [];

    function parseQuickInput() {
      const text = document.getElementById('quickInput').value.trim();
      if (!text) { alert('ê²°ì œ ë¬¸ìë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }

      parsedTx = [];
      text.split('\n').filter(l => l.trim()).forEach(line => {
        const p = parseLine(line);
        if (p) parsedTx.push(p);
      });

      if (parsedTx.length === 0) {
        alert('ì¸ì‹ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤');
        return;
      }

      document.getElementById('parseResult').innerHTML = `
        <div class="parse-result">
          <div class="parse-title">âœ… ${parsedTx.length}ê±´ ì¸ì‹</div>
          ${parsedTx.map(t => `
            <div class="parse-item">
              <span>${t.date} ${t.store} (${t.card})</span>
              <span class="parse-amount">${fmt(t.amt)}ì›</span>
            </div>`).join('')}
          <div class="parse-actions">
            <button class="btn btn-secondary" onclick="cancelParse()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="confirmParse()">ì¶”ê°€</button>
          </div>
        </div>`;
    }

    function parseLine(line) {
      const originalLine = line;

      // ===== ê¸ˆì•¡ ì¸ì‹ (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›) =====
      let amt = 0;
      const amtPatterns = [
        /([0-9,]+)\s*ì›/,                          // 45,000ì›
        /ê¸ˆì•¡[:\s]*([0-9,]+)/,                     // ê¸ˆì•¡: 45,000
        /ê²°ì œê¸ˆì•¡[:\s]*([0-9,]+)/,                 // ê²°ì œê¸ˆì•¡: 45,000
        /ìŠ¹ì¸ê¸ˆì•¡[:\s]*([0-9,]+)/,                 // ìŠ¹ì¸ê¸ˆì•¡: 45,000
        /ì¼ì‹œë¶ˆ\s*([0-9,]+)/,                      // ì¼ì‹œë¶ˆ 45,000
        /\s([0-9]{1,3}(?:,[0-9]{3})+)\s/,         // ê³µë°±ìœ¼ë¡œ êµ¬ë¶„ëœ ê¸ˆì•¡
        /([0-9]{4,})/                              // 4ìë¦¬ ì´ìƒ ìˆ«ì
      ];

      for (const pattern of amtPatterns) {
        const match = line.match(pattern);
        if (match) {
          const parsed = parseInt(match[1].replace(/,/g, ''));
          if (parsed >= 100 && parsed <= 100000000) { // 100ì› ~ 1ì–µì› ë²”ìœ„
            amt = parsed;
            break;
          }
        }
      }
      if (!amt) return null;

      // ===== ì¹´ë“œ/ê²°ì œìˆ˜ë‹¨ ì¸ì‹ (í™•ì¥ëœ íŒ¨í„´) =====
      let card = 'ì¹´ë“œ';
      const cardPatterns = [
        // ì£¼ìš” ì¹´ë“œì‚¬
        [/ì‹ í•œ(?:ì¹´ë“œ|BC)?|ì‹ í•œì²´í¬/i, 'ì‹ í•œì¹´ë“œ'],
        [/ì‚¼ì„±(?:ì¹´ë“œ)?/i, 'ì‚¼ì„±ì¹´ë“œ'],
        [/í˜„ëŒ€(?:ì¹´ë“œ|M)?/i, 'í˜„ëŒ€ì¹´ë“œ'],
        [/KB|êµ­ë¯¼(?:ì¹´ë“œ)?|KBêµ­ë¯¼/i, 'KBêµ­ë¯¼ì¹´ë“œ'],
        [/ë¡¯ë°(?:ì¹´ë“œ)?/i, 'ë¡¯ë°ì¹´ë“œ'],
        [/ìš°ë¦¬(?:ì¹´ë“œ|BC)?/i, 'ìš°ë¦¬ì¹´ë“œ'],
        [/í•˜ë‚˜(?:ì¹´ë“œ|BC)?/i, 'í•˜ë‚˜ì¹´ë“œ'],
        [/NH|ë†í˜‘(?:ì¹´ë“œ)?|NHë†í˜‘/i, 'NHë†í˜‘ì¹´ë“œ'],
        [/BC(?:ì¹´ë“œ)?/i, 'BCì¹´ë“œ'],
        [/IBK|ê¸°ì—…ì€í–‰/i, 'IBKê¸°ì—…ì€í–‰'],
        [/ì”¨í‹°|ì‹œí‹°|CITI/i, 'ì”¨í‹°ì¹´ë“œ'],
        [/ì¹´ì¹´ì˜¤ë±…í¬|ì¹´ë±…/i, 'ì¹´ì¹´ì˜¤ë±…í¬'],
        // ê°„í¸ê²°ì œ
        [/ë„¤ì´ë²„í˜ì´|ë„¤ì´ë²„\s*í˜ì´|NAVER|Ní˜ì´/i, 'ë„¤ì´ë²„í˜ì´'],
        [/ì¹´ì¹´ì˜¤í˜ì´|ì¹´ì¹´ì˜¤\s*í˜ì´|KAKAO/i, 'ì¹´ì¹´ì˜¤í˜ì´'],
        [/í† ìŠ¤(?:í˜ì´)?|toss/i, 'í† ìŠ¤'],
        [/í˜ì´ì½”|PAYCO/i, 'í˜ì´ì½”'],
        [/ì‚¼ì„±í˜ì´|samsung\s*pay/i, 'ì‚¼ì„±í˜ì´'],
        [/ì• í”Œí˜ì´|apple\s*pay/i, 'ì• í”Œí˜ì´'],
        // ì²´í¬ì¹´ë“œ
        [/ì²´í¬/i, 'ì²´í¬ì¹´ë“œ'],
        // í˜„ê¸ˆ/ê³„ì¢Œì´ì²´
        [/í˜„ê¸ˆ|ê³„ì¢Œì´ì²´|ì´ì²´/i, 'í˜„ê¸ˆ']
      ];

      for (const [pattern, name] of cardPatterns) {
        if (pattern.test(line)) {
          card = name;
          break;
        }
      }

      // ===== ë‚ ì§œ ì¸ì‹ (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›) =====
      let date = '';
      const datePatterns = [
        // MM/DD í˜•ì‹
        { regex: /(\d{1,2})\/(\d{1,2})/, handler: (m) => [parseInt(m[1]), parseInt(m[2])] },
        // MM-DD í˜•ì‹
        { regex: /(\d{1,2})-(\d{1,2})(?!\d)/, handler: (m) => [parseInt(m[1]), parseInt(m[2])] },
        // MM.DD í˜•ì‹
        { regex: /(\d{1,2})\.(\d{1,2})(?!\d)/, handler: (m) => [parseInt(m[1]), parseInt(m[2])] },
        // YYYY/MM/DD ë˜ëŠ” YYYY-MM-DD ë˜ëŠ” YYYY.MM.DD
        { regex: /(?:20)?(\d{2})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/, handler: (m) => [parseInt(m[2]), parseInt(m[3])] },
        // MMì›” DDì¼
        { regex: /(\d{1,2})ì›”\s*(\d{1,2})ì¼/, handler: (m) => [parseInt(m[1]), parseInt(m[2])] },
        // DDth ë˜ëŠ” DDì¼ (ì›” ì—†ì´)
        { regex: /(\d{1,2})ì¼/, handler: (m) => {
          const today = new Date();
          return [today.getMonth() + 1, parseInt(m[1])];
        }}
      ];

      for (const { regex, handler } of datePatterns) {
        const match = line.match(regex);
        if (match) {
          const [month, day] = handler(match);
          if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
            date = String(month).padStart(2, '0') + '/' + String(day).padStart(2, '0');
            break;
          }
        }
      }

      if (!date) {
        const today = new Date();
        date = String(today.getMonth() + 1).padStart(2, '0') + '/' + String(today.getDate()).padStart(2, '0');
      }

      // ===== ê°€ë§¹ì /ì‚¬ìš©ì²˜ ì¶”ì¶œ (ê°œì„ ëœ ë¡œì§) =====
      let store = '';

      // íŒ¨í„´ 1: íŠ¹ì • ìœ„ì¹˜ì—ì„œ ê°€ë§¹ì ëª… ì¶”ì¶œ (ì¹´ë“œì‚¬ SMS í˜•ì‹)
      const storePatterns = [
        // [ì¹´ë“œì‚¬] ê¸ˆì•¡ ê°€ë§¹ì  í˜•ì‹
        /ì›\s+([ê°€-í£A-Za-z0-9\s\(\)]+?)(?:\s+\d|$|\s+ì¼ì‹œë¶ˆ|\s+ìŠ¹ì¸)/,
        // ê°€ë§¹ì : xxx í˜•ì‹
        /ê°€ë§¹ì [:\s]+([ê°€-í£A-Za-z0-9\s\(\)]+?)(?:\s+\d|$)/,
        // ìŠ¹ì¸ xxx í˜•ì‹ (ê°€ë§¹ì ëª…)
        /ìŠ¹ì¸\s+([ê°€-í£A-Za-z0-9\s]+?)(?:\s+\d|ì›|$)/,
        // ê¸ˆì•¡ ê°€ë§¹ì  ë‚ ì§œ í˜•ì‹
        /[0-9,]+ì›?\s+([ê°€-í£A-Za-z][ê°€-í£A-Za-z0-9\s\(\)]*?)(?:\s+\d{1,2}[\/\.\-]|\s*$)/
      ];

      for (const pattern of storePatterns) {
        const match = line.match(pattern);
        if (match && match[1]) {
          store = match[1].trim();
          if (store.length >= 2 && store.length <= 30) break;
        }
      }

      // íŒ¨í„´ 2: ë¶ˆí•„ìš”í•œ ë¶€ë¶„ ì œê±° í›„ ì¶”ì¶œ
      if (!store || store.length < 2) {
        store = line
          .replace(/\[.*?\]/g, ' ')                    // [ì¹´ë“œì‚¬] ì œê±°
          .replace(/([0-9,]+)\s*ì›/g, ' ')             // ê¸ˆì•¡ ì œê±°
          .replace(/\d{4}[\/\-\.]\d{1,2}[\/\-\.]\d{1,2}/g, ' ')  // ë‚ ì§œ ì œê±°
          .replace(/\d{1,2}[\/\-\.]\d{1,2}/g, ' ')     // ë‚ ì§œ ì œê±°
          .replace(/\d{1,2}:\d{2}(:\d{2})?/g, ' ')     // ì‹œê°„ ì œê±°
          .replace(/\d{1,2}ì›”\s*\d{1,2}ì¼/g, ' ')      // ë‚ ì§œ ì œê±°
          .replace(/ê²°ì œ|ìŠ¹ì¸|ì·¨ì†Œ|ì‚¬ìš©|ì¼ì‹œë¶ˆ|í• ë¶€|ì²´í¬|ì‹ ìš©|ì¹´ë“œ/g, ' ')
          .replace(/ì”ì•¡|ëˆ„ì |í•œë„|ì´ìš©ê¸ˆì•¡/g, ' ')
          .replace(/\s+/g, ' ')
          .trim();

        // ê°€ì¥ ê¸´ í•œê¸€+ì˜ë¬¸ ë‹¨ì–´ ì¡°í•© ì°¾ê¸°
        const words = store.split(' ').filter(w => w.length >= 2);
        if (words.length > 0) {
          // ë¸Œëœë“œëª…ì´ í¬í•¨ëœ ë‹¨ì–´ ìš°ì„ 
          const brandWords = words.filter(w => /[ê°€-í£]{2,}|[A-Za-z]{2,}/.test(w));
          store = brandWords.length > 0 ? brandWords.join(' ').substring(0, 30) : words[0];
        }
      }

      if (!store || store.length < 2) store = 'ê¸°íƒ€ ê²°ì œ';

      // ===== ì¹´í…Œê³ ë¦¬ ìë™ ë¶„ë¥˜ (í™•ì¥ëœ íŒ¨í„´) =====
      let cat = 'etc';
      const text = originalLine + ' ' + store;

      const catPatterns = [
        // ì‹ë¹„ - ìŒì‹ì , ì¹´í˜, ë°°ë‹¬, ë§ˆíŠ¸
        [/ìŠ¤íƒ€ë²…ìŠ¤|íˆ¬ì¸|ì´ë””ì•¼|ë©”ê°€ì»¤í”¼|ë¹½ë‹¤ë°©|ì»´í¬ì¦ˆ|ì»¤í”¼ë¹ˆ|í• ë¦¬ìŠ¤|íŒŒìŠ¤ì¿ ì°Œ|ì¹´í˜|CAFE|coffee/i, 'food'],
        [/ë§¥ë„ë‚ ë“œ|ë²„ê±°í‚¹|ë¡¯ë°ë¦¬ì•„|KFC|ë§˜ìŠ¤í„°ì¹˜|í”¼ìí—›|ë„ë¯¸ë…¸|íŒŒíŒŒì¡´ìŠ¤|BBQ|BHC|êµì´Œ|êµ½ë„¤|ë„¤ë„¤|ì¹˜í‚¨/i, 'food'],
        [/ë°°ë‹¬ì˜ë¯¼ì¡±|ë°°ë¯¼|ìš”ê¸°ìš”|ì¿ íŒ¡ì´ì¸ |ë°°ë‹¬|BAEMIN/i, 'food'],
        [/ì´ë§ˆíŠ¸|í™ˆí”ŒëŸ¬ìŠ¤|ë¡¯ë°ë§ˆíŠ¸|ì½”ìŠ¤íŠ¸ì½”|íŠ¸ë ˆì´ë”ìŠ¤|í•˜ë‚˜ë¡œë§ˆíŠ¸|ë†í˜‘ë§ˆíŠ¸|GS25|CU|ì„¸ë¸ì¼ë ˆë¸|ë¯¸ë‹ˆìŠ¤í†±|ì´ë§ˆíŠ¸24|í¸ì˜ì /i, 'food'],
        [/ì‹ë‹¹|ë ˆìŠ¤í† ë‘|íšŸì§‘|ê³ ê¹ƒì§‘|ì‚¼ê²¹ì‚´|ê°ˆë¹„|ëƒ‰ë©´|êµ­ë°¥|ì„¤ë íƒ•|ê°ìíƒ•|ì°Œê°œ|ê¹€ë°¥|ë¶„ì‹|ë–¡ë³¶ì´|ë¼ë©˜|ìš°ë™|ì´ˆë°¥|ìŠ¤ì‹œ/i, 'food'],
        [/ë² ì´ì»¤ë¦¬|ë¹µì§‘|íŒŒë¦¬ë°”ê²Œëœ¨|ëšœë ˆì¥¬ë¥´|ë˜í‚¨|í¬ë¦¬ìŠ¤í”¼/i, 'food'],

        // ì‡¼í•‘ - ì˜¨ë¼ì¸ëª°, ë°±í™”ì , ì˜ë¥˜
        [/ì¿ íŒ¡|ë„¤ì´ë²„ì‡¼í•‘|11ë²ˆê°€|Gë§ˆì¼“|ì˜¥ì…˜|ìœ„ë©”í”„|í‹°ëª¬|ì¸í„°íŒŒí¬|SSG|ì‹ ì„¸ê³„ëª°|ë¡¯ë°ì˜¨|í˜„ëŒ€ëª°/i, 'shopping'],
        [/ë°±í™”ì |ì‹ ì„¸ê³„|ë¡¯ë°ë°±í™”ì |í˜„ëŒ€ë°±í™”ì |ê°¤ëŸ¬ë¦¬ì•„|AKí”Œë¼ì/i, 'shopping'],
        [/ì•„ìš¸ë ›|í”„ë¦¬ë¯¸ì—„ì•„ìš¸ë ›|ìŠ¤íƒ€í•„ë“œ|ì½”ì—‘ìŠ¤ëª°|IFCëª°/i, 'shopping'],
        [/ìœ ë‹ˆí´ë¡œ|ìë¼|ZARA|H&M|ë¬´ì‹ ì‚¬|29CM|Wì»¨ì…‰|ì§€ê·¸ì¬ê·¸|ì—ì´ë¸”ë¦¬|ë¸Œëœë””/i, 'shopping'],
        [/ë‹¤ì´ì†Œ|ì•„íŠ¸ë°•ìŠ¤|ì˜¬ë¦¬ë¸Œì˜|ë„ë¼ë¸”ë¼|ì‹œì½”ë¥´|ì„¸í¬ë¼/i, 'shopping'],

        // êµí†µ - ì£¼ìœ , ëŒ€ì¤‘êµí†µ, íƒì‹œ
        [/ì£¼ìœ ì†Œ|SKì—ë„ˆì§€|GSì¹¼í…ìŠ¤|S-OIL|í˜„ëŒ€ì˜¤ì¼|ì•Œëœ°ì£¼ìœ ì†Œ|ì¶©ì „/i, 'transport'],
        [/íƒì‹œ|ì¹´ì¹´ì˜¤T|íƒ€ë‹¤|ìš°ë²„|UBER/i, 'transport'],
        [/ë²„ìŠ¤|ì§€í•˜ì² |ë©”íŠ¸ë¡œ|ì² ë„|KTX|SRT|ë¬´ê¶í™”|ìƒˆë§ˆì„|ì½”ë ˆì¼|ê³ ì†ë²„ìŠ¤|ì‹œì™¸ë²„ìŠ¤/i, 'transport'],
        [/í•˜ì´íŒ¨ìŠ¤|í†¨ê²Œì´íŠ¸|í†µí–‰ë£Œ|ì£¼ì°¨|íŒŒí‚¹/i, 'transport'],
        [/ë”°ë¦‰ì´|í‚¥ë³´ë“œ|ì”½ì”½|ë¼ì„|ë¹”|í‚¥ê³ ì‰/i, 'transport'],

        // ì—¬ê°€ - ì˜í™”, ê³µì—°, ê²Œì„, ìŠ¤í¬ì¸ 
        [/CGV|ë©”ê°€ë°•ìŠ¤|ë¡¯ë°ì‹œë„¤ë§ˆ|ì˜í™”|CINEMA|ì”¨ë„¤/i, 'leisure'],
        [/ë„·í”Œë¦­ìŠ¤|NETFLIX|ì™“ì± |WATCHA|ì›¨ì´ë¸Œ|WAVVE|í‹°ë¹™|TVING|ë””ì¦ˆë‹ˆí”ŒëŸ¬ìŠ¤|ì¿ íŒ¡í”Œë ˆì´|ìœ íŠœë¸Œí”„ë¦¬ë¯¸ì—„/i, 'leisure'],
        [/ë…¸ë˜ë°©|ì½”ì¸ë…¸ë˜|ìˆ˜ë…¸ë˜/i, 'leisure'],
        [/PCë°©|ê²Œì„|ìŠ¤íŒ€|STEAM|í”Œë ˆì´ìŠ¤í…Œì´ì…˜|ë‹Œí…ë„|ì—‘ìŠ¤ë°•ìŠ¤/i, 'leisure'],
        [/í—¬ìŠ¤|í”¼íŠ¸ë‹ˆìŠ¤|GYM|ì§|ìš”ê°€|í•„ë¼í…ŒìŠ¤|ìˆ˜ì˜ì¥|ê³¨í”„|í…Œë‹ˆìŠ¤|ë³¼ë§/i, 'leisure'],
        [/ê³µì—°|ë®¤ì§€ì»¬|ì—°ê·¹|ì½˜ì„œíŠ¸|ì „ì‹œ|ë°•ë¬¼ê´€|ë¯¸ìˆ ê´€|ì¸í„°íŒŒí¬í‹°ì¼“|ì˜ˆìŠ¤24í‹°ì¼“/i, 'leisure'],
        [/ë†€ì´ê³µì›|ì—ë²„ëœë“œ|ë¡¯ë°ì›”ë“œ|ìºë¦¬ë¹„ì•ˆë² ì´|ì›Œí„°íŒŒí¬/i, 'leisure'],

        // ì˜ë£Œ - ë³‘ì›, ì•½êµ­
        [/ë³‘ì›|ì˜ì›|í´ë¦¬ë‹‰|í•œì˜ì›|ì¹˜ê³¼|ì•ˆê³¼|í”¼ë¶€ê³¼|ì„±í˜•|ì •í˜•ì™¸ê³¼|ë‚´ê³¼|ì™¸ê³¼|ì†Œì•„ê³¼|ì‚°ë¶€ì¸ê³¼|ë¹„ë‡¨ê¸°ê³¼|ì´ë¹„ì¸í›„ê³¼/i, 'medical'],
        [/ì•½êµ­|ë“œëŸ­ìŠ¤í† ì–´|PHARMACY/i, 'medical'],
        [/ê±´ê°•ê²€ì§„|ê²€ì§„ì„¼í„°/i, 'medical'],

        // êµìœ¡ - í•™ì›, ê°•ì˜
        [/í•™ì›|ì–´í•™ì›|ì˜ì–´|ì¤‘êµ­ì–´|ì¼ë³¸ì–´|ì–´ë¦°ì´|ì˜ì¬|ë…¼ìˆ |ìˆ˜í•™|ê³¼í•™/i, 'education'],
        [/ëŒ€í•™êµ|ëŒ€í•™ì›|í•™êµ|ë“±ë¡ê¸ˆ/i, 'education'],
        [/í´ë˜ìŠ¤101|íƒˆì‰|ìˆ¨ê³ |í¬ëª½|ì¸í”„ëŸ°|íŒ¨ìŠ¤íŠ¸ìº í¼ìŠ¤|ì½”ë“œì‡/i, 'education'],
        [/êµë³´ë¬¸ê³ |ì˜í’ë¬¸ê³ |YES24|ì•Œë¼ë”˜|ë°˜ë””ì•¤ë£¨ë‹ˆìŠ¤|ì„œì |ë„ì„œ/i, 'education'],

        // ê³µê³¼ê¸ˆ - í†µì‹ , ì „ê¸°, ê°€ìŠ¤
        [/SKT|KT|LGìœ í”ŒëŸ¬ìŠ¤|ì•Œëœ°í°|í†µì‹ ìš”ê¸ˆ|í•¸ë“œí°|íœ´ëŒ€í°/i, 'utility'],
        [/í•œêµ­ì „ë ¥|ì „ê¸°ìš”ê¸ˆ|ì „ê¸°ì„¸|KEPCO/i, 'utility'],
        [/ë„ì‹œê°€ìŠ¤|ê°€ìŠ¤ìš”ê¸ˆ|ê°€ìŠ¤ë¹„/i, 'utility'],
        [/ìˆ˜ë„ìš”ê¸ˆ|ìƒí•˜ìˆ˜ë„/i, 'utility'],
        [/ì•„íŒŒíŠ¸ê´€ë¦¬ë¹„|ê´€ë¦¬ë¹„|ê³µë™ì£¼íƒ/i, 'utility'],
        [/ì¸í„°ë„·|IPTV|ì¼€ì´ë¸”TV/i, 'utility'],

        // ìƒí’ˆê¶Œ
        [/ìƒí’ˆê¶Œ|ê¸°í”„íŠ¸ì¹´ë“œ|ê¸°í”„í‹°ì½˜|ë¬¸í™”ìƒí’ˆê¶Œ|ë„ì„œìƒí’ˆê¶Œ|ë°±í™”ì ìƒí’ˆê¶Œ|ì‹ ì„¸ê³„ìƒí’ˆê¶Œ|ë¡¯ë°ìƒí’ˆê¶Œ/i, 'giftcard'],
        [/í•´í”¼ë¨¸ë‹ˆ|ì»¬ì³ëœë“œ|ë¶ì•¤ë¼ì´í”„/i, 'giftcard']
      ];

      for (const [pattern, category] of catPatterns) {
        if (pattern.test(text)) {
          cat = category;
          break;
        }
      }

      return { id: uid(), date, store, card, cat, amt, split: { members: { me: amt } } };
    }

    function confirmParse() {
      const k = key(state.year, state.month);
      if (!state.data[k]) state.data[k] = [];
      parsedTx.forEach(t => state.data[k].unshift(t));
      save();
      
      document.getElementById('quickInput').value = '';
      document.getElementById('parseResult').innerHTML = '';
      parsedTx = [];
      render();
    }

    function cancelParse() {
      parsedTx = [];
      document.getElementById('parseResult').innerHTML = '';
    }

    // ===== ì§ì ‘ ì…ë ¥ =====
    function addManual() {
      const store = document.getElementById('mStore').value.trim();
      const amt = parseInt(document.getElementById('mAmount').value);
      const dateVal = document.getElementById('mDate').value;
      const card = document.getElementById('mCard').value;
      const cat = document.getElementById('mCategory').value;

      if (!store) { alert('ê°€ë§¹ì ëª… ì…ë ¥'); return; }
      if (!amt || amt <= 0) { alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ ì…ë ¥'); return; }

      const d = new Date(dateVal);
      const y = d.getFullYear(), m = d.getMonth() + 1;
      if (y < START_YEAR) { alert(`${START_YEAR}ë…„ ì´ì „ì€ ì…ë ¥ ë¶ˆê°€`); return; }

      const dateStr = String(m).padStart(2, '0') + '/' + String(d.getDate()).padStart(2, '0');
      const tx = { id: uid(), date: dateStr, store, card, cat, amt, split: { members: { me: amt } } };

      const k = key(y, m);
      if (!state.data[k]) state.data[k] = [];
      state.data[k].unshift(tx);
      save();

      state.year = y;
      state.month = m;
      document.getElementById('mStore').value = '';
      document.getElementById('mAmount').value = '';
      render();
    }

    // ===== ì—°ê°„ ë·° =====
    function renderYearly() {
      let yTotal = 0, yMy = 0, yGift = 0;
      const monthlyStats = [];
      const yCatTotals = {};

      for (let m = 1; m <= 12; m++) {
        const tx = state.data[key(state.year, m)] || [];
        let total = 0, my = 0, gift = 0;
        tx.forEach(t => {
          total += t.amt;
          if (t.cat === 'giftcard') gift += t.amt;
          else yCatTotals[t.cat] = (yCatTotals[t.cat] || 0) + t.amt;
          if (t.split?.members) my += t.split.members.me || 0;
        });
        monthlyStats.push({ m, total, my, gift });
        yTotal += total; yMy += my; yGift += gift;
      }

      document.getElementById('yTotalAmt').textContent = fmtShort(yTotal) + 'ì›';
      document.getElementById('yMyAmt').textContent = fmtShort(yMy) + 'ì›';
      document.getElementById('yGiftAmt').textContent = fmtShort(yGift) + 'ì›';

      const withData = monthlyStats.filter(s => s.total > 0).length || 1;
      const living = yTotal - yGift;
      document.getElementById('avgTotal').textContent = fmtShort(Math.round(yTotal / withData)) + 'ì›';
      document.getElementById('avgLiving').textContent = fmtShort(Math.round(living / withData)) + 'ì›';
      document.getElementById('avgMy').textContent = fmtShort(Math.round(yMy / withData)) + 'ì›';

      renderYearlyCatChart(yCatTotals);
      renderYearlyBarChart(monthlyStats);
      renderMonthlyBars(monthlyStats);
    }

    function renderYearlyCatChart(data) {
      const ctx = document.getElementById('yearlyCatChart');
      if (state.charts.yearlyCat) state.charts.yearlyCat.destroy();

      const cats = Object.keys(data).filter(k => data[k] > 0);

      if (cats.length === 0) {
        state.charts.yearlyCat = new Chart(ctx, {
          type: 'doughnut',
          data: { labels: ['ë°ì´í„° ì—†ìŒ'], datasets: [{ data: [1], backgroundColor: ['#E5E7EB'] }] },
          options: { cutout: '65%', plugins: { legend: { display: false }, datalabels: { display: false } } }
        });
        return;
      }

      const total = cats.reduce((sum, c) => sum + data[c], 0);

      state.charts.yearlyCat = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: cats.map(c => CATEGORIES[c]?.name || c),
          datasets: [{
            data: cats.map(c => data[c]),
            backgroundColor: cats.map(c => CATEGORIES[c]?.color)
          }]
        },
        plugins: [ChartDataLabels],
        options: {
          cutout: '55%',
          maintainAspectRatio: false,
          layout: {
            padding: { right: 10 }
          },
          plugins: {
            legend: {
              position: 'right',
              align: 'center',
              labels: {
                boxWidth: 12,
                padding: 6,
                font: { size: 10 },
                generateLabels: function(chart) {
                  const data = chart.data;
                  return data.labels.map((label, i) => {
                    const value = data.datasets[0].data[i];
                    const percent = ((value / total) * 100).toFixed(0);
                    return {
                      text: `${label} ${percent}%`,
                      fillStyle: data.datasets[0].backgroundColor[i],
                      strokeStyle: data.datasets[0].backgroundColor[i],
                      lineWidth: 0,
                      index: i
                    };
                  });
                }
              }
            },
            datalabels: {
              color: '#fff',
              font: { weight: 'bold', size: 10 },
              formatter: (value, context) => {
                const percent = ((value / total) * 100).toFixed(0);
                return percent >= 8 ? fmtShort(value) : '';
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const percent = ((value / total) * 100).toFixed(1);
                  return `${context.label}: ${fmt(value)}ì› (${percent}%)`;
                }
              }
            }
          }
        }
      });
    }

    function renderYearlyBarChart(stats) {
      const ctx = document.getElementById('yearlyBarChart');
      if (state.charts.yearlyBar) state.charts.yearlyBar.destroy();

      state.charts.yearlyBar = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: stats.map(s => s.m + 'ì›”'),
          datasets: [
            { label: 'ìƒí™œë¹„', data: stats.map(s => s.total - s.gift), backgroundColor: '#6366F1', borderRadius: 4 },
            { label: 'ìƒí’ˆê¶Œ', data: stats.map(s => s.gift), backgroundColor: '#F59E0B', borderRadius: 4 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } },
          scales: { x: { stacked: true }, y: { stacked: true, ticks: { callback: v => fmtShort(v) } } }
        }
      });
    }

    function renderMonthlyBars(stats) {
      const max = Math.max(...stats.map(s => s.total), 1);
      document.getElementById('monthlyBars').innerHTML = stats.map(s => `
        <div class="month-bar-item" onclick="goMonth(${s.m})">
          <span class="month-bar-label">${s.m}ì›”</span>
          <div class="month-bar-track">
            <div class="month-bar-fill living" style="width:${(s.total/max)*100}%"></div>
          </div>
          <span class="month-bar-value">${s.total ? fmtShort(s.total) + 'ì›' : '-'}</span>
        </div>`).join('');
    }

    function goMonth(m) {
      state.month = m;
      switchView('monthly');
    }

    // ===== ë§ˆì¼ ê³„ì‚°ê¸° =====
    function openMileModal() {
      document.getElementById('mileModal').classList.add('active');
      const gc = getTx().filter(t => t.cat === 'giftcard').reduce((s, t) => s + t.amt, 0);
      document.getElementById('mileGiftTotal').textContent = fmt(gc) + 'ì›';
      
      const k = key(state.year, state.month);
      const s = state.mileData[k] || {};
      document.getElementById('mileCash').value = s.cash || '';
      document.getElementById('mileFee').value = s.fee || '';
      document.getElementById('mileBenefit').value = s.benefit || '';
      document.getElementById('mileMile').value = s.mile || '';
      calcMile();
    }

    function closeMileModal() {
      const k = key(state.year, state.month);
      state.mileData[k] = {
        cash: parseInt(document.getElementById('mileCash').value) || 0,
        fee: parseInt(document.getElementById('mileFee').value) || 0,
        benefit: parseInt(document.getElementById('mileBenefit').value) || 0,
        mile: parseInt(document.getElementById('mileMile').value) || 0
      };
      save();
      document.getElementById('mileModal').classList.remove('active');
    }

    function calcMile() {
      const gc = getTx().filter(t => t.cat === 'giftcard').reduce((s, t) => s + t.amt, 0);
      const cash = parseInt(document.getElementById('mileCash').value) || 0;
      const fee = parseInt(document.getElementById('mileFee').value) || 0;
      const benefit = parseInt(document.getElementById('mileBenefit').value) || 0;
      const mile = parseInt(document.getElementById('mileMile').value) || 0;
      const actual = gc - cash + fee - benefit;

      document.getElementById('rPurchase').textContent = fmt(gc) + 'ì›';
      document.getElementById('rCash').textContent = fmt(cash) + 'ì›';
      document.getElementById('rFee').textContent = fmt(fee) + 'ì›';
      document.getElementById('rBenefit').textContent = fmt(benefit) + 'ì›';
      document.getElementById('rActual').textContent = fmt(actual) + 'ì›';
      document.getElementById('rPerMile').textContent = mile > 0 && actual > 0 
        ? (actual / mile).toFixed(1) + ' ì›/ë§ˆì¼'
        : mile > 0 && actual <= 0 ? 'ë¬´ë£Œ! ğŸ‰' : '- ì›/ë§ˆì¼';
    }

    function openYearlyMileModal() {
      document.getElementById('yearlyMileModal').classList.add('active');
      document.getElementById('yMileTitle').textContent = `âœˆï¸ ${state.year}ë…„ ì—°ê°„ ë§ˆì¼ë‹¨ê°€`;
      
      let yGc = 0, yCash = 0, yMile = 0;
      for (let m = 1; m <= 12; m++) {
        const tx = state.data[key(state.year, m)] || [];
        tx.forEach(t => { if (t.cat === 'giftcard') yGc += t.amt; });
        const md = state.mileData[key(state.year, m)] || {};
        yCash += md.cash || 0;
        yMile += md.mile || 0;
      }

      document.getElementById('yMileGift').textContent = fmt(yGc) + 'ì›';
      document.getElementById('yMileCash').textContent = fmt(yCash) + 'ì›';
      document.getElementById('yMileMile').textContent = fmt(yMile) + ' ë§ˆì¼';

      const s = state.yearlyMileData[state.year] || {};
      document.getElementById('yFee').value = s.fee || '';
      document.getElementById('yBenefit').value = s.benefit || '';
      calcYearlyMile();
    }

    function closeYearlyMileModal() {
      state.yearlyMileData[state.year] = {
        fee: parseInt(document.getElementById('yFee').value) || 0,
        benefit: parseInt(document.getElementById('yBenefit').value) || 0
      };
      save();
      document.getElementById('yearlyMileModal').classList.remove('active');
    }

    function calcYearlyMile() {
      let yGc = 0, yCash = 0, yMile = 0;
      for (let m = 1; m <= 12; m++) {
        const tx = state.data[key(state.year, m)] || [];
        tx.forEach(t => { if (t.cat === 'giftcard') yGc += t.amt; });
        const md = state.mileData[key(state.year, m)] || {};
        yCash += md.cash || 0;
        yMile += md.mile || 0;
      }
      const fee = parseInt(document.getElementById('yFee').value) || 0;
      const benefit = parseInt(document.getElementById('yBenefit').value) || 0;
      const actual = yGc - yCash + fee - benefit;

      document.getElementById('yrPurchase').textContent = fmt(yGc) + 'ì›';
      document.getElementById('yrCash').textContent = fmt(yCash) + 'ì›';
      document.getElementById('yrFee').textContent = fmt(fee) + 'ì›';
      document.getElementById('yrBenefit').textContent = fmt(benefit) + 'ì›';
      document.getElementById('yrActual').textContent = fmt(actual) + 'ì›';
      document.getElementById('yrPerMile').textContent = yMile > 0 && actual > 0
        ? (actual / yMile).toFixed(1) + ' ì›/ë§ˆì¼'
        : yMile > 0 && actual <= 0 ? 'ë¬´ë£Œ! ğŸ‰' : '- ì›/ë§ˆì¼';
    }

    // ===== ê±°ë˜ ìˆ˜ì •/ì‚­ì œ =====
    function openEditModal(tid) {
      const tx = getTx().find(t => t.id === tid);
      if (!tx) return;

      document.getElementById('editTxId').value = tid;
      document.getElementById('editStore').value = tx.store;
      document.getElementById('editAmount').value = tx.amt;
      document.getElementById('editDate').value = tx.date;
      document.getElementById('editCard').value = tx.card;
      document.getElementById('editCategory').value = tx.cat;

      document.getElementById('editTxModal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editTxModal').classList.remove('active');
    }

    function saveEditTx() {
      const tid = document.getElementById('editTxId').value;
      const store = document.getElementById('editStore').value.trim();
      const amt = parseInt(document.getElementById('editAmount').value);
      const date = document.getElementById('editDate').value.trim();
      const card = document.getElementById('editCard').value;
      const cat = document.getElementById('editCategory').value;

      if (!store) { alert('ê°€ë§¹ì ëª…ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
      if (!amt || amt <= 0) { alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
      if (!/^\d{2}\/\d{2}$/.test(date)) { alert('ë‚ ì§œ í˜•ì‹ì€ MM/DD ì…ë‹ˆë‹¤'); return; }

      const k = key(state.year, state.month);
      const txList = state.data[k] || [];
      const txIdx = txList.findIndex(t => t.id === tid);
      if (txIdx === -1) { alert('ê±°ë˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }

      const oldAmt = txList[txIdx].amt;
      txList[txIdx].store = store;
      txList[txIdx].amt = amt;
      txList[txIdx].date = date;
      txList[txIdx].card = card;
      txList[txIdx].cat = cat;

      // ê¸ˆì•¡ì´ ë³€ê²½ë˜ë©´ ì •ì‚° ì •ë³´ë„ ì—…ë°ì´íŠ¸
      if (oldAmt !== amt && txList[txIdx].split?.members) {
        const members = Object.keys(txList[txIdx].split.members);
        const share = Math.floor(amt / members.length);
        const rem = amt - share * members.length;
        members.forEach((m, i) => {
          txList[txIdx].split.members[m] = share + (i === 0 ? rem : 0);
        });
      }

      save();
      closeEditModal();
      state.expandedId = null;
      render();
      alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    function deleteTx(tid) {
      if (!confirm('ì´ ê±°ë˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      const k = key(state.year, state.month);
      const txList = state.data[k] || [];
      const txIdx = txList.findIndex(t => t.id === tid);
      if (txIdx === -1) return;

      txList.splice(txIdx, 1);
      state.data[k] = txList;
      save();

      state.expandedId = null;
      render();
      alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    // ===== ì„¤ì • ê´€ë ¨ =====
    const DEFAULT_CARDS = [
      'ì‹ í•œì¹´ë“œ', 'ì‚¼ì„±ì¹´ë“œ', 'í˜„ëŒ€ì¹´ë“œ', 'KBêµ­ë¯¼ì¹´ë“œ', 'ë¡¯ë°ì¹´ë“œ',
      'ìš°ë¦¬ì¹´ë“œ', 'í•˜ë‚˜ì¹´ë“œ', 'NHë†í˜‘ì¹´ë“œ', 'BCì¹´ë“œ', 'IBKê¸°ì—…ì€í–‰',
      'ë„¤ì´ë²„í˜ì´', 'ì¹´ì¹´ì˜¤í˜ì´', 'í† ìŠ¤', 'í˜ì´ì½”', 'í˜„ê¸ˆ', 'ê³„ì¢Œì´ì²´'
    ];

    function getCustomCards() {
      return state.customCards || [];
    }

    function getAllCards() {
      return [...DEFAULT_CARDS, ...getCustomCards()];
    }

    function getCardOptions(selected) {
      return getAllCards().map(c => `<option ${c === selected ? 'selected' : ''}>${c}</option>`).join('');
    }

    // ===== ì•„ì´ì½˜ ëª¨ë‹¬ =====
    function openIconModal() {
      document.getElementById('iconModal').classList.add('active');
      document.getElementById('iconInput').value = state.logoIcon || 'ê°€';
      document.getElementById('iconPreview').textContent = state.logoIcon || 'ê°€';
    }

    function closeIconModal() {
      document.getElementById('iconModal').classList.remove('active');
    }

    function saveIcon() {
      const icon = document.getElementById('iconInput').value.trim() || 'ê°€';
      state.logoIcon = icon;
      document.getElementById('logoIcon').textContent = icon;
      save();
      closeIconModal();
    }

    // ===== ì„¤ì • ëª¨ë‹¬ =====
    function openSettingsModal() {
      document.getElementById('settingsModal').classList.add('active');
      renderCustomCardList();
    }

    function closeSettingsModal() {
      document.getElementById('settingsModal').classList.remove('active');
    }

    function renderCustomCardList() {
      const cards = getCustomCards();
      const list = document.getElementById('customCardList');
      if (cards.length === 0) {
        list.innerHTML = '<div style="color:var(--text-muted); font-size:13px; padding:8px;">ì»¤ìŠ¤í…€ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }
      list.innerHTML = cards.map(c => `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 12px; background:var(--bg); border-radius:8px; margin-bottom:6px;">
          <span style="font-size:14px;">${c}</span>
          <button onclick="removeCustomCard('${c}')" style="background:var(--danger-light); color:var(--danger); border:none; border-radius:6px; padding:4px 8px; cursor:pointer; font-size:12px;">ì‚­ì œ</button>
        </div>
      `).join('');
    }

    function addCustomCard() {
      const input = document.getElementById('newCardName');
      const name = input.value.trim();
      if (!name) { alert('ì¹´ë“œëª…ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
      if (getAllCards().includes(name)) { alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¹´ë“œì…ë‹ˆë‹¤'); return; }

      if (!state.customCards) state.customCards = [];
      state.customCards.push(name);
      save();
      input.value = '';
      renderCustomCardList();
      updateCardSelects();
    }

    function removeCustomCard(name) {
      if (!state.customCards) return;
      state.customCards = state.customCards.filter(c => c !== name);
      save();
      renderCustomCardList();
      updateCardSelects();
    }

    function updateCardSelects() {
      // ì§ì ‘ ì…ë ¥ í¼ì˜ ì¹´ë“œ ì…€ë ‰íŠ¸ ì—…ë°ì´íŠ¸
      const mCard = document.getElementById('mCard');
      const editCard = document.getElementById('editCard');
      const currentMCard = mCard?.value;
      const currentEditCard = editCard?.value;

      if (mCard) {
        mCard.innerHTML = getCardOptions(currentMCard);
      }
      if (editCard) {
        editCard.innerHTML = getCardOptions(currentEditCard);
      }
    }

    // ===== ê°€ì¡± ì§€ì¶œ í•„í„°ë§ =====
    function filterByFamily() {
      state.filter = 'family';
      document.getElementById('filterBadge').classList.add('active');
      document.getElementById('filterText').textContent = 'ê°€ì¡± ì§€ì¶œ í•„í„°';
      renderTxList(getTx());
    }

    // ===== ì¹´í…Œê³ ë¦¬/ì¹´ë“œ ì¦‰ì‹œ ìˆ˜ì • =====
    function updateTxCategory(tid, cat) {
      const tx = getTx().find(t => t.id === tid);
      if (!tx) return;
      tx.cat = cat;
      save();
      render();
    }

    function updateTxCard(tid, card) {
      const tx = getTx().find(t => t.id === tid);
      if (!tx) return;
      tx.card = card;
      save();
      render();
    }

    // ===== ë‹¤í¬ëª¨ë“œ =====
    function toggleTheme() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const newTheme = isDark ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      document.getElementById('themeToggle').textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
      state.theme = newTheme;
      save();

      // ì°¨íŠ¸ ë‹¤ì‹œ ë Œë”ë§ (ìƒ‰ìƒ ì—…ë°ì´íŠ¸)
      render();
    }

    function applyTheme() {
      const theme = state.theme || 'light';
      document.documentElement.setAttribute('data-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    // ===== ë°ì´í„° ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° =====
    function exportData() {
      const exportObj = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        data: state.data,
        mileData: state.mileData,
        yearlyMileData: state.yearlyMileData,
        customCards: state.customCards,
        logoIcon: state.logoIcon,
        theme: state.theme
      };

      const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ê°€ê³„ë¶€_ë°±ì—…_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      alert('ë°ì´í„°ê°€ ë‚´ë³´ë‚´ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importObj = JSON.parse(e.target.result);

          if (!importObj.data) {
            alert('ìœ íš¨í•˜ì§€ ì•Šì€ ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤.');
            return;
          }

          if (!confirm('ê¸°ì¡´ ë°ì´í„°ë¥¼ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?\n(í˜„ì¬ ë°ì´í„°ê°€ ëª¨ë‘ êµì²´ë©ë‹ˆë‹¤)')) {
            return;
          }

          state.data = importObj.data || {};
          state.mileData = importObj.mileData || {};
          state.yearlyMileData = importObj.yearlyMileData || {};
          state.customCards = importObj.customCards || [];
          state.logoIcon = importObj.logoIcon || 'ê°€';
          state.theme = importObj.theme || 'light';

          save();
          document.getElementById('logoIcon').textContent = state.logoIcon;
          applyTheme();
          updateCardSelects();
          render();

          alert('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!');
          closeSettingsModal();
        } catch (err) {
          alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }
  </script>
</body>
</html>
