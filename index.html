<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>가계부</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#5b6cff" />

  <!-- Chart.js (GitHub Pages 안전 CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Style -->
  <link rel="stylesheet" href="style.css" />
</head>

<body>
<header class="top">
  <div class="period">
    <button id="prevBtn">◀</button>
    <strong id="periodText">2026년 1월</strong>
    <button id="nextBtn">▶</button>
  </div>

  <div class="view-toggle">
    <button id="monthlyBtn" class="active">월별</button>
    <button id="yearlyBtn">연간</button>
  </div>
</header>

<main class="container">

  <!-- 설정 -->
  <section class="card">
    <h3>설정</h3>
    <label class="toggle">
      <input type="checkbox" id="darkToggle" />
      <span>다크모드</span>
    </label>
  </section>

  <!-- 지출 입력 -->
  <section class="card">
    <h3>지출 입력</h3>
    <input id="amount" type="number" placeholder="금액" />
    <select id="category"></select>
    <input id="memo" placeholder="메모" />
    <button id="addBtn">추가</button>
  </section>

  <!-- 통계 -->
  <section class="card">
    <h3>통계</h3>
    <canvas id="chart" height="260"></canvas>
  </section>

  <!-- 내역 -->
  <section class="card">
    <h3>내역</h3>
    <ul id="list"></ul>
  </section>

</main>

<script>
/* ======================
   STATE
====================== */
const state = {
  year: 2026,
  month: 1,
  view: 'monthly',
  dark: localStorage.getItem('dark') === 'true',
  categories: [
    { key:'food', label:'식비', color:'#ff7675' },
    { key:'transport', label:'교통', color:'#74b9ff' },
    { key:'shopping', label:'쇼핑', color:'#55efc4' },
    { key:'etc', label:'기타', color:'#a29bfe' }
  ],
  expenses: JSON.parse(localStorage.getItem('expenses') || '[]')
};

/* ======================
   ELEMENTS
====================== */
const periodText = document.getElementById('periodText');
const categoryEl = document.getElementById('category');
const listEl = document.getElementById('list');
const darkToggle = document.getElementById('darkToggle');

let chart;

/* ======================
   INIT
====================== */
function init(){
  darkToggle.checked = state.dark;
  document.documentElement.classList.toggle('dark', state.dark);

  categoryEl.innerHTML = state.categories
    .map(c => `<option value="${c.key}">${c.label}</option>`)
    .join('');

  render();
}
init();

/* ======================
   RENDER
====================== */
function render(){
  periodText.textContent =
    state.view === 'monthly'
      ? `${state.year}년 ${state.month}월`
      : `${state.year}년`;

  const filtered = state.expenses.filter(e =>
    state.view === 'monthly'
      ? e.year === state.year && e.month === state.month
      : e.year === state.year
  );

  // list
  listEl.innerHTML = '';
  filtered.forEach(e => {
    const cat = state.categories.find(c => c.key === e.category);
    listEl.innerHTML += `
      <li>
        <span>${e.memo || ''}</span>
        <strong style="color:${cat.color}">
          ${e.amount.toLocaleString()}원
        </strong>
      </li>
    `;
  });

  // chart
  const sum = {};
  state.categories.forEach(c => sum[c.key] = 0);
  filtered.forEach(e => sum[e.category] += e.amount);

  if(chart) chart.destroy();
  chart = new Chart(document.getElementById('chart'), {
    type: 'pie',
    data: {
      labels: state.categories.map(c => c.label),
      datasets: [{
        data: state.categories.map(c => sum[c.key]),
        backgroundColor: state.categories.map(c => c.color)
      }]
    },
    options: {
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
}

/* ======================
   EVENTS
====================== */
document.getElementById('prevBtn').onclick = () => {
  if(state.view === 'monthly'){
    state.month--;
    if(state.month === 0){ state.month = 12; state.year--; }
  } else {
    state.year--;
  }
  render();
};

document.getElementById('nextBtn').onclick = () => {
  if(state.view === 'monthly'){
    state.month++;
    if(state.month === 13){ state.month = 1; state.year++; }
  } else {
    state.year++;
  }
  render();
};

document.getElementById('monthlyBtn').onclick = () => {
  state.view = 'monthly';
  render();
};

document.getElementById('yearlyBtn').onclick = () => {
  state.view = 'yearly';
  render();
};

document.getElementById('addBtn').onclick = () => {
  const amount = Number(amount.value);
  if(!amount) return;

  state.expenses.push({
    amount,
    category: categoryEl.value,
    memo: memo.value,
    year: state.year,
    month: state.month
  });

  localStorage.setItem('expenses', JSON.stringify(state.expenses));
  amount.value = '';
  memo.value = '';
  render();
};

darkToggle.onchange = () => {
  state.dark = darkToggle.checked;
  localStorage.setItem('dark', state.dark);
  document.documentElement.classList.toggle('dark', state.dark);
};

/* ======================
   SERVICE WORKER
====================== */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js');
}
</script>

</body>
</html>
