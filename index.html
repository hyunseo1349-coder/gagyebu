<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Ledger 2026 Pro - íŒŒì¼ ì—…ë¡œë“œ ì§€ì›</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ ë° ì—…ë¡œë“œ ì˜ì—­ ì¶”ê°€ */
    :root { --primary: #6366F1; --bg: #F9FAFB; --danger: #EF4444; --success: #10B981; --accent: #F59E0B; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); color: #1F2937; }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: white; border-bottom: 1px solid #E5E7EB; position: sticky; top: 0; z-index: 100; }
    .view-toggle { display: flex; background: #F3F4F6; padding: 4px; border-radius: 12px; }
    .view-toggle button { padding: 8px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; background: transparent; transition: 0.2s; font-size: 13px; }
    .view-toggle button.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .main { max-width: 1000px; margin: 0 auto; padding: 20px; }
    
    .period-nav { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 24px; background: white; padding: 16px; border-radius: 20px; }
    .nav-btn { width: 36px; height: 36px; border: 1px solid #E5E7EB; background: white; border-radius: 50%; cursor: pointer; }
    .current-period { font-weight: 800; font-size: 18px; color: var(--primary); min-width: 120px; text-align: center; }

    .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
    .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: white; padding: 20px; border-radius: 24px; border: 1px solid #E5E7EB; }
    .card-label { font-size: 12px; color: #6B7280; display: block; margin-bottom: 6px; }
    .card-value { font-size: 18px; font-weight: 800; }
    .chart-card { background: white; padding: 20px; border-radius: 24px; border: 1px solid #E5E7EB; display: flex; flex-direction: column; align-items: center; }

    /* íŒŒì¼ ì—…ë¡œë“œ/í…ìŠ¤íŠ¸ ì…ë ¥ ì „í™˜ */
    .input-methods { background: white; border-radius: 24px; padding: 24px; border: 1px solid #E5E7EB; margin-bottom: 30px; }
    .input-tabs { display: flex; gap: 15px; margin-bottom: 15px; border-bottom: 1px solid #F3F4F6; padding-bottom: 10px; }
    .input-tab { cursor: pointer; font-size: 14px; font-weight: 600; color: #9CA3AF; }
    .input-tab.active { color: var(--primary); }
    textarea { width: 100%; height: 80px; padding: 15px; border-radius: 12px; border: 1px solid #E5E7EB; background: #F9FAFB; resize: none; margin-bottom: 12px; }
    .file-input-wrapper { border: 2px dashed #E5E7EB; padding: 30px; border-radius: 12px; text-align: center; background: #F9FAFB; }
    
    .transaction-item { background: white; padding: 16px; border-radius: 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #F3F4F6; cursor: pointer; }
    .tag { font-size: 10px; padding: 2px 8px; border-radius: 6px; font-weight: 700; margin-right: 6px; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
    .modal-overlay.active { display: flex; }
    .modal { background: white; border-radius: 24px; width: 95%; max-width: 450px; padding: 28px; }
    .split-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .split-input { width: 100px; padding: 6px; border: 1px solid #DDD; border-radius: 6px; text-align: right; }
    select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #E5E7EB; margin-bottom: 15px; }
    .btn { padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; }
    .btn-primary { background: var(--primary); color: white; width: 100%; }
  </style>
</head>
<body>

  <header class="header">
    <div style="font-weight: 900; color: var(--primary); font-size: 20px;">Smart Ledger Pro</div>
    <div class="view-toggle">
      <button id="btn-monthly" class="active" onclick="setView('monthly')">ì›”ê°„</button>
      <button id="btn-yearly" onclick="setView('yearly')">ì—°ê°„</button>
    </div>
  </header>

  <main class="main">
    <div class="period-nav">
      <button class="nav-btn" onclick="changePeriod(-1)">â—€</button>
      <span class="current-period" id="periodDisplay">2026ë…„ 1ì›”</span>
      <button class="nav-btn" onclick="changePeriod(1)">â–¶</button>
    </div>

    <div class="dashboard-grid">
      <div class="summary-grid">
        <div class="card"><span class="card-label">ì´ ì§€ì¶œ</span><span class="card-value" id="stat-total">0ì›</span></div>
        <div class="card" style="border-left: 4px solid var(--success);"><span class="card-label">ğŸ›’ ë‚´ ì‹¤ì œ ì§€ì¶œ</span><span class="card-value" id="stat-my">0ì›</span></div>
        <div class="card" style="border-left: 4px solid var(--primary);"><span class="card-label">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ê°€ì¡±/íƒ€ì¸ ì§€ë¶„</span><span class="card-value" id="stat-family">0ì›</span></div>
        <div class="card" style="border-left: 4px solid var(--accent);"><span class="card-label">ğŸ« ìƒí’ˆê¶Œ (ìƒí…Œí¬)</span><span class="card-value" id="stat-gc">0ì›</span></div>
      </div>
      <div class="chart-card">
        <canvas id="categoryChart"></canvas>
      </div>
    </div>

    <div class="input-methods">
      <div class="input-tabs">
        <span class="input-tab active" id="tab-text" onclick="toggleInput('text')">í…ìŠ¤íŠ¸ ë³µì‚¬</span>
        <span class="input-tab" id="tab-file" onclick="toggleInput('file')">ì—‘ì…€/CSV íŒŒì¼</span>
      </div>
      
      <div id="text-input-area">
        <textarea id="rawInput" placeholder="ì¹´ë“œ ë‚´ì—­ì„ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
        <button class="btn btn-primary" onclick="parseText()">âœ¨ í…ìŠ¤íŠ¸ íŒŒì‹± ì¶”ê°€</button>
      </div>

      <div id="file-input-area" style="display:none;">
        <div class="file-input-wrapper">
          <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" style="margin-bottom:10px;"><br>
          <span style="font-size:12px; color:#9CA3AF;">ê°€ë§¹ì , ì´ìš©ì¼, ê¸ˆì•¡ ì»¬ëŸ¼ì´ í¬í•¨ëœ íŒŒì¼ì„ ì˜¬ë ¤ì£¼ì„¸ìš”.</span>
        </div>
        <button class="btn btn-primary" style="margin-top:10px;" onclick="handleFileUpload()">ğŸ“ íŒŒì¼ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>

    <div id="listArea"></div>
  </main>

  <div class="modal-overlay" id="splitModal">
    <div class="modal">
      <h3 id="splitTitle" style="margin-bottom:15px;">í•­ëª© ìƒì„¸ ì„¤ì •</h3>
      <select id="editCategory">
        <option value="food">ì‹ë¹„</option>
        <option value="transport">êµí†µ</option>
        <option value="shopping">ì‡¼í•‘</option>
        <option value="living">ìƒí™œ</option>
        <option value="medical">ì˜ë£Œ</option>
        <option value="etc">ê¸°íƒ€</option>
        <option value="giftcard">ìƒí’ˆê¶Œ</option>
      </select>
      <div id="splitList"></div>
      <div id="splitValidate" style="text-align:right; font-size:12px; margin-top:10px; font-weight:700;"></div>
      <button class="btn btn-primary" style="margin-top:20px" onclick="saveSettlement()">ì €ì¥</button>
    </div>
  </div>

  <script>
    const DATA_KEY = `sl_pro_v3_final`;
    const CAT_MAP = { food: 'ì‹ë¹„', transport: 'êµí†µ', shopping: 'ì‡¼í•‘', living: 'ìƒí™œ', medical: 'ì˜ë£Œ', etc: 'ê¸°íƒ€', giftcard: 'ìƒí’ˆê¶Œ' };
    
    let state = {
      view: 'monthly', year: 2026, month: 1,
      data: JSON.parse(localStorage.getItem(DATA_KEY)) || { transactions: [] },
      currentId: null, chart: null
    };

    function saveData() { localStorage.setItem(DATA_KEY, JSON.stringify(state.data)); }

    function toggleInput(type) {
      document.getElementById('text-input-area').style.display = type === 'text' ? 'block' : 'none';
      document.getElementById('file-input-area').style.display = type === 'file' ? 'block' : 'none';
      document.getElementById('tab-text').classList.toggle('active', type === 'text');
      document.getElementById('tab-file').classList.toggle('active', type === 'file');
    }

    /* ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ í•µì‹¬ ë¡œì§ */
    function handleFileUpload() {
      const fileInput = document.getElementById('excelFile');
      if (!fileInput.files.length) return alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);

        processExcelData(jsonData);
      };
      reader.readAsArrayBuffer(file);
    }

    function processExcelData(rows) {
      let addedCount = 0;
      rows.forEach(row => {
        // ì—‘ì…€ í—¤ë” í‚¤ì›Œë“œ ë§¤ì¹­ (ìœ ì—°í•˜ê²Œ)
        const store = row['ê°€ë§¹ì '] || row['ê°€ë§¹ì ëª…'] || row['ì´ìš©ì²˜'] || row['ë‚´ìš©'];
        const amount = parseInt(row['ê¸ˆì•¡'] || row['ì´ìš©ê¸ˆì•¡'] || row['ê²°ì œê¸ˆì•¡']);
        const dateRaw = row['ì´ìš©ì¼'] || row['ë‚ ì§œ'] || row['ìŠ¹ì¸ì¼ì'];
        const status = row['ìƒíƒœ'] || row['ì²˜ë¦¬ìƒíƒœ'] || "";

        if (store && amount && dateRaw && !status.includes('ì·¨ì†Œ')) {
          let finalDate = formatExcelDate(dateRaw);
          state.data.transactions.push({
            id: Date.now() + Math.random(),
            fullDate: finalDate,
            store,
            amount,
            category: autoCategorize(store),
            split: { me: amount, mom: 0, dad: 0, bro: 0, friend: 0 }
          });
          addedCount++;
        }
      });
      saveData();
      render();
      alert(`${addedCount}ê°œì˜ ë‚´ì—­ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
    }

    function formatExcelDate(d) {
      // ì—‘ì…€ ë‚ ì§œ ìˆ«ì í˜•ì‹ ë˜ëŠ” ë¬¸ìì—´ ì²˜ë¦¬
      if (typeof d === 'number') {
        const date = new Date((d - 25569) * 86400 * 1000);
        return date.toISOString().split('T')[0];
      }
      const s = String(d).replace(/[^0-9]/g, '');
      if (s.length === 8) return `${s.substring(0,4)}-${s.substring(4,6)}-${s.substring(6,8)}`;
      if (s.length === 6) return `20${s.substring(0,2)}-${s.substring(2,4)}-${s.substring(4,6)}`;
      return new Date().toISOString().split('T')[0];
    }

    function autoCategorize(store) {
      if (/ìƒí’ˆê¶Œ|í˜ì´íƒ€ë©|ì¿ í°/.test(store)) return 'giftcard';
      if (/ì‹ë‹¹|ì†Œí˜¸ì •|ì¹´í˜|ìŠ¤íƒ€ë²…ìŠ¤|ì™„ëš|ì‹ì‚¬|ìŒì‹/.test(store)) return 'food';
      if (/íƒì‹œ|ìš°ë²„|ì§€í•˜ì² |êµí†µ/.test(store)) return 'transport';
      if (/ë³‘ì›|ì•½êµ­|ì˜ë£Œ/.test(store)) return 'medical';
      if (/ì¿ íŒ¡|ë„¤ì´ë²„|ì‡¼í•‘|ë§ˆíŠ¸/.test(store)) return 'shopping';
      return 'etc';
    }

    // [ê¸°ì¡´ í…ìŠ¤íŠ¸ íŒŒì‹±, ì •ì‚°, ë Œë”ë§ í•¨ìˆ˜ë“¤ ìœ ì§€...]
    function parseText() {
      // ê¸°ì¡´ í…ìŠ¤íŠ¸ íŒŒì‹± ë¡œì§ ì‹¤í–‰ (ìƒëµ, ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
      const text = document.getElementById('rawInput').value.trim();
      if (!text) return;
      // ... (ê¸°ì¡´ íŒŒì‹± ë¡œì§)
      alert("í…ìŠ¤íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
      render();
    }

    function render() {
      // í†µê³„ ê³„ì‚° ë° ì°¨íŠ¸ ì—…ë°ì´íŠ¸, ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼í•˜ê²Œ ì²˜ë¦¬)
      const filtered = state.data.transactions.filter(t => {
        const d = new Date(t.fullDate);
        return d.getFullYear() === state.year && (state.view === 'yearly' || (d.getMonth()+1) === state.month);
      });
      
      let stats = { total: 0, my: 0, family: 0, gc: 0 };
      let catSums = { food: 0, transport: 0, shopping: 0, living: 0, medical: 0, etc: 0 };

      filtered.forEach(t => {
        stats.total += t.amount;
        if (t.category === 'giftcard') stats.gc += t.amount;
        else {
          const myPart = t.split ? t.split.me : t.amount;
          stats.my += myPart;
          stats.family += (t.amount - myPart);
          catSums[t.category] = (catSums[t.category] || 0) + t.amount;
        }
      });

      document.getElementById('stat-total').textContent = stats.total.toLocaleString() + 'ì›';
      document.getElementById('stat-my').textContent = stats.my.toLocaleString() + 'ì›';
      document.getElementById('stat-family').textContent = stats.family.toLocaleString() + 'ì›';
      document.getElementById('stat-gc').textContent = stats.gc.toLocaleString() + 'ì›';
      
      updateChart(catSums);
      const listArea = document.getElementById('listArea');
      listArea.innerHTML = filtered.sort((a,b) => new Date(b.fullDate)-new Date(a.fullDate)).map(t => `
        <div class="transaction-item" onclick="openSettlement(${t.id})">
          <div><span class="tag">${CAT_MAP[t.category]}</span><strong>${t.store}</strong><div style="font-size:11px;">${t.fullDate}</div></div>
          <div style="text-align:right"><strong>${t.amount.toLocaleString()}ì›</strong></div>
        </div>
      `).join('');
    }

    function updateChart(sums) {
      const ctx = document.getElementById('categoryChart').getContext('2d');
      if (state.chart) state.chart.destroy();
      state.chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(sums).map(k => CAT_MAP[k]),
          datasets: [{ data: Object.values(sums), backgroundColor: ['#6366F1', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#6B7280'] }]
        },
        options: { plugins: { legend: { display: false } } }
      });
    }

    function changePeriod(v) { 
      state.month += v; 
      if(state.month > 12) { state.month=1; state.year++; }
      if(state.month < 1) { state.month=12; state.year--; }
      render(); 
    }
    
    function setView(v) { state.view = v; render(); }
    function openSettlement(id) { /* ê¸°ì¡´ ëª¨ë‹¬ ë¡œì§ */ state.currentId = id; document.getElementById('splitModal').classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    render();
  </script>
</body>
</html>
