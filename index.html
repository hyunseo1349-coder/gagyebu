<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Smart Ledger Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --primary: #6366F1; --bg: #F9FAFB; --danger: #EF4444; --success: #10B981; --gift: #F59E0B; }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Noto Sans KR', sans-serif !important; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); color: #1F2937; padding-bottom: 50px; }
    
    .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: white; border-bottom: 1px solid #E5E7EB; position: sticky; top: 0; z-index: 100; }
    .logo { font-weight: 900; color: var(--primary); font-size: 1.2rem; }

    .main { max-width: 800px; margin: 0 auto; padding: 16px; }

    /* ì›” ì„ íƒê¸° */
    .period-selector { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 24px; }
    .period-text { font-weight: 800; font-size: 18px; }

    /* ìš”ì•½ ì¹´ë“œ */
    .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .card { background: white; padding: 20px; border-radius: 20px; border: 1px solid #E5E7EB; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .card-label { font-size: 12px; color: #6B7280; margin-bottom: 6px; display: block; }
    .card-value { font-size: 18px; font-weight: 800; display: block; }

    /* ì°¨íŠ¸ ì„¹ì…˜ */
    .chart-container { background: white; padding: 20px; border-radius: 24px; border: 1px solid #E5E7EB; margin-bottom: 24px; display: flex; flex-direction: column; align-items: center; }
    #chartWrapper { position: relative; height: 220px; width: 100%; display: flex; justify-content: center; }

    /* ì…ë ¥ íƒ­ */
    .input-box { background: white; border-radius: 24px; padding: 24px; border: 1px solid #E5E7EB; margin-bottom: 24px; }
    .tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 2px solid #F3F4F6; }
    .tab { padding-bottom: 10px; cursor: pointer; font-size: 15px; font-weight: 700; color: #9CA3AF; }
    .tab.active { color: var(--primary); border-bottom: 2px solid var(--primary); }

    textarea { width: 100%; height: 100px; padding: 15px; border-radius: 16px; border: 1px solid #E5E7EB; background: #F9FAFB; font-size: 14px; margin-bottom: 12px; resize: none; outline: none; }
    .manual-form { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .manual-form input, .manual-form select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #E5E7EB; font-size: 14px; background: #F9FAFB; }
    .full { grid-column: span 2; }

    .btn { padding: 14px; border-radius: 14px; border: none; cursor: pointer; font-weight: 800; font-size: 15px; transition: 0.2s; background: white; }
    .btn-primary { background: var(--primary); color: white; width: 100%; }
    .btn-danger { background: #fee2e2; color: var(--danger); width: 100%; }
    .btn-reset { background: #F3F4F6; color: #4B5563; padding: 8px 16px; font-size: 12px; border-radius: 10px; margin-bottom: 15px; }
    .btn-nav { font-size: 18px; color: #4B5563; padding: 0 10px; }

    /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .list-item { background: white; padding: 18px; border-radius: 18px; margin-bottom: 12px; border: 1px solid #F3F4F6; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: transform 0.1s; }
    .list-item:active { transform: scale(0.98); }
    .tag { font-size: 10px; padding: 3px 8px; border-radius: 6px; font-weight: 800; margin-right: 6px; text-transform: uppercase; }
    .tag-food { background: #FFEDD5; color: #EA580C; }
    .tag-shopping { background: #DCFCE7; color: #16A34A; }
    .tag-giftcard { background: #FEF3C7; color: #D97706; }
    .tag-transport { background: #DBEAFE; color: #2563EB; }
    .tag-etc { background: #F3F4F6; color: #4B5563; }
    .item-info { font-size: 11px; color: #9CA3AF; margin-top: 4px; }

    #filterStatus { display: none; justify-content: space-between; align-items: center; margin-bottom: 15px; }

    /* ëª¨ë‹¬ */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: flex-end; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
    .modal-overlay.active { display: flex; }
    .modal { background: white; border-radius: 24px 24px 0 0; width: 100%; max-width: 500px; padding: 24px; padding-bottom: 40px; animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  </style>
</head>
<body>

  <header class="header">
    <div class="logo">Smart Ledger Pro</div>
    <div style="font-size: 13px; font-weight: 700; background: #EEF2FF; color: var(--primary); padding: 5px 12px; border-radius: 10px;">2026 Edition</div>
  </header>

  <main class="main">
    <div class="period-selector">
      <button class="btn btn-nav" onclick="changePeriod(-1)">â—€</button>
      <span class="period-text" id="periodDisplay">2026ë…„ 1ì›”</span>
      <button class="btn btn-nav" onclick="changePeriod(1)">â–¶</button>
    </div>

    <div class="dashboard">
      <div class="card"><span class="card-label">ì „ì²´ ì´ ì§€ì¶œ</span><span class="card-value" id="total-amt">0ì›</span></div>
      <div class="card" style="border-left: 4px solid var(--success);"><span class="card-label">ë‚´ ì‹¤ì œ ì§€ì¶œ (ìƒí…Œí¬ ì œì™¸)</span><span class="card-value" id="real-amt">0ì›</span></div>
      <div class="card" style="border-left: 4px solid var(--gift);"><span class="card-label">ìƒí’ˆê¶Œ (ìƒí…Œí¬)</span><span class="card-value" id="gift-amt">0ì›</span></div>
    </div>

    <div class="chart-container">
      <div id="chartWrapper">
        <canvas id="mainChart"></canvas>
      </div>
      <p style="font-size: 11px; color: #9CA3AF; margin-top: 15px;">ì°¨íŠ¸ ì¡°ê° í´ë¦­ ì‹œ í•´ë‹¹ ë‚´ì—­ë§Œ í•„í„°ë§ë©ë‹ˆë‹¤.</p>
    </div>

    <div id="filterStatus">
      <span id="filterName" style="font-weight: 800; color: var(--primary); font-size: 14px;"></span>
      <button class="btn btn-reset" onclick="clearFilter()">âœ• ì „ì²´ ë³´ê¸° (í•„í„° í•´ì œ)</button>
    </div>

    <div class="input-box">
      <div class="tabs">
        <div class="tab active" id="tab-auto" onclick="setTab('auto')">ìë™ ì…ë ¥</div>
        <div class="tab" id="tab-manual" onclick="setTab('manual')">ìˆ˜ë™ ì…ë ¥</div>
      </div>

      <div id="view-auto">
        <textarea id="autoInput" placeholder="ì¹´ë“œ ê²°ì œ ë‚´ì—­ì„ ë¶™ì—¬ë„£ê±°ë‚˜ ì—…ë¡œë“œí•˜ì„¸ìš”..."></textarea>
        <button class="btn btn-primary" onclick="processAuto()">âœ¨ ìë™ íŒŒì‹± ë° ì¶”ê°€</button>
      </div>

      <div id="view-manual" style="display:none;">
        <div class="manual-form">
          <input type="text" id="mStore" placeholder="ê°€ë§¹ì  ëª…ì¹­" class="full">
          <input type="number" id="mAmt" placeholder="ê²°ì œ ê¸ˆì•¡">
          <input type="date" id="mDate">
          <select id="mCard">
            <option value="í˜„ëŒ€ì¹´ë“œ">í˜„ëŒ€ì¹´ë“œ</option>
            <option value="ëŒ€í•œí•­ê³µì¹´ë“œ 150">ëŒ€í•œí•­ê³µì¹´ë“œ 150</option>
            <option value="ì•„ë©•ìŠ¤ ê·¸ë¦°">ì•„ë©•ìŠ¤ ê·¸ë¦°</option>
            <option value="í˜„ê¸ˆ">í˜„ê¸ˆ/ì´ì²´</option>
          </select>
          <select id="mCat" class="full">
            <option value="food">ì‹ë¹„</option>
            <option value="shopping">ì‡¼í•‘</option>
            <option value="giftcard">ìƒí’ˆê¶Œ(ìƒí…Œí¬)</option>
            <option value="transport">êµí†µ</option>
            <option value="etc">ê¸°íƒ€</option>
          </select>
          <button class="btn btn-primary full" onclick="processManual()">â• ë‚´ì—­ ì €ì¥í•˜ê¸°</button>
        </div>
      </div>
    </div>

    <div id="listArea"></div>
  </main>

  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h3 style="margin-bottom:20px;">ë‚´ì—­ ìˆ˜ì •</h3>
      <div class="manual-form">
        <input type="text" id="eStore" class="full" placeholder="ê°€ë§¹ì ">
        <input type="number" id="eAmt" class="full" placeholder="ê¸ˆì•¡">
        <select id="eCat" class="full">
          <option value="food">ì‹ë¹„</option>
          <option value="shopping">ì‡¼í•‘</option>
          <option value="giftcard">ìƒí’ˆê¶Œ(ìƒí…Œí¬)</option>
          <option value="transport">êµí†µ</option>
          <option value="etc">ê¸°íƒ€</option>
        </select>
        <button class="btn btn-primary" onclick="saveEdit()">ìˆ˜ì • ì™„ë£Œ</button>
        <button class="btn btn-danger" onclick="deleteItem()">ì‚­ì œí•˜ê¸°</button>
      </div>
      <button class="btn btn-reset" style="width:100%; margin-top:10px;" onclick="closeModal()">ì·¨ì†Œ</button>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'sl_pro_final_v12';
    const CAT_LABELS = { food: 'ì‹ë¹„', shopping: 'ì‡¼í•‘', giftcard: 'ìƒí’ˆê¶Œ', transport: 'êµí†µ', etc: 'ê¸°íƒ€' };
    
    let state = { 
      list: JSON.parse(localStorage.getItem(STORAGE_KEY)) || [], 
      year: 2026, 
      month: 1, 
      filter: null, 
      chart: null, 
      editId: null 
    };

    // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë³¸ ì„¤ì •
    document.getElementById('mDate').valueAsDate = new Date();

    function setTab(t) {
      document.getElementById('view-auto').style.display = t === 'auto' ? 'block' : 'none';
      document.getElementById('view-manual').style.display = t === 'manual' ? 'block' : 'none';
      document.getElementById('tab-auto').classList.toggle('active', t === 'auto');
      document.getElementById('tab-manual').classList.toggle('active', t === 'manual');
    }

    function changePeriod(v) {
      state.month += v;
      if(state.month > 12) { state.month = 1; state.year++; }
      if(state.month < 1) { state.month = 12; state.year--; }
      render();
    }

    // ğŸŒŸ í•µì‹¬ ìˆ˜ì •: ìë™ íŒŒì‹± ë¡œì§ ê°œì„  ğŸŒŸ
    function processAuto() {
      const raw = document.getElementById('autoInput').value.trim();
      if (!raw) return;
      const lines = raw.split('\n').map(l => l.trim()).filter(l => l !== "");
      
      const todayStr = new Date().toISOString().split('T')[0];

      lines.forEach((line, i) => {
        // "ì›"ìœ¼ë¡œ ëë‚˜ëŠ” ê¸ˆì•¡ì¤„ ì°¾ê¸° (ì•µì»¤)
        if (line.endsWith('ì›') && /^[0-9,]+ì›$/.test(line)) {
          const amt = parseInt(line.replace(/[^0-9]/g, ''));
          let store = "ì•Œ ìˆ˜ ì—†ëŠ” ê°€ë§¹ì ";
          let card = "í˜„ëŒ€ì¹´ë“œ";
          let date = todayStr; // ê¸°ë³¸ê°’: ì˜¤ëŠ˜

          // ê¸ˆì•¡ ì¤„ ê¸°ì¤€ ìœ„ìª½ìœ¼ë¡œ 12ì¤„ê¹Œì§€ ì—­íƒìƒ‰
          let foundDate = false;
          for(let j=i-1; j >= 0 && j > i-12; j--){
            const l = lines[j];
            
            // 1. ë‚ ì§œ ì°¾ê¸°
            if (!foundDate) {
                if (l === "ì˜¤ëŠ˜") {
                    date = todayStr;
                    foundDate = true;
                } else if (/\d{1,2}[\.\/]\s*\d{1,2}/.test(l)) {
                    const m = l.match(/(\d{1,2})[\.\/]\s*(\d{1,2})/);
                    if(m) {
                        date = `${state.year}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}`;
                        foundDate = true;
                    }
                }
            }

            // 2. ì¹´ë“œëª… ì°¾ê¸° (ì‹œê°„ ì œê±°)
            if (l.includes('ì¹´ë“œ') || l.includes('Express')) {
                card = l.replace(/\d{1,2}:\d{1,2}(:\d{1,2})?/g, '').trim();
            }

            // 3. ê°€ë§¹ì  ì°¾ê¸° (ë‚ ì§œX, ì‹œê°„X, ì¹´ë“œX, ê¸ˆì•¡X, ìƒíƒœë‹¨ì–´X)
            const isDate = l === "ì˜¤ëŠ˜" || /\d{1,2}[\.\/]\d{1,2}/.test(l);
            const isTime = l.includes(':');
            const isCard = l.includes('ì¹´ë“œ') || l.includes('Express');
            const isStatus = /ì¼ì‹œë¶ˆ|ê±°ë˜ì·¨ì†Œ|ì‹ ì²­í•˜ê¸°|ì ‘ìˆ˜|ìŠ¹ì¸/.test(l);
            
            if (!isDate && !isTime && !isCard && !isStatus && store === "ì•Œ ìˆ˜ ì—†ëŠ” ê°€ë§¹ì ") {
                store = l;
            }
          }
          
          state.list.push({ id: Date.now()+Math.random(), date, store, amt, card, cat: autoCat(store) });
        }
      });
      saveAndRender();
      document.getElementById('autoInput').value = "";
    }

    function processManual() {
      const store = document.getElementById('mStore').value;
      const amt = parseInt(document.getElementById('mAmt').value);
      if(!store || !amt) return alert("ë‚´ì—­ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
      state.list.push({
        id: Date.now(),
        date: document.getElementById('mDate').value,
        store, amt,
        card: document.getElementById('mCard').value,
        cat: document.getElementById('mCat').value
      });
      saveAndRender();
      document.getElementById('mStore').value = "";
      document.getElementById('mAmt').value = "";
    }

    function autoCat(s) {
      if (/ìƒí’ˆê¶Œ|í˜ì´íƒ€ë©|ì¿ í°|ì»¬ì³|í•´í”¼/.test(s)) return 'giftcard';
      if (/ì‹ë‹¹|ì¹´í˜|ë°°ë¯¼|ì†Œí˜¸ì •|ì™„ëš|ìŠ¤íƒ€ë²…ìŠ¤/.test(s)) return 'food';
      if (/íƒì‹œ|ìš°ë²„|ì§€í•˜ì² |ì½”ë ˆì¼/.test(s)) return 'transport';
      if (/ë§ˆíŠ¸|í¸ì˜ì |ì‡¼í•‘|ë„¤ì´ë²„|ì¿ íŒ¡/.test(s)) return 'shopping';
      return 'etc';
    }

    function openEdit(id) {
        state.editId = id;
        const item = state.list.find(t => t.id === id);
        if(!item) return;
        document.getElementById('eStore').value = item.store;
        document.getElementById('eAmt').value = item.amt;
        document.getElementById('eCat').value = item.cat;
        document.getElementById('editModal').classList.add('active');
    }
    
    function saveEdit() {
        const item = state.list.find(t => t.id === state.editId);
        if(item) {
            item.store = document.getElementById('eStore').value;
            item.amt = parseInt(document.getElementById('eAmt').value);
            item.cat = document.getElementById('eCat').value;
            saveAndRender();
            closeModal();
        }
    }

    function deleteItem() {
        if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            state.list = state.list.filter(t => t.id !== state.editId);
            saveAndRender();
            closeModal();
        }
    }
    
    function closeModal() { document.getElementById('editModal').classList.remove('active'); }
    function saveAndRender() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state.list)); render(); }
    function clearFilter() { state.filter = null; render(); }

    function render() {
      document.getElementById('periodDisplay').textContent = `${state.year}ë…„ ${state.month}ì›”`;

      const periodData = state.list.filter(t => {
        const d = new Date(t.date);
        return d.getFullYear() === state.year && (d.getMonth() + 1) === state.month;
      });

      let totals = { total: 0, real: 0, gift: 0 }, cats = {};
      
      periodData.forEach(t => {
        const amt = t.amt || 0;
        totals.total += amt;
        if(t.cat === 'giftcard') totals.gift += amt;
        else {
          totals.real += amt;
          cats[t.cat] = (cats[t.cat] || 0) + amt;
        }
      });

      document.getElementById('total-amt').textContent = totals.total.toLocaleString() + 'ì›';
      document.getElementById('real-amt').textContent = totals.real.toLocaleString() + 'ì›';
      document.getElementById('gift-amt').textContent = totals.gift.toLocaleString() + 'ì›';

      updateChart(cats, totals.real);

      const finalData = state.filter ? periodData.filter(t => t.cat === state.filter) : periodData;
      
      const statusDiv = document.getElementById('filterStatus');
      if(state.filter) {
        statusDiv.style.display = 'flex';
        document.getElementById('filterName').textContent = `${CAT_LABELS[state.filter]} ë³´ê¸°`;
      } else {
        statusDiv.style.display = 'none';
      }

      document.getElementById('listArea').innerHTML = finalData.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t => `
        <div class="list-item" onclick="openEdit(${t.id})">
          <div>
            <span class="tag tag-${t.cat}">${CAT_LABELS[t.cat] || 'ê¸°íƒ€'}</span>
            <strong style="font-size:15px;">${t.store}</strong>
            <div class="item-info">${t.date} | ${t.card}</div>
          </div>
          <strong style="font-size:16px;">${t.amt.toLocaleString()}ì›</strong>
        </div>
      `).join('') || '<p style="text-align:center; padding:50px; color:#9CA3AF;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }

    function updateChart(data, total) {
      const ctx = document.getElementById('mainChart').getContext('2d');
      if (state.chart) state.chart.destroy();
      const keys = Object.keys(data);
      state.chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: keys.map(k=>CAT_LABELS[k] || 'ê¸°íƒ€'),
          datasets: [{ data: Object.values(data), backgroundColor: ['#6366F1','#10B981','#F59E0B','#EF4444','#8B5CF6'], borderWidth: 0 }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: { label: (c) => ` ${c.label}: ${c.raw.toLocaleString()}ì› (${total > 0 ? ((c.raw/total)*100).toFixed(1) : 0}%)` }
            }
          },
          onClick: (e, el) => { if(el.length) { state.filter = keys[el[0].index]; render(); } }
        }
      });
    }

    render();
  </script>
</body>
</html>
