<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>가계부</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="style.css" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
</head>
<body>

<header>
  <div class="row">
    <button onclick="move('prev')">◀</button>
    <strong id="period"></strong>
    <button onclick="move('next')">▶</button>
  </div>
  <div class="row">
    <button onclick="setView('monthly')">월별</button>
    <button onclick="setView('yearly')">연간</button>
  </div>
</header>

<div class="container">

  <div class="card">
    <h4>설정</h4>
    <label>
      <input type="checkbox" id="darkToggle" /> 다크모드
    </label>
  </div>

  <div class="card">
    <h4>지출 입력</h4>
    <input id="amount" type="number" placeholder="금액" />
    <select id="category"></select>
    <input id="memo" placeholder="메모" />
    <button onclick="addExpense()">추가</button>
  </div>

  <div class="card">
    <h4>통계</h4>
    <canvas id="chart"></canvas>
  </div>

  <div class="card">
    <h4>내역</h4>
    <ul id="list"></ul>
  </div>

</div>

<script>
/* ===== STATE ===== */
const state = {
  view: 'monthly',
  year: 2026,
  month: 1,
  dark: false,
  categories: [
    { key: 'food', label: '식비' },
    { key: 'transport', label: '교통' },
    { key: 'shopping', label: '쇼핑' },
    { key: 'etc', label: '기타' }
  ],
  expenses: JSON.parse(localStorage.getItem('expenses') || '[]')
};

/* ===== ELEMENTS ===== */
const periodEl = document.getElementById('period');
const listEl = document.getElementById('list');
const categoryEl = document.getElementById('category');
const amountEl = document.getElementById('amount');
const memoEl = document.getElementById('memo');
const darkToggle = document.getElementById('darkToggle');

let chart;

/* ===== NAV ===== */
function setView(v) {
  state.view = v;
  render();
}

function move(dir) {
  if (state.view === 'monthly') {
    state.month += dir === 'prev' ? -1 : 1;
    if (state.month === 0) { state.month = 12; state.year--; }
    if (state.month === 13) { state.month = 1; state.year++; }
  } else {
    state.year += dir === 'prev' ? -1 : 1;
  }
  render();
}

/* ===== ADD ===== */
function addExpense() {
  if (!amountEl.value) return;
  state.expenses.push({
    amount: Number(amountEl.value),
    category: categoryEl.value,
    memo: memoEl.value,
    year: state.year,
    month: state.month
  });
  localStorage.setItem('expenses', JSON.stringify(state.expenses));
  amountEl.value = '';
  memoEl.value = '';
  render();
}

/* ===== RENDER ===== */
function render() {
  document.documentElement.classList.toggle('dark', state.dark);

  periodEl.textContent =
    state.view === 'monthly'
      ? `${state.year}년 ${state.month}월`
      : `${state.year}년`;

  categoryEl.innerHTML = state.categories
    .map(c => `<option value="${c.key}">${c.label}</option>`)
    .join('');

  const filtered = state.expenses.filter(e =>
    state.view === 'monthly'
      ? e.year === state.year && e.month === state.month
      : e.year === state.year
  );

  listEl.innerHTML = '';
  const sum = {};
  state.categories.forEach(c => sum[c.key] = 0);

  filtered.forEach(e => {
    sum[e.category] += e.amount;
    listEl.innerHTML += `
      <li class="expense-item">
        <span>${e.memo || ''}</span>
        <span class="badge ${e.category}">
          ${e.amount.toLocaleString()}원
        </span>
      </li>`;
  });

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById('chart'), {
    type: 'pie',
    data: {
      labels: state.categories.map(c => c.label),
      datasets: [{
        data: state.categories.map(c => sum[c.key]),
        backgroundColor: [
          'var(--food)',
          'var(--transport)',
          'var(--shopping)',
          'var(--etc)'
        ]
      }]
    },
    options: { plugins: { legend: { position: 'bottom' } } }
  });
}

/* ===== DARK MODE ===== */
darkToggle.addEventListener('change', e => {
  state.dark = e.target.checked;
  render();
});

render();

/* ===== SW ===== */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js');
}
</script>

</body>
</html>
