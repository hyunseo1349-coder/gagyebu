<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>가계부</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#4f46e5" />

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- CSS -->
  <link rel="stylesheet" href="style.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header class="top">
  <button onclick="move(-1)">◀</button>
  <strong id="period"></strong>
  <button onclick="move(1)">▶</button>
</header>

<div class="view-switch">
  <button onclick="setView('month')">월별</button>
  <button onclick="setView('year')">연간</button>
</div>

<main class="container">

  <section class="card">
    <h3>설정</h3>
    <label class="toggle">
      <input type="checkbox" id="darkToggle" />
      <span>다크모드</span>
    </label>
  </section>

  <section class="card">
    <h3>지출 입력</h3>
    <input id="amount" type="number" placeholder="금액" />
    <select id="category">
      <option value="식비">식비</option>
      <option value="교통">교통</option>
      <option value="쇼핑">쇼핑</option>
      <option value="기타">기타</option>
    </select>
    <input id="memo" placeholder="메모" />
    <button onclick="addExpense()">추가</button>
  </section>

  <section class="card">
    <h3>통계</h3>
    <canvas id="chart"></canvas>
  </section>

</main>

<script>
/* ===== 상태 ===== */
let year = 2026, month = 1, view = 'month';
let expenses = JSON.parse(localStorage.getItem('expenses') || '[]');

/* ===== 다크모드 ===== */
const darkToggle = document.getElementById('darkToggle');
const savedDark = localStorage.getItem('dark') === 'true';
document.documentElement.classList.toggle('dark', savedDark);
darkToggle.checked = savedDark;

darkToggle.onchange = () => {
  document.documentElement.classList.toggle('dark', darkToggle.checked);
  localStorage.setItem('dark', darkToggle.checked);
};

/* ===== 날짜 ===== */
function renderPeriod() {
  document.getElementById('period').textContent =
    view === 'month' ? `${year}년 ${month}월` : `${year}년`;
}
renderPeriod();

function move(diff) {
  if (view === 'month') {
    month += diff;
    if (month < 1) { month = 12; year--; }
    if (month > 12) { month = 1; year++; }
  } else {
    year += diff;
  }
  renderPeriod();
  renderChart();
}

function setView(v) {
  view = v;
  renderPeriod();
  renderChart();
}

/* ===== 지출 ===== */
function addExpense() {
  const amount = +amountEl.value;
  if (!amount) return;

  expenses.push({
    amount,
    category: categoryEl.value,
    year, month
  });
  localStorage.setItem('expenses', JSON.stringify(expenses));
  amountEl.value = memoEl.value = '';
  renderChart();
}

const amountEl = document.getElementById('amount');
const categoryEl = document.getElementById('category');
const memoEl = document.getElementById('memo');

/* ===== 차트 ===== */
let chart;
function renderChart() {
  const sum = { 식비:0, 교통:0, 쇼핑:0, 기타:0 };

  expenses.filter(e =>
    view === 'month'
      ? e.year === year && e.month === month
      : e.year === year
  ).forEach(e => sum[e.category] += e.amount);

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById('chart'), {
    type: 'doughnut',
    data: {
      labels: Object.keys(sum),
      datasets: [{
        data: Object.values(sum),
        backgroundColor: ['#f97316','#3b82f6','#22c55e','#a855f7']
      }]
    },
    options: {
      cutout: '65%',
      plugins: { legend: { position: 'bottom' } }
    }
  });
}
renderChart();

/* ===== PWA ===== */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}
</script>

</body>
</html>
