<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Smart Ledger 2026 Pro</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root { --primary: #6366F1; --bg: #F9FAFB; --danger: #EF4444; --success: #10B981; --accent: #F59E0B; }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); color: #1F2937; line-height: 1.5; padding-bottom: 40px; }
    
    /* í—¤ë” ë° ë„¤ë¹„ê²Œì´ì…˜ */
    .header { display: flex; justify-content: space-between; align-items: center; padding: env(safe-area-inset-top) 20px 12px; background: white; border-bottom: 1px solid #E5E7EB; position: sticky; top: 0; z-index: 100; }
    .logo { font-weight: 900; color: var(--primary); font-size: 1.2rem; }
    
    .view-toggle { display: flex; background: #F3F4F6; padding: 4px; border-radius: 12px; }
    .view-toggle button { padding: 6px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; background: transparent; }
    .view-toggle button.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    .main { max-width: 800px; margin: 0 auto; padding: 16px; }

    /* ëŒ€ì‹œë³´ë“œ ë° ì°¨íŠ¸ */
    .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 16px; margin-bottom: 24px; }
    @media (min-width: 768px) { .dashboard-grid { grid-template-columns: 1.5fr 1fr; } }

    .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .card { background: white; padding: 16px; border-radius: 20px; border: 1px solid #E5E7EB; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .card-label { font-size: 11px; color: #6B7280; display: block; margin-bottom: 4px; }
    .card-value { font-size: 16px; font-weight: 800; }
    
    .chart-card { background: white; padding: 20px; border-radius: 20px; border: 1px solid #E5E7EB; display: flex; flex-direction: column; align-items: center; }

    /* ì…ë ¥ ì„¹ì…˜ */
    .input-box { background: white; border-radius: 20px; padding: 20px; border: 1px solid #E5E7EB; margin-bottom: 24px; }
    .tabs { display: flex; gap: 12px; margin-bottom: 16px; border-bottom: 1px solid #F3F4F6; }
    .tab { padding-bottom: 8px; cursor: pointer; font-size: 14px; font-weight: 600; color: #9CA3AF; }
    .tab.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
    
    textarea { width: 100%; height: 100px; padding: 12px; border-radius: 12px; border: 1px solid #E5E7EB; background: #F9FAFB; font-size: 14px; margin-bottom: 12px; resize: none; }
    
    /* ë²„íŠ¼ ê³µí†µ */
    .btn { padding: 12px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; transition: 0.2s; font-size: 14px; }
    .btn-primary { background: var(--primary); color: white; width: 100%; }
    .btn-outline { background: white; border: 1px solid #E5E7EB; color: #6B7280; }

    /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .item { background: white; padding: 16px; border-radius: 16px; margin-bottom: 10px; border: 1px solid #F3F4F6; display: flex; justify-content: space-between; align-items: center; }
    .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-right: 4px; }
    .tag-food { background: #FFEDD5; color: #EA580C; }
    .tag-etc { background: #F3F4F6; color: #4B5563; }

    /* ëª¨ë‹¬ */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: flex-end; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
    .modal-overlay.active { display: flex; }
    .modal { background: white; border-radius: 24px 24px 0 0; width: 100%; max-width: 500px; padding: 24px; padding-bottom: env(safe-area-inset-bottom); animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    /* ë°±ì—… ì»¨íŠ¸ë¡¤ */
    .backup-area { display: flex; gap: 8px; margin-top: 30px; padding-top: 20px; border-top: 1px dashed #E5E7EB; }
    .backup-area button { flex: 1; font-size: 11px; padding: 8px; }
  </style>
</head>
<body>

  <header class="header">
    <div class="logo">Smart Ledger</div>
    <div class="view-toggle">
      <button id="btn-monthly" class="active" onclick="setView('monthly')">ì›”ë³„</button>
      <button id="btn-yearly" onclick="setView('yearly')">ì—°ê°„</button>
    </div>
  </header>

  <main class="main">
    <div style="display:flex; justify-content:center; align-items:center; gap:24px; margin-bottom:20px;">
      <button class="btn btn-outline" style="padding:4px 12px;" onclick="changePeriod(-1)">â—€</button>
      <span id="periodDisplay" style="font-weight:800; font-size:18px; min-width:110px; text-align:center;">2026ë…„ 1ì›”</span>
      <button class="btn btn-outline" style="padding:4px 12px;" onclick="changePeriod(1)">â–¶</button>
    </div>

    <div class="dashboard-grid">
      <div class="summary-grid">
        <div class="card" style="grid-column: span 2;"><span class="card-label">ì´ ì§€ì¶œ</span><span class="card-value" id="stat-total" style="font-size:22px; color:var(--primary)">0ì›</span></div>
        <div class="card"><span class="card-label">ë‚´ ìˆœìˆ˜ ì§€ì¶œ</span><span class="card-value" id="stat-my">0ì›</span></div>
        <div class="card"><span class="card-label">ê°€ì¡±/íƒ€ì¸ë¶„</span><span class="card-value" id="stat-family">0ì›</span></div>
      </div>
      <div class="chart-card">
        <canvas id="categoryChart" width="180" height="180"></canvas>
      </div>
    </div>

    <div class="input-box">
      <div class="tabs">
        <div class="tab active" id="tab-text" onclick="switchInput('text')">í˜„ëŒ€ì¹´ë“œ í…ìŠ¤íŠ¸</div>
        <div class="tab" id="tab-file" onclick="switchInput('file')">ì—‘ì…€/CSV</div>
      </div>
      
      <div id="area-text">
        <textarea id="rawInput" placeholder="ì¹´ë“œ ìƒì„¸ ë‚´ì—­ì„ ì „ì²´ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. ì†Œí˜¸ì •ì²˜ëŸ¼ ì¤„ë°”ê¿ˆì´ ì‹¬í•œ ë‚´ì—­ë„ ì •í™•íˆ íŒŒì‹±í•©ë‹ˆë‹¤."></textarea>
        <button class="btn btn-primary" onclick="parseText()">âœ¨ ìŠ¤ë§ˆíŠ¸ íŒŒì‹± ì¶”ê°€</button>
      </div>

      <div id="area-file" style="display:none;">
        <div style="border: 2px dashed #E5E7EB; padding: 20px; text-align: center; border-radius: 12px; background: #F9FAFB;">
          <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" style="font-size:12px;">
        </div>
        <button class="btn btn-primary" style="margin-top:12px;" onclick="parseFile()">ğŸ“ íŒŒì¼ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>

    <div class="list-header">
      <h3 style="font-size:16px;">ìƒì„¸ ë‚´ì—­</h3>
      <span id="itemCount" style="font-size:12px; color:#6B7280;">0ê±´</span>
    </div>
    <div id="listArea"></div>

    <div class="backup-area">
      <button class="btn btn-outline" onclick="exportData()">ğŸ’¾ ë°ì´í„° ë°±ì—…</button>
      <button class="btn btn-outline" onclick="importData()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="btn btn-outline" style="color:var(--danger)" onclick="clearAllData()">âš ï¸ ì „ì²´ ì‚­ì œ</button>
    </div>
  </main>

  <div class="modal-overlay" id="splitModal">
    <div class="modal">
      <h3 id="mTitle" style="margin-bottom:8px;">í•­ëª© ìƒì„¸ ì„¤ì •</h3>
      <p id="mInfo" style="font-size:13px; color:#6B7280; margin-bottom:20px;"></p>
      
      <label class="card-label">ì¹´í…Œê³ ë¦¬</label>
      <select id="mCat" style="width:100%; padding:12px; border-radius:12px; border:1px solid #E5E7EB; margin-bottom:20px;">
        <option value="food">ì‹ë¹„</option>
        <option value="transport">êµí†µ</option>
        <option value="shopping">ì‡¼í•‘</option>
        <option value="living">ìƒí™œ</option>
        <option value="medical">ì˜ë£Œ</option>
        <option value="etc">ê¸°íƒ€</option>
        <option value="giftcard">ìƒí’ˆê¶Œ</option>
      </select>

      <label class="card-label">ì •ì‚° ì •ë³´</label>
      <div id="mSplitList"></div>
      <div id="mVal" style="text-align:right; font-size:12px; margin-top:8px; font-weight:700;"></div>

      <div style="display:flex; gap:10px; margin-top:24px;">
        <button class="btn btn-outline" style="flex:1" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary" id="mSaveBtn" style="flex:2" onclick="saveModal()">ë³€ê²½ì‚¬í•­ ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'sl_pro_v5_final';
    const CAT_LABELS = { food: 'ì‹ë¹„', transport: 'êµí†µ', shopping: 'ì‡¼í•‘', living: 'ìƒí™œ', medical: 'ì˜ë£Œ', etc: 'ê¸°íƒ€', giftcard: 'ìƒí’ˆê¶Œ' };
    const MEMBERS = { me: 'ë‚˜', mom: 'ì—„ë§ˆ', dad: 'ì•„ë¹ ', bro: 'ë™ìƒ' };

    let state = {
      view: 'monthly', year: 2026, month: 1,
      data: JSON.parse(localStorage.getItem(STORAGE_KEY)) || { list: [] },
      curId: null, chart: null
    };

    function switchInput(t) {
      document.getElementById('area-text').style.display = t === 'text' ? 'block' : 'none';
      document.getElementById('area-file').style.display = t === 'file' ? 'block' : 'none';
      document.getElementById('tab-text').classList.toggle('active', t === 'text');
      document.getElementById('tab-file').classList.toggle('active', t === 'file');
    }

    // --- í˜„ëŒ€ì¹´ë“œ ìµœì í™” íŒŒì‹± ---
    function parseText() {
      const raw = document.getElementById('rawInput').value.trim();
      if (!raw) return;
      const lines = raw.split('\n').map(l => l.trim()).filter(l => l !== "");
      let count = 0;

      for (let i = 0; i < lines.length; i++) {
        if (lines[i].endsWith('ì›') && /^[0-9,]+ì›$/.test(lines[i])) {
          const amt = parseInt(lines[i].replace(/[^0-9]/g, ''));
          let status = lines[i - 1], store = "", date = "2026-01-25";
          
          let j = i - 1, foundDate = false;
          while (j >= 0 && j > i - 10) {
            const line = lines[j];
            if (!foundDate) {
              if (line === "ì˜¤ëŠ˜") { date = "2026-01-25"; foundDate = true; }
              else if (/\d{2}\.\s*\d{1,2}\.\s*\d{1,2}/.test(line)) {
                const d = line.match(/(\d{2})\.\s*(\d{1,2})\.\s*(\d{1,2})/);
                date = `20${d[1]}-${d[2].padStart(2,'0')}-${d[3].padStart(2,'0')}`;
                foundDate = true;
              }
            }
            if (foundDate && !line.includes('ì¹´ë“œ') && !line.includes('ì¼ì‹œë¶ˆ') && !line.includes(':') && !line.includes('ì‹ ì²­í•˜ê¸°')) {
              store = line; break;
            }
            j--;
          }
          if (store && amt) {
            state.data.list.push({ id: Date.now()+Math.random(), date, store, amt, status, cat: autoCat(store), split: { me: amt, mom:0, dad:0, bro:0 } });
            count++;
          }
        }
      }
      cleanAndRender(count);
    }

    // --- ì—‘ì…€ íŒŒì‹± ---
    function parseFile() {
      const file = document.getElementById('excelFile').files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        let count = 0;
        rows.forEach(r => {
          const store = r['ê°€ë§¹ì '] || r['ë‚´ìš©'], amt = parseInt(r['ê¸ˆì•¡'] || r['ì´ìš©ê¸ˆì•¡']);
          if (store && amt) {
            state.data.list.push({ id: Date.now()+Math.random(), date: "2026-01-25", store, amt, cat: autoCat(store), split: { me: amt, mom:0, dad:0, bro:0 } });
            count++;
          }
        });
        cleanAndRender(count);
      };
      reader.readAsArrayBuffer(file);
    }

    function autoCat(s) {
      if (/ìƒí’ˆê¶Œ|í˜ì´íƒ€ë©|ì¿ í°/.test(s)) return 'giftcard';
      if (/ì‹ë‹¹|ì†Œí˜¸ì •|ì¹´í˜|ë°°ë¯¼|ì™„ëš|ìŠ¤ì‹œ|êµ­ìˆ˜|ë‚™ì§€|ì•„ì›ƒë°±|ê°ìíƒ•/.test(s)) return 'food';
      if (/íƒì‹œ|ìš°ë²„|ì§€í•˜ì² |ë²„ìŠ¤/.test(s)) return 'transport';
      if (/ë³‘ì›|ì•½êµ­|ì˜ë£Œ/.test(s)) return 'medical';
      if (/ë°±í™”ì |ì‡¼í•‘|ì¿ íŒ¡|ë§ˆíŠ¸/.test(s)) return 'shopping';
      return 'etc';
    }

    function cleanAndRender(count) {
      // ì·¨ì†Œê±´ ë§¤ì¹­ ì œê±°
      const list = state.data.list;
      const cans = list.filter(t => t.status === "ê±°ë˜ì·¨ì†Œ");
      let delIds = new Set();
      cans.forEach(c => {
        const m = list.find(a => !delIds.has(a.id) && a.status !== "ê±°ë˜ì·¨ì†Œ" && a.amt === c.amt && a.store.includes(c.store.replace('ê°€ìŠ¹ì¸','')));
        if (m) delIds.add(m.id);
      });
      state.data.list = list.filter(t => !delIds.has(t.id) && t.status !== "ê±°ë˜ì·¨ì†Œ");
      
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
      render();
      document.getElementById('rawInput').value = "";
      alert(`${count}ê°œì˜ ë‚´ì—­ì„ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.`);
    }

    function render() {
      document.getElementById('periodDisplay').textContent = state.view === 'monthly' ? `${state.year}ë…„ ${state.month}ì›”` : `${state.year}ë…„`;
      const filtered = state.data.list.filter(t => {
        const d = new Date(t.date);
        return d.getFullYear() === state.year && (state.view === 'yearly' || (d.getMonth()+1) === state.month);
      });

      let stats = { total:0, my:0, family:0, gc:0 }, cats = { food:0, transport:0, shopping:0, living:0, medical:0, etc:0 };
      filtered.forEach(t => {
        stats.total += t.amt;
        if (t.cat === 'giftcard') stats.gc += t.amt;
        else {
          stats.my += t.split.me;
          stats.family += (t.amt - t.split.me);
          cats[t.cat] = (cats[t.cat] || 0) + t.amt;
        }
      });

      document.getElementById('stat-total').textContent = stats.total.toLocaleString() + 'ì›';
      document.getElementById('stat-my').textContent = stats.my.toLocaleString() + 'ì›';
      document.getElementById('stat-family').textContent = stats.family.toLocaleString() + 'ì›';
      document.getElementById('stat-gc').textContent = stats.gc.toLocaleString() + 'ì›';

      updateChart(cats);
      
      document.getElementById('itemCount').textContent = filtered.length + 'ê±´';
      document.getElementById('listArea').innerHTML = filtered.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t => `
        <div class="item" onclick="openModal(${t.id})">
          <div><span class="tag tag-${t.cat}">${CAT_LABELS[t.cat]}</span><strong>${t.store}</strong><div style="font-size:11px;color:#9CA3AF">${t.date}</div></div>
          <div style="text-align:right"><strong>${t.amt.toLocaleString()}ì›</strong>${t.split.me !== t.amt ? `<div style="font-size:10px;color:var(--primary)">ë‚´ ëª«: ${t.split.me.toLocaleString()}ì›</div>`:''}</div>
        </div>
      `).join('') || '<p style="text-align:center;padding:40px;color:#9CA3AF">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }

    function updateChart(data) {
      const ctx = document.getElementById('categoryChart').getContext('2d');
      if (state.chart) state.chart.destroy();
      state.chart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: Object.keys(data).map(k=>CAT_LABELS[k]), datasets: [{ data: Object.values(data), backgroundColor: ['#6366F1','#10B981','#F59E0B','#EF4444','#8B5CF6','#6B7280'], borderWidth:0 }] },
        options: { plugins: { legend: { display:false } }, cutout:'70%' }
      });
    }

    // ëª¨ë‹¬ ë¡œì§
    function openModal(id) {
      state.curId = id;
      const t = state.data.list.find(x => x.id === id);
      document.getElementById('mInfo').textContent = `${t.store} / ${t.amt.toLocaleString()}ì›`;
      document.getElementById('mCat').value = t.cat;
      document.getElementById('mSplitList').innerHTML = Object.entries(MEMBERS).map(([k,v])=>`
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <span style="font-size:14px">${v}</span>
          <input type="number" id="ms-${k}" class="split-input" value="${t.split[k]}" style="width:100px;padding:8px;border:1px solid #DDD;border-radius:8px;text-align:right" oninput="valSplit(${t.amt})">
        </div>
      `).join('');
      valSplit(t.amt);
      document.getElementById('splitModal').classList.add('active');
    }

    function valSplit(total) {
      let sum = 0;
      Object.keys(MEMBERS).forEach(k => sum += parseInt(document.getElementById(`ms-${k}`).value)||0);
      const diff = total - sum;
      const v = document.getElementById('mVal');
      v.textContent = diff === 0 ? "âœ“ ê¸ˆì•¡ ì¼ì¹˜" : `ë‚¨ì€ ê¸ˆì•¡: ${diff.toLocaleString()}ì›`;
      v.style.color = diff === 0 ? "var(--success)" : "var(--danger)";
      document.getElementById('mSaveBtn').disabled = diff !== 0;
    }

    function saveModal() {
      const t = state.data.list.find(x => x.id === state.curId);
      t.cat = document.getElementById('mCat').value;
      Object.keys(MEMBERS).forEach(k => t.split[k] = parseInt(document.getElementById(`ms-${k}`).value)||0);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
      closeModal(); render();
    }

    function closeModal() { document.getElementById('splitModal').classList.remove('active'); }
    function changePeriod(v) { state.month += v; if(state.month>12){state.month=1;state.year++;} if(state.month<1){state.month=12;state.year--;} render(); }
    function setView(v) { state.view = v; document.getElementById('btn-monthly').classList.toggle('active', v==='monthly'); document.getElementById('btn-yearly').classList.toggle('active', v==='yearly'); render(); }

    // --- ë°ì´í„° ë°±ì—…/ë³µêµ¬ í•¨ìˆ˜ ---
    function exportData() {
      const blob = new Blob([JSON.stringify(state.data)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `gagyebu_backup_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    }

    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = e => {
        const reader = new FileReader();
        reader.onload = e => {
          state.data = JSON.parse(e.target.result);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
          render();
          alert("ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
        };
        reader.readAsText(e.target.files[0]);
      };
      input.click();
    }

    function clearAllData() {
      if (confirm("ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë°±ì—…ë˜ì§€ ì•Šì€ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
        state.data = { list: [] };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
        render();
      }
    }

    render();
  </script>
</body>
</html>
