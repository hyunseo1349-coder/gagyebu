<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Ledger 2026 Pro - ìƒí…Œí¬ ì—ë””ì…˜</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --primary: #6366F1; --bg: #F9FAFB; --danger: #EF4444; --success: #10B981; --accent: #F59E0B; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); color: #1F2937; line-height: 1.5; }
    
    .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: white; border-bottom: 1px solid #E5E7EB; position: sticky; top: 0; z-index: 100; }
    .view-toggle { display: flex; background: #F3F4F6; padding: 4px; border-radius: 12px; }
    .view-toggle button { padding: 8px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; background: transparent; transition: 0.2s; font-size: 13px; }
    .view-toggle button.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    .main { max-width: 1000px; margin: 0 auto; padding: 20px; }

    .period-nav { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 24px; background: white; padding: 16px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    .nav-btn { width: 36px; height: 36px; border: 1px solid #E5E7EB; background: white; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .current-period { font-weight: 800; font-size: 18px; color: var(--primary); min-width: 120px; text-align: center; }

    .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
    .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: white; padding: 20px; border-radius: 24px; border: 1px solid #E5E7EB; }
    .card-label { font-size: 12px; color: #6B7280; display: block; margin-bottom: 6px; }
    .card-value { font-size: 18px; font-weight: 800; color: #111827; }
    
    .chart-card { background: white; padding: 24px; border-radius: 24px; border: 1px solid #E5E7EB; display: flex; flex-direction: column; align-items: center; }
    #categoryChart { max-width: 180px !important; max-height: 180px !important; cursor: pointer; }
    .chart-legend { width: 100%; margin-top: 15px; font-size: 12px; }
    .legend-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #F3F4F6; cursor: pointer; }

    .quick-input-area { background: white; border-radius: 24px; padding: 24px; border: 1px solid #E5E7EB; margin-bottom: 30px; }
    textarea { width: 100%; height: 80px; padding: 15px; border-radius: 12px; border: 1px solid #E5E7EB; background: #F9FAFB; resize: none; font-family: inherit; margin-bottom: 12px; }
    .input-btns { display: flex; gap: 10px; }
    .btn { padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; font-size: 14px; }
    .btn-primary { background: var(--primary); color: white; flex: 2; }
    .btn-outline { background: white; border: 1px solid var(--primary); color: var(--primary); flex: 1; }

    /* í•„í„° íƒœê·¸ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ */
    .filter-tag-container { margin-bottom: 18px; display: none; }
    .filter-tag { 
        display: inline-flex; 
        align-items: center; 
        background: var(--primary); 
        color: white; 
        padding: 8px 16px; 
        border-radius: 14px; 
        font-weight: 700; 
        font-size: 14px; 
        cursor: pointer; 
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
        transition: all 0.2s ease;
    }
    .filter-tag:hover { 
        background: #4F46E5; 
        transform: translateY(-2px); 
    }
    .filter-tag .tag-icon { margin-right: 6px; font-size: 15px; }
    .filter-tag .close-icon { margin-left: 10px; font-size: 16px; opacity: 0.8; }

    .transaction-item { background: white; padding: 16px; border-radius: 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #F3F4F6; cursor: pointer; }
    .tag { font-size: 10px; padding: 2px 8px; border-radius: 6px; font-weight: 700; margin-right: 6px; }
    .tag-food { background: #FFEDD5; color: #EA580C; }
    .tag-transport { background: #DBEAFE; color: #2563EB; }
    .tag-medical { background: #FEE2E2; color: #DC2626; }
    .tag-giftcard { background: #FCE7F3; color: #BE185D; }
    .tag-shopping { background: #FEF9C3; color: #854D0E; }
    .tag-living { background: #E0E7FF; color: #4338CA; }
    .tag-etc { background: #F3F4F6; color: #4B5563; }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
    .modal-overlay.active { display: flex; }
    .modal { background: white; border-radius: 24px; width: 95%; max-width: 450px; padding: 28px; max-height: 90vh; overflow-y: auto; }
    .input-group { margin-bottom: 12px; }
    .input-group label { display: block; font-size: 11px; color: #6B7280; margin-bottom: 4px; }
    .input-group input, .input-group select { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #E5E7EB; }

    #gc-calc-section { background: #F5F7FF; padding: 15px; border-radius: 16px; margin-bottom: 20px; border: 1px dashed var(--primary); }
    .split-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; padding: 8px; border-radius: 10px; background: #F9FAFB; }
    .split-input { width: 80px; padding: 4px; border: 1px solid #DDD; border-radius: 6px; text-align: right; }

    @media (max-width: 800px) { .dashboard-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

  <header class="header">
    <div style="font-weight: 900; color: var(--primary); font-size: 20px;">Smart Ledger Pro</div>
    <div class="view-toggle">
      <button id="btn-monthly" class="active" onclick="setView('monthly')">ì›”ê°„</button>
      <button id="btn-yearly" onclick="setView('yearly')">ì—°ê°„</button>
    </div>
  </header>

  <main class="main">
    <div class="period-nav">
      <button class="nav-btn" onclick="changePeriod(-1)">â—€</button>
      <span class="current-period" id="periodDisplay"></span>
      <button class="nav-btn" onclick="changePeriod(1)">â–¶</button>
    </div>

    <div class="dashboard-grid">
      <div class="summary-grid">
        <div class="card"><span class="card-label">ğŸ’° ì´ì§€ì¶œ</span><span class="card-value" id="stat-total">0ì›</span></div>
        <div class="card" style="border-left: 4px solid var(--success);"><span class="card-label">ğŸ›’ ì‹¤ì œ ì§€ì¶œ</span><span class="card-value" id="stat-my">0ì›</span></div>
        <div class="card" style="border-left: 4px solid var(--primary);"><span class="card-label">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ê°€ì¡± ì‚¬ìš©</span><span class="card-value" id="stat-family">0ì›</span></div>
        <div class="card" style="border-left: 4px solid var(--accent);"><span class="card-label">ğŸ« ìƒí’ˆê¶Œ</span><span class="card-value" id="stat-gc">0ì›</span></div>
      </div>
      <div class="chart-card">
        <span class="card-label" style="margin-bottom:15px;">ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ ë¹„ìœ¨</span>
        <canvas id="categoryChart"></canvas>
        <div id="chartLegend" class="chart-legend"></div>
      </div>
    </div>

    <div class="quick-input-area">
      <textarea id="rawInput" placeholder="ì¹´ë“œ ìƒì„¸ ë‚´ì—­ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
      <div class="input-btns">
          <button class="btn btn-primary" onclick="parseAndPreview()">âœ¨ ìë™ ì…ë ¥</button>
          <button class="btn btn-outline" onclick="openManualInput()">â• ìˆ˜ë™ ì…ë ¥</button>
      </div>
    </div>

    <div id="filterTagContainer" class="filter-tag-container">
        <div class="filter-tag" onclick="clearFilter()">
            <span class="tag-icon">ğŸ·ï¸</span>
            <span id="filterTagName">ì‹ë¹„</span>
            <span class="close-icon">âœ•</span>
        </div>
    </div>

    <div id="listArea"></div>
  </main>

  <div class="modal-overlay" id="manualModal">
    <div class="modal">
      <h3>ìˆ˜ë™ ì§€ì¶œ ì…ë ¥</h3>
      <div class="input-group" style="margin-top:20px;"><label>ë‚ ì§œ</label><input type="date" id="man-date"></div>
      <div class="input-group"><label>ì‚¬ìš©ì²˜</label><input type="text" id="man-store"></div>
      <div class="input-group"><label>ê¸ˆì•¡</label><input type="number" id="man-amount"></div>
      <div class="input-group">
        <label>ì¹´í…Œê³ ë¦¬</label>
        <select id="man-category">
            <option value="food">ì‹ë¹„</option><option value="transport">êµí†µ</option>
            <option value="shopping">ì‡¼í•‘</option><option value="living">ìƒí™œ</option>
            <option value="medical">ì˜ë£Œ</option><option value="etc">ê¸°íƒ€</option>
            <option value="giftcard">ìƒí’ˆê¶Œ</option>
        </select>
      </div>
      <div style="display:flex; gap:10px; margin-top:24px">
        <button class="btn" style="background:#F3F4F6; flex:1" onclick="closeModal('manualModal')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" style="flex:2" onclick="saveManualInput()">ì¶”ê°€í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="splitModal">
    <div class="modal">
      <h3 id="splitTitle">í•­ëª© ìƒì„¸ ì„¤ì •</h3>
      <p id="splitTotalDisplay" style="font-size: 14px; color: #6B7280; margin-bottom: 15px;"></p>

      <div id="gc-calc-section" style="display:none;">
        <h4 style="font-size:12px; color:var(--primary); margin-bottom:10px;">ğŸ« ë§ˆì¼ ë‹¨ê°€ ê³„ì‚°ê¸°</h4>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <div class="input-group"><label>í˜„ê¸ˆí™” ê¸ˆì•¡</label><input type="number" id="gc-cashback" oninput="runGcCalc()"></div>
            <div class="input-group"><label>ì—°íšŒë¹„(ì›”)</label><input type="number" id="gc-fee" oninput="runGcCalc()"></div>
            <div class="input-group"><label>ì¹´ë“œ í˜œíƒ</label><input type="number" id="gc-benefit" oninput="runGcCalc()"></div>
            <div class="input-group"><label>ì ë¦½ ë§ˆì¼</label><input type="number" id="gc-mileage" oninput="runGcCalc()"></div>
        </div>
        <div id="mile-result" style="font-size:11px; margin-top:8px; text-align:center; background:white; padding:5px; border-radius:8px;"></div>
      </div>
      
      <div class="input-group">
        <label>ì¹´í…Œê³ ë¦¬</label>
        <select id="editCategory" onchange="toggleGcSection()"></select>
      </div>

      <label class="card-label">ì¸ì›ë³„ ì •ì‚°</label>
      <div id="splitList"></div>
      <div id="splitValidate" style="text-align:right; font-size:12px; margin-top:5px;"></div>

      <div style="display:flex; gap:10px; margin-top:24px">
        <button class="btn" style="background:#F3F4F6; flex:1" onclick="closeModal('splitModal')">ë‹«ê¸°</button>
        <button class="btn btn-danger" style="color:white; flex:1" onclick="deleteItem()">ì‚­ì œ</button>
        <button class="btn btn-primary" id="saveSplitBtn" style="flex:2" onclick="saveSettlement()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    const DATA_KEY = `sl_data_2026_v6_tag`;
    const CAT_MAP = { food: 'ì‹ë¹„', transport: 'êµí†µ', shopping: 'ì‡¼í•‘', living: 'ìƒí™œ', medical: 'ì˜ë£Œ', etc: 'ê¸°íƒ€', giftcard: 'ìƒí’ˆê¶Œ' };
    const CAT_COLORS = { food: '#6366F1', transport: '#10B981', shopping: '#F59E0B', living: '#EF4444', medical: '#8B5CF6', etc: '#6B7280', giftcard: '#EC4899' };

    const now = new Date();
    let state = {
      view: 'monthly', 
      year: now.getFullYear(), 
      month: now.getMonth() + 1,
      data: JSON.parse(localStorage.getItem(DATA_KEY)) || { transactions: [] },
      currentId: null,
      chart: null,
      filterCategory: null
    };

    function saveData() { localStorage.setItem(DATA_KEY, JSON.stringify(state.data)); }

    function setView(v) {
      state.view = v;
      document.getElementById('btn-monthly').classList.toggle('active', v === 'monthly');
      document.getElementById('btn-yearly').classList.toggle('active', v === 'yearly');
      render();
    }

    function changePeriod(dir) {
      if (state.view === 'monthly') {
        state.month += dir;
        if (state.month > 12) { state.month = 1; state.year++; }
        if (state.month < 1) { state.month = 12; state.year--; }
      } else { state.year += dir; }
      render();
    }

    function render() {
      document.getElementById('periodDisplay').textContent = state.view === 'monthly' ? `${state.year}ë…„ ${state.month}ì›”` : `${state.year}ë…„`;
      
      let filtered = state.data.transactions.filter(t => {
        const d = new Date(t.fullDate);
        return d.getFullYear() === state.year && (state.view === 'yearly' || (d.getMonth()+1) === state.month);
      });

      let stats = { total: 0, family: 0, gc: 0, myShare: 0 };
      let catSums = { food: 0, transport: 0, shopping: 0, living: 0, medical: 0, etc: 0, giftcard: 0 };

      filtered.forEach(t => {
        stats.total += t.amount;
        if (t.category === 'giftcard') stats.gc += t.amount;
        stats.family += (t.split?.mom || 0) + (t.split?.dad || 0) + (t.split?.bro || 0);
        stats.myShare += (t.split?.me || t.amount);
        catSums[t.category] += t.amount;
      });

      const actualSpending = stats.total + (stats.myShare - stats.total) - stats.gc;

      document.getElementById('stat-total').textContent = stats.total.toLocaleString() + 'ì›';
      document.getElementById('stat-my').textContent = actualSpending.toLocaleString() + 'ì›';
      document.getElementById('stat-family').textContent = stats.family.toLocaleString() + 'ì›';
      document.getElementById('stat-gc').textContent = stats.gc.toLocaleString() + 'ì›';

      updateChart(catSums);

      // í•„í„° UI ì—…ë°ì´íŠ¸ (íƒœê·¸ í˜•íƒœ)
      if (state.filterCategory) {
          document.getElementById('filterTagContainer').style.display = 'block';
          document.getElementById('filterTagName').textContent = CAT_MAP[state.filterCategory];
      } else {
          document.getElementById('filterTagContainer').style.display = 'none';
      }

      let displayData = state.filterCategory ? filtered.filter(t => t.category === state.filterCategory) : filtered;

      const listArea = document.getElementById('listArea');
      listArea.innerHTML = displayData.sort((a,b) => new Date(b.fullDate)-new Date(a.fullDate)).map(t => `
        <div class="transaction-item" onclick="openSettlement(${t.id})">
          <div>
            <div style="font-size:10px; color:#9CA3AF; margin-bottom:4px;">${t.fullDate} | ${t.cardName || 'ì¹´ë“œ'}</div>
            <span class="tag tag-${t.category}">${CAT_MAP[t.category]}</span>
            <span style="font-weight:700;">${t.store}</span>
          </div>
          <div style="text-align:right">
            <div style="font-weight:800;">${t.amount.toLocaleString()}ì›</div>
          </div>
        </div>
      `).join('') || '<div style="text-align:center; padding:40px; color:#9CA3AF;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    function updateChart(sums) {
      const ctx = document.getElementById('categoryChart').getContext('2d');
      const entries = Object.entries(sums).filter(e => e[1] > 0);
      const data = entries.map(e => e[1]);
      const labels = entries.map(e => CAT_MAP[e[0]]);
      const colors = entries.map(e => CAT_COLORS[e[0]]);
      const total = data.reduce((a,b) => a+b, 0);

      if (state.chart) state.chart.destroy();
      state.chart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0 }] },
        options: {
          plugins: { legend: { display: false } },
          cutout: '70%',
          onClick: (evt, el) => { if(el[0]) { state.filterCategory = entries[el[0].index][0]; render(); } }
        }
      });

      document.getElementById('chartLegend').innerHTML = entries.map(([key, val]) => `
        <div class="legend-item" onclick="state.filterCategory='${key}'; render();">
          <span><span style="color:${CAT_COLORS[key]}">â—</span> ${CAT_MAP[key]}</span>
          <span><b>${val.toLocaleString()}ì›</b> (${((val/total)*100).toFixed(1)}%)</span>
        </div>
      `).join('');
    }

    function openSettlement(id) {
      const t = state.data.transactions.find(x => x.id === id);
      state.currentId = id;
      document.getElementById('splitTotalDisplay').textContent = `${t.store} (${t.amount.toLocaleString()}ì›)`;
      const select = document.getElementById('editCategory');
      select.innerHTML = Object.entries(CAT_MAP).map(([k,v]) => `<option value="${k}" ${t.category===k?'selected':''}>${v}</option>`).join('');
      if(t.category === 'giftcard') {
          document.getElementById('gc-cashback').value = t.gcInfo?.cashback || '';
          document.getElementById('gc-fee').value = t.gcInfo?.fee || '';
          document.getElementById('gc-benefit').value = t.gcInfo?.benefit || '';
          document.getElementById('gc-mileage').value = t.gcInfo?.mileage || '';
          runGcCalc();
      }
      toggleGcSection();
      const members = { me: 'ë‚˜', mom: 'ì—„ë§ˆ', dad: 'ì•„ë¹ ', bro: 'ë™ìƒ' };
      if (!t.split) t.split = { me: t.amount, mom:0, dad:0, bro:0 };
      document.getElementById('splitList').innerHTML = Object.entries(members).map(([key, name]) => `
        <div class="split-row">
          <span>${name}</span>
          <input type="number" class="split-input" id="split-${key}" value="${t.split[key] || 0}" oninput="validateSplit(${t.amount})">
        </div>
      `).join('');
      validateSplit(t.amount);
      document.getElementById('splitModal').classList.add('active');
    }

    function runGcCalc() {
        const buy = state.data.transactions.find(x => x.id === state.currentId).amount;
        const cb = parseInt(document.getElementById('gc-cashback').value) || 0;
        const fee = parseInt(document.getElementById('gc-fee').value) || 0;
        const bn = parseInt(document.getElementById('gc-benefit').value) || 0;
        const ml = parseInt(document.getElementById('gc-mileage').value) || 0;
        const net = buy - cb + fee - bn;
        const price = ml > 0 ? (net / ml).toFixed(2) : 0;
        document.getElementById('mile-result').innerHTML = `ì‹¤ì§ˆë¹„ìš©: ${net.toLocaleString()}ì› | <b>ë‹¨ê°€: ${price}ì›</b>`;
    }

    function toggleGcSection() {
        document.getElementById('gc-calc-section').style.display = document.getElementById('editCategory').value === 'giftcard' ? 'block' : 'none';
    }

    function saveSettlement() {
      const t = state.data.transactions.find(x => x.id === state.currentId);
      t.category = document.getElementById('editCategory').value;
      t.split = {
        me: parseInt(document.getElementById('split-me').value) || 0,
        mom: parseInt(document.getElementById('split-mom').value) || 0,
        dad: parseInt(document.getElementById('split-dad').value) || 0,
        bro: parseInt(document.getElementById('split-bro').value) || 0
      };
      if(t.category === 'giftcard') {
          t.gcInfo = {
              cashback: parseInt(document.getElementById('gc-cashback').value) || 0,
              fee: parseInt(document.getElementById('gc-fee').value) || 0,
              benefit: parseInt(document.getElementById('gc-benefit').value) || 0,
              mileage: parseInt(document.getElementById('gc-mileage').value) || 0
          };
      }
      saveData(); closeModal('splitModal'); render();
    }

    function clearFilter() { state.filterCategory = null; render(); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function openManualInput() { 
        document.getElementById('man-date').value = new Date().toISOString().split('T')[0];
        document.getElementById('manualModal').classList.add('active'); 
    }
    function saveManualInput() {
        const amt = parseInt(document.getElementById('man-amount').value);
        if(!amt) return;
        state.data.transactions.push({
            id: Date.now(),
            fullDate: document.getElementById('man-date').value,
            store: document.getElementById('man-store').value || "ìˆ˜ë™ ì…ë ¥",
            amount: amt,
            category: document.getElementById('man-category').value,
            cardName: "ìˆ˜ë™",
            split: { me: amt, mom:0, dad:0, bro:0 }
        });
        saveData(); closeModal('manualModal'); render();
    }
    function deleteItem() {
        if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            state.data.transactions = state.data.transactions.filter(x => x.id !== state.currentId);
            saveData(); closeModal('splitModal'); render();
        }
    }
    function validateSplit(total) {
      const sum = Array.from(document.querySelectorAll('.split-input')).reduce((a, b) => a + (parseInt(b.value) || 0), 0);
      const diff = total - sum;
      const v = document.getElementById('splitValidate');
      v.textContent = diff === 0 ? "âœ“ ì¼ì¹˜" : `ì”ì•¡: ${diff.toLocaleString()}ì›`;
      v.style.color = diff === 0 ? "var(--success)" : "var(--danger)";
      document.getElementById('saveSplitBtn').disabled = diff !== 0;
    }

    function parseAndPreview() {
      const text = document.getElementById('rawInput').value.trim();
      if (!text) return;
      const lines = text.split('\n').map(l => l.trim()).filter(l => l !== "");
      for (let i = 0; i < lines.length; i++) {
        if (lines[i].endsWith('ì›')) {
          let amount = parseInt(lines[i].replace(/ì›|,/g, ''));
          let store = lines[i-5] || "ê°€ë§¹ì ";
          state.data.transactions.push({
            id: Date.now() + Math.random(),
            fullDate: new Date().toISOString().split('T')[0],
            store, amount, category: 'etc', cardName: "ì‚¼ì„±ì¹´ë“œ"
          });
        }
      }
      saveData(); document.getElementById('rawInput').value = ''; render();
    }

    render();
  </script>
</body>
</html>
