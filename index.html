<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Ledger 2026 Pro - Smart Parsing</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --primary: #6366F1; --bg: #F9FAFB; --danger: #EF4444; --success: #10B981; --accent: #F59E0B; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); color: #1F2937; line-height: 1.5; }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: white; border-bottom: 1px solid #E5E7EB; position: sticky; top: 0; z-index: 100; }
    .view-toggle { display: flex; background: #F3F4F6; padding: 4px; border-radius: 12px; }
    .view-toggle button { padding: 8px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; background: transparent; transition: 0.2s; font-size: 13px; }
    .view-toggle button.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .main { max-width: 1000px; margin: 0 auto; padding: 20px; }
    .period-nav { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 24px; background: white; padding: 16px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    .nav-btn { width: 36px; height: 36px; border: 1px solid #E5E7EB; background: white; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .current-period { font-weight: 800; font-size: 18px; color: var(--primary); min-width: 120px; text-align: center; }
    .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
    .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: white; padding: 20px; border-radius: 24px; border: 1px solid #E5E7EB; }
    .card-label { font-size: 11px; color: #6B7280; display: block; margin-bottom: 4px; text-transform: uppercase; }
    .card-value { font-size: 18px; font-weight: 800; color: #111827; }
    .chart-card { background: white; padding: 24px; border-radius: 24px; border: 1px solid #E5E7EB; display: flex; flex-direction: column; align-items: center; }
    #categoryChart { max-width: 160px !important; max-height: 160px !important; }
    .chart-legend { width: 100%; margin-top: 15px; font-size: 12px; }
    .legend-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #F3F4F6; cursor: pointer; transition: 0.2s; }
    .legend-item:hover { color: var(--primary); }
    .quick-input-area { background: white; border-radius: 24px; padding: 24px; border: 1px solid #E5E7EB; margin-bottom: 30px; }
    textarea { width: 100%; height: 100px; padding: 15px; border-radius: 12px; border: 1px solid #E5E7EB; background: #F9FAFB; resize: none; font-family: inherit; margin-bottom: 12px; font-size: 13px; }
    .input-btns { display: flex; gap: 10px; }
    .btn { padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; font-size: 14px; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; flex: 2; }
    .btn-outline { background: white; border: 1px solid var(--primary); color: var(--primary); flex: 1; }
    .filter-tag-container { margin-bottom: 18px; display: none; }
    .filter-tag { display: inline-flex; align-items: center; background: var(--primary); color: white; padding: 8px 16px; border-radius: 14px; font-weight: 700; font-size: 14px; cursor: pointer; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25); transition: 0.2s; }
    .filter-tag:hover { transform: translateY(-2px); }
    .transaction-item { background: white; padding: 16px; border-radius: 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #F3F4F6; cursor: pointer; transition: 0.2s; }
    .transaction-item:hover { border-color: var(--primary); transform: translateX(4px); }
    .tag { font-size: 10px; padding: 2px 8px; border-radius: 6px; font-weight: 700; margin-right: 6px; }
    .tag-food { background: #FFEDD5; color: #EA580C; }
    .tag-transport { background: #DBEAFE; color: #2563EB; }
    .tag-medical { background: #FEE2E2; color: #DC2626; }
    .tag-giftcard { background: #FCE7F3; color: #BE185D; }
    .tag-shopping { background: #FEF9C3; color: #854D0E; }
    .tag-etc { background: #F3F4F6; color: #4B5563; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
    .modal-overlay.active { display: flex; }
    .modal { background: white; border-radius: 24px; width: 95%; max-width: 450px; padding: 28px; max-height: 90vh; overflow-y: auto; }
    .input-group { margin-bottom: 12px; }
    .input-group label { display: block; font-size: 11px; color: #6B7280; margin-bottom: 4px; }
    .input-group input, .input-group select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #E5E7EB; font-family: inherit; }
    #gc-calc-section { background: #F5F7FF; padding: 15px; border-radius: 16px; margin-bottom: 20px; border: 1px dashed var(--primary); }
    .split-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; padding: 8px; border-radius: 10px; background: #F9FAFB; }
    .split-input { width: 90px; padding: 6px; border: 1px solid #DDD; border-radius: 6px; text-align: right; }
    @media (max-width: 800px) { .dashboard-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

  <header class="header">
    <div style="font-weight: 900; color: var(--primary); font-size: 20px; letter-spacing: -0.5px;">Smart Ledger Pro</div>
    <div class="view-toggle">
      <button id="btn-monthly" class="active" onclick="setView('monthly')">ì›”ê°„</button>
      <button id="btn-yearly" onclick="setView('yearly')">ì—°ê°„</button>
    </div>
  </header>

  <main class="main">
    <div class="period-nav">
      <button class="nav-btn" onclick="changePeriod(-1)">â—€</button>
      <span class="current-period" id="periodDisplay"></span>
      <button class="nav-btn" onclick="changePeriod(1)">â–¶</button>
    </div>

    <div class="dashboard-grid">
      <div class="summary-grid">
        <div class="card"><span class="card-label">ğŸ’° Total Spent</span><span class="card-value" id="stat-total">0ì›</span></div>
        <div class="card" style="border-left: 4px solid var(--success);"><span class="card-label">ğŸ›’ Real Net</span><span class="card-value" id="stat-my">0ì›</span></div>
        <div class="card" style="border-left: 4px solid var(--primary);"><span class="card-label">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Family Split</span><span class="card-value" id="stat-family">0ì›</span></div>
        <div class="card" style="border-left: 4px solid var(--accent);"><span class="card-label">ğŸ« Gift Cards</span><span class="card-value" id="stat-gc">0ì›</span></div>
      </div>
      <div class="chart-card">
        <canvas id="categoryChart"></canvas>
        <div id="chartLegend" class="chart-legend"></div>
      </div>
    </div>

    <div class="quick-input-area">
      <textarea id="rawInput" placeholder="ì¹´ë“œ ìƒì„¸ ë‚´ì—­(í˜„ëŒ€ì¹´ë“œ ë“±)ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
      <div class="input-btns">
          <button class="btn btn-primary" onclick="parseAndPreview()">âœ¨ ìŠ¤ë§ˆíŠ¸ ìë™ ë¶„ì„</button>
          <button class="btn btn-outline" onclick="openManualInput()">â• ì§ì ‘ ì…ë ¥</button>
      </div>
    </div>

    <div id="filterTagContainer" class="filter-tag-container">
        <div class="filter-tag" onclick="clearFilter()">
            <span style="margin-right:8px;">ğŸ·ï¸</span><span id="filterTagName">ì¹´í…Œê³ ë¦¬</span><span style="margin-left:12px; opacity:0.7;">âœ•</span>
        </div>
    </div>

    <div id="listArea"></div>
  </main>

  <div class="modal-overlay" id="splitModal">
    <div class="modal">
      <h3 id="splitTitle" style="margin-bottom:5px;">ìƒì„¸ ì„¤ì •</h3>
      <p id="splitTotalDisplay" style="font-size: 13px; color: #6B7280; margin-bottom: 20px;"></p>

      <div id="gc-calc-section" style="display:none;">
        <h4 style="font-size:12px; color:var(--primary); margin-bottom:10px;">ğŸ« ìƒí…Œí¬ ë§ˆì¼ ë‹¨ê°€ ê³„ì‚°ê¸°</h4>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <div class="input-group"><label>í˜„ê¸ˆí™” ê¸ˆì•¡</label><input type="number" id="gc-cashback" oninput="runGcCalc()"></div>
            <div class="input-group"><label>ì—°íšŒë¹„(1/12)</label><input type="number" id="gc-fee" oninput="runGcCalc()"></div>
            <div class="input-group"><label>ì¶”ê°€ í˜œíƒ</label><input type="number" id="gc-benefit" oninput="runGcCalc()"></div>
            <div class="input-group"><label>ì ë¦½ ë§ˆì¼ë¦¬ì§€</label><input type="number" id="gc-mileage" oninput="runGcCalc()"></div>
        </div>
        <div id="mile-result" style="font-size:11px; margin-top:10px; text-align:center; background:white; padding:8px; border-radius:10px; border:1px solid #E5E7EB;"></div>
      </div>
      
      <div class="input-group">
        <label>ì¹´í…Œê³ ë¦¬</label>
        <select id="editCategory" onchange="toggleGcSection()"></select>
      </div>

      <label class="card-label" style="margin-top:15px;">ë©¤ë²„ë³„ ê¸ˆì•¡ ì •ì‚°</label>
      <div id="splitList"></div>
      <div id="splitValidate" style="text-align:right; font-size:12px; margin-top:5px; font-weight:700;"></div>

      <div style="display:flex; gap:10px; margin-top:24px">
        <button class="btn" style="background:#F3F4F6; flex:1" onclick="closeModal('splitModal')">ì·¨ì†Œ</button>
        <button class="btn btn-danger" style="color:white; flex:1" onclick="deleteItem()">ì‚­ì œ</button>
        <button class="btn btn-primary" id="saveSplitBtn" style="flex:2" onclick="saveSettlement()">ì„¤ì • ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    const DATA_KEY = `sl_v2026_smart_parsing`;
    const CAT_MAP = { food: 'ì‹ë¹„', transport: 'êµí†µ', shopping: 'ì‡¼í•‘', living: 'ìƒí™œ', medical: 'ì˜ë£Œ', etc: 'ê¸°íƒ€', giftcard: 'ìƒí’ˆê¶Œ' };
    const CAT_COLORS = { food: '#6366F1', transport: '#10B981', shopping: '#F59E0B', living: '#EF4444', medical: '#8B5CF6', etc: '#6B7280', giftcard: '#EC4899' };

    const now = new Date();
    let state = {
      view: 'monthly', 
      year: now.getFullYear(), 
      month: now.getMonth() + 1,
      data: JSON.parse(localStorage.getItem(DATA_KEY)) || { transactions: [] },
      currentId: null,
      chart: null,
      filterCategory: null
    };

    function saveData() { localStorage.setItem(DATA_KEY, JSON.stringify(state.data)); }

    function setView(v) {
      state.view = v;
      document.getElementById('btn-monthly').classList.toggle('active', v === 'monthly');
      document.getElementById('btn-yearly').classList.toggle('active', v === 'yearly');
      render();
    }

    function changePeriod(dir) {
      if (state.view === 'monthly') {
        state.month += dir;
        if (state.month > 12) { state.month = 1; state.year++; }
        if (state.month < 1) { state.month = 12; state.year--; }
      } else { state.year += dir; }
      render();
    }

    function parseAndPreview() {
      const text = document.getElementById('rawInput').value.trim();
      if (!text) return;

      const lines = text.split('\n').map(l => l.trim()).filter(l => l !== "");
      const newItems = [];
      
      const keywords = {
        food: ['ì†Œí˜¸ì •', 'ìˆœë‘ë¶€', 'ìš°ì•„í•œí˜•ì œë“¤', 'KFC', 'ì»¤í”¼', 'ë©”ê°€MGC', 'ì‹í’ˆ', 'ì‹ë‹¹', 'ë² ì´ì»¤ë¦¬', 'ì¹´í˜', 'ìš”ë¦¬', 'ë³¸ì£½', 'ì™„ëš'],
        medical: ['ì¬í™œì˜í•™', 'ë³‘ì›', 'ì˜ì›', 'ë‚´ê³¼', 'ì¹˜ê³¼', 'ì•½êµ­', 'êµ¿ë³¸'],
        transport: ['íƒì‹œ', 'ì¹´ì¹´ì˜¤T', 'ë²„ìŠ¤', 'ì§€í•˜ì² ', 'ì½”ë ˆì¼'],
        giftcard: ['ëª¨ë°”ì¼ì¿ í°', 'ìƒí’ˆê¶Œ', 'í˜ì´íƒ€ë©', 'ê¸°í”„í‹°ì½˜', 'ëµìƒµ'] // ëµìƒµ ì¶”ê°€ë¨
      };

      lines.forEach((line, index) => {
        if (line.includes('ì›') && /\d/.test(line)) {
          const amount = parseInt(line.replace(/ì›|,/g, ''));
          if (isNaN(amount)) return;

          let store = "ê°€ë§¹ì  ë¯¸ë¶„ë¥˜";
          let cardName = "í˜„ëŒ€ì¹´ë“œ";
          let dateStr = `${state.year}-${String(state.month).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
          let category = 'etc';

          for (let j = 1; j <= 8; j++) {
            const pLine = lines[index - j];
            if (!pLine) break;

            if (pLine.includes('ì¹´ë“œ')) cardName = pLine;
            if (pLine === 'ì˜¤ëŠ˜') {
                const today = new Date();
                dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            } else if (/\d{2}\.\s\d{1,2}\.\s\d{1,2}/.test(pLine)) {
                const d = pLine.split('.').map(s => s.trim());
                dateStr = `20${d[0]}-${d[1].padStart(2, '0')}-${d[2].padStart(2, '0')}`;
            }

            if (j >= 4 && !pLine.includes('ì¹´ë“œ') && !pLine.includes(':') && !pLine.includes('.') && pLine !== 'ì˜¤ëŠ˜' && pLine !== 'ì¼ì‹œë¶ˆ' && !pLine.includes('í˜ì´')) {
                store = pLine;
            }
          }

          for (const [cat, list] of Object.entries(keywords)) {
            if (list.some(k => store.includes(k))) { category = cat; break; }
          }

          newItems.push({
            id: Date.now() + Math.random(),
            fullDate: dateStr,
            store, amount, category, cardName,
            split: { me: amount, mom: 0, dad: 0, bro: 0 }
          });
        }
      });

      if (newItems.length > 0) {
        state.data.transactions = [...state.data.transactions, ...newItems];
        saveData(); document.getElementById('rawInput').value = ''; render();
        alert(`${newItems.length}ê°œì˜ ë‚´ì—­ì„ ì •í™•íˆ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
      }
    }

    function render() {
      document.getElementById('periodDisplay').textContent = state.view === 'monthly' ? `${state.year}ë…„ ${state.month}ì›”` : `${state.year}ë…„`;
      let filtered = state.data.transactions.filter(t => {
        const d = new Date(t.fullDate);
        return d.getFullYear() === state.year && (state.view === 'yearly' || (d.getMonth()+1) === state.month);
      });

      let stats = { total: 0, family: 0, gc: 0, myShare: 0 };
      let catSums = { food: 0, transport: 0, shopping: 0, living: 0, medical: 0, etc: 0, giftcard: 0 };

      filtered.forEach(t => {
        stats.total += t.amount;
        if (t.category === 'giftcard') stats.gc += t.amount;
        stats.family += (t.split?.mom || 0) + (t.split?.dad || 0) + (t.split?.bro || 0);
        stats.myShare += (t.split?.me || 0);
        catSums[t.category] += t.amount;
      });

      const actualNet = stats.total + (stats.myShare - stats.total) - stats.gc;

      document.getElementById('stat-total').textContent = stats.total.toLocaleString() + 'ì›';
      document.getElementById('stat-my').textContent = actualNet.toLocaleString() + 'ì›';
      document.getElementById('stat-family').textContent = stats.family.toLocaleString() + 'ì›';
      document.getElementById('stat-gc').textContent = stats.gc.toLocaleString() + 'ì›';

      updateChart(catSums);

      if (state.filterCategory) {
          document.getElementById('filterTagContainer').style.display = 'block';
          document.getElementById('filterTagName').textContent = CAT_MAP[state.filterCategory];
      } else { document.getElementById('filterTagContainer').style.display = 'none'; }

      let displayData = state.filterCategory ? filtered.filter(t => t.category === state.filterCategory) : filtered;
      const listArea = document.getElementById('listArea');
      listArea.innerHTML = displayData.sort((a,b) => new Date(b.fullDate)-new Date(a.fullDate)).map(t => `
        <div class="transaction-item" onclick="openSettlement(${t.id})">
          <div>
            <div style="font-size:10px; color:#9CA3AF; margin-bottom:4px;">${t.fullDate} | ${t.cardName}</div>
            <span class="tag tag-${t.category}">${CAT_MAP[t.category]}</span>
            <span style="font-weight:700;">${t.store}</span>
          </div>
          <div style="text-align:right">
            <div style="font-weight:800;">${t.amount.toLocaleString()}ì›</div>
          </div>
        </div>
      `).join('') || '<div style="text-align:center; padding:50px; color:#9CA3AF;">ë‚´ì—­ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>';
    }

    function updateChart(sums) {
      const ctx = document.getElementById('categoryChart').getContext('2d');
      const entries = Object.entries(sums).filter(e => e[1] > 0);
      if (state.chart) state.chart.destroy();
      state.chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: entries.map(e => CAT_MAP[e[0]]),
          datasets: [{ data: entries.map(e => e[1]), backgroundColor: entries.map(e => CAT_COLORS[e[0]]), borderWidth: 0 }]
        },
        options: { plugins: { legend: { display: false } }, cutout: '75%', onClick: (evt, el) => { if(el[0]) { state.filterCategory = entries[el[0].index][0]; render(); } } }
      });
      const total = entries.reduce((a,b) => a+b[1], 0);
      document.getElementById('chartLegend').innerHTML = entries.map(([key, val]) => `
        <div class="legend-item" onclick="state.filterCategory='${key}'; render();">
          <span><span style="color:${CAT_COLORS[key]}">â—</span> ${CAT_MAP[key]}</span>
          <span><b>${((val/total)*100).toFixed(0)}%</b></span>
        </div>
      `).join('');
    }

    function openSettlement(id) {
      const t = state.data.transactions.find(x => x.id === id);
      state.currentId = id;
      document.getElementById('splitTotalDisplay').textContent = `${t.store} - ${t.amount.toLocaleString()}ì›`;
      const select = document.getElementById('editCategory');
      select.innerHTML = Object.entries(CAT_MAP).map(([k,v]) => `<option value="${k}" ${t.category===k?'selected':''}>${v}</option>`).join('');
      if(t.category === 'giftcard') {
          document.getElementById('gc-cashback').value = t.gcInfo?.cashback || '';
          document.getElementById('gc-fee').value = t.gcInfo?.fee || '';
          document.getElementById('gc-benefit').value = t.gcInfo?.benefit || '';
          document.getElementById('gc-mileage').value = t.gcInfo?.mileage || '';
          runGcCalc();
      }
      toggleGcSection();
      const members = { me: 'ë‚˜', mom: 'ì—„ë§ˆ', dad: 'ì•„ë¹ ', bro: 'ë™ìƒ' };
      document.getElementById('splitList').innerHTML = Object.entries(members).map(([key, name]) => `
        <div class="split-row">
          <span>${name}</span>
          <input type="number" class="split-input" id="split-${key}" value="${t.split?.[key] || (key==='me'?t.amount:0)}" oninput="validateSplit(${t.amount})">
        </div>
      `).join('');
      validateSplit(t.amount);
      document.getElementById('splitModal').classList.add('active');
    }

    function runGcCalc() {
      const t = state.data.transactions.find(x => x.id === state.currentId);
      const buy = t.amount;
      const cb = parseInt(document.getElementById('gc-cashback').value) || 0;
      const fee = parseInt(document.getElementById('gc-fee').value) || 0;
      const bn = parseInt(document.getElementById('gc-benefit').value) || 0;
      const ml = parseInt(document.getElementById('gc-mileage').value) || 0;
      const net = buy - cb + fee - bn;
      const price = ml > 0 ? (net / ml).toFixed(2) : 0;
      document.getElementById('mile-result').innerHTML = `ì‹¤ì§ˆ ë¹„ìš©: <b>${net.toLocaleString()}ì›</b> | ë§ˆì¼ ë‹¨ê°€: <b style="color:var(--primary)">${price}ì›</b>`;
    }

    function toggleGcSection() { document.getElementById('gc-calc-section').style.display = document.getElementById('editCategory').value === 'giftcard' ? 'block' : 'none'; }
    function saveSettlement() {
      const t = state.data.transactions.find(x => x.id === state.currentId);
      t.category = document.getElementById('editCategory').value;
      t.split = { me: parseInt(document.getElementById('split-me').value)||0, mom: parseInt(document.getElementById('split-mom').value)||0, dad: parseInt(document.getElementById('split-dad').value)||0, bro: parseInt(document.getElementById('split-bro').value)||0 };
      if(t.category === 'giftcard') {
          t.gcInfo = { cashback: parseInt(document.getElementById('gc-cashback').value)||0, fee: parseInt(document.getElementById('gc-fee').value)||0, benefit: parseInt(document.getElementById('gc-benefit').value)||0, mileage: parseInt(document.getElementById('gc-mileage').value)||0 };
      }
      saveData(); closeModal('splitModal'); render();
    }
    function validateSplit(total) {
      const sum = Array.from(document.querySelectorAll('.split-input')).reduce((a, b) => a + (parseInt(b.value) || 0), 0);
      const diff = total - sum;
      const v = document.getElementById('splitValidate');
      v.textContent = diff === 0 ? "âœ“ ê¸ˆì•¡ ì¼ì¹˜" : `ë¯¸ë°°ë¶„: ${diff.toLocaleString()}ì›`;
      v.style.color = diff === 0 ? "var(--success)" : "var(--danger)";
      document.getElementById('saveSplitBtn').disabled = diff !== 0;
    }
    function clearFilter() { state.filterCategory = null; render(); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function deleteItem() { if(confirm("ë‚´ì—­ì„ ì‚­ì œí• ê¹Œìš”?")) { state.data.transactions = state.data.transactions.filter(x => x.id !== state.currentId); saveData(); closeModal('splitModal'); render(); } }
    
    render();
  </script>
</body>
</html>
